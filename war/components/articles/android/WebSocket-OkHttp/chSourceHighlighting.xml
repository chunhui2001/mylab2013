<?xml version="1.0" encoding="utf-8"?>
<c:component type="chSourceHighlighting" componentId="chSourceHighlighting_1" xmlns:c="http://com.snnmo.website">
  <c:abstract>
    <![CDATA[
https://icon-sets.iconify.design/ic/info/ (Android 图标库) <br />
https://inloop.github.io/svg2android (在线转换将 svg 转换成 Android Drawable)
]]>
  </c:abstract>


  <c:entry style="margin-top:1em;color:rgb(175, 0, 190);font-size:2.2em;">
    <c:title></c:title>
    <c:desc>
      <c:desc1> <![CDATA[
      ]]></c:desc1>
    </c:desc>
    <c:sourceContent type="" title="Makefile" id="sourceContent1" 
                     style="background-color:white;"
                     titleStyle="padding:.5em 0em 0em 0em;margin-top:1em;"
                     bodyStyle="background-color:white;padding:0;font-size:1.2em;line-height:1.3;font-family:monospace;">
                     <![CDATA[
### 当前 Makefile 文件物理路径
ROOT_DIR:=$(shell dirname $(realpath $(firstword $(MAKEFILE_LIST))))

build:
  ./gradlew build -x test

tasks:
  ./gradlew tasks

install:
  ./gradlew installDebug
  ]]>
    </c:sourceContent>

    <c:sourceContent type="" title="settings.gradle.kts" id="sourceContent1" 
                     style="background-color:white;margin-top:1em;"
                     titleStyle="padding:.5em 0em 0em 0em;margin-top:1em;"
                     bodyStyle="background-color:white;padding:0;font-size:1.2em;line-height:1.3;font-family:monospace;">
                     <![CDATA[
# ./settings.gradle.kts
dependencyResolutionManagement {
    repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS)
    repositories {
        google()
        mavenCentral()
+        maven { url=uri("https://jitpack.io") }
    }
}
  ]]>
    </c:sourceContent>

    <c:sourceContent type="" title="build.gradle.kts" id="sourceContent1" 
                     style="background-color:white;margin-top:1em;"
                     titleStyle="padding:.5em 0em 0em 0em;margin-top:1em;"
                     bodyStyle="background-color:white;padding:0;font-size:1.2em;line-height:1.3;font-family:monospace;">
                     <![CDATA[
# ./app/build.gradle.kts
plugins {
    id("com.android.application")
    id("org.jetbrains.kotlin.android")
+    id("kotlin-kapt")
}

android {

    ....

+   buildFeatures {
+       viewBinding = true
+   }
}

dependencies {

    implementation("androidx.core:core-ktx:1.12.0")
    implementation("androidx.appcompat:appcompat:1.6.1")
    implementation("com.google.android.material:material:1.11.0")
    implementation("androidx.constraintlayout:constraintlayout:2.1.4")
+
+    implementation("androidx.lifecycle:lifecycle-extensions:2.2.0")
+    implementation("androidx.recyclerview:recyclerview:1.3.2")
+    implementation("androidx.room:room-runtime:2.6.1")
+
+    implementation("com.github.ismaeldivita:chip-navigation-bar:1.4.0")
+    implementation("com.github.bumptech.glide:glide:4.16.0")
+    implementation("com.squareup.okhttp3:okhttp:3.12.0")
+
+    kapt("androidx.room:room-compiler:2.6.1")
}
  ]]>
    </c:sourceContent>

    <c:comment>
      <c:comment1>
        <![CDATA[]]>
      </c:comment1>
    </c:comment>
  </c:entry>


  <c:entry style="margin-top:1em;color:rgb(175, 0, 190);font-size:2.2em;">
    <c:title>配置网络权限</c:title>
    <c:desc>
      <c:desc1> <![CDATA[
      ]]></c:desc1>
    </c:desc>
    <c:sourceContent type="" title="AndroidManifest.xml" id="sourceContent1" 
                     style="background-color:white;"
                     titleStyle="padding:.5em 0em 0em 0em;margin-top:0em;"
                     bodyStyle="background-color:white;padding:0;font-size:1.2em;line-height:1.3;font-family:monospace;">
                     <![CDATA[
<?xml version="1.0" encoding="utf-8"?>
<manifest
    xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:tools="http://schemas.android.com/tools">

+    <uses-permission android:name="android.permission.INTERNET" />

    <application
        android:allowBackup="true"
        android:dataExtractionRules="@xml/data_extraction_rules"
        android:fullBackupContent="@xml/backup_rules"
        android:icon="@mipmap/ic_launcher"
        android:label="@string/app_name"
        android:roundIcon="@mipmap/ic_launcher_round"
        android:supportsRtl="true"
        android:theme="@style/Theme.WebSocketOkHttp"
        tools:targetApi="31"
+        android:usesCleartextTraffic="true"
        >
        <activity
            android:name=".MainActivity"
            android:exported="true">
            <intent-filter>
                <action android:name="android.intent.action.MAIN" />

                <category android:name="android.intent.category.LAUNCHER" />
            </intent-filter>
        </activity>
    </application>

</manifest>
  ]]>
    </c:sourceContent>

    <c:comment>
      <c:comment1>
        <![CDATA[]]>
      </c:comment1>
    </c:comment>
  </c:entry>

  <c:entry style="margin-top:1em;color:rgb(175, 0, 190);font-size:2.2em;">
    <c:title>MainActivity</c:title>
    <c:desc>
      <c:desc1> <![CDATA[
      ]]></c:desc1>
    </c:desc>
    <c:sourceContent type="" title="activity_main.xml" id="sourceContent1" 
                     style="background-color:white;"
                     titleStyle="padding:.5em 0em 0em 0em;margin-top:0em;"
                     bodyStyle="background-color:white;padding:0;font-size:1.2em;line-height:1.3;font-family:monospace;">
                     <![CDATA[
# app/src/main/res/layout/activity_main.xml
<?xml version="1.0" encoding="utf-8"?>
<RelativeLayout 
    xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:tools="http://schemas.android.com/tools"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    tools:context=".MainActivity">

    <Button
        android:id="@+id/startBtn"
        android:layout_width="wrap_content"
        android:layout_height="wrap_content"
        android:layout_centerHorizontal="true"
        android:layout_marginTop="40dp"
        android:textSize="20sp"
        android:text="Start!"/>

    <TextView
        android:id="@+id/outputTxt"
        android:layout_width="wrap_content"
        android:maxWidth="300dp"
        android:layout_height="wrap_content"
        android:layout_below="@id/startBtn"
        android:layout_centerHorizontal="true"
        android:layout_marginTop="30dp"
        android:lineHeight="26dp"
        android:textSize="16sp"
        tools:text="Text" />

</RelativeLayout>
  ]]>
    </c:sourceContent>
    <c:sourceContent type="" title="MainActivity.kt" id="sourceContent1" 
                     style="background-color:white;"
                     titleStyle="padding:.5em 0em 0em 0em;margin-top:1em;"
                     bodyStyle="background-color:white;padding:0;font-size:1.2em;line-height:1.3;font-family:monospace;">
                     <![CDATA[
# app/src/main/java/com/android_labs/websocketokhttp/MainActivity.kt
private const val INTERNET_PERMISSION_CODE = 1
private const val TAG = "com.android_labs.websocketokhttp.MainActivity"

class MainActivity : AppCompatActivity() {

    private lateinit var startBtn: Button
    private lateinit var outputTxt: TextView

    private lateinit var okhttp: OkHttpClient

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_main)

        this.startBtn = findViewById(R.id.startBtn)
        this.outputTxt = findViewById(R.id.outputTxt)

        this.okhttp = OkHttpClient()

        this.startBtn.isEnabled = hasPermission(Manifest.permission.INTERNET)

        this.startBtn.setOnClickListener {

            startWebSocket()
        }

        if (!this.startBtn.isEnabled) {
            requestPermission(Manifest.permission.INTERNET, INTERNET_PERMISSION_CODE)
        }
    }

    private fun hasPermission(permission: String): Boolean {
        return ContextCompat.checkSelfPermission(this@MainActivity, permission) != PackageManager.PERMISSION_GRANTED
    }

    private fun requestPermission(permission: String, requestCode: Int) {
        ActivityCompat.requestPermissions(this@MainActivity, arrayOf(permission), requestCode)
    }

    override fun onRequestPermissionsResult(
        requestCode: Int,
        permissions: Array<out String>,
        grantResults: IntArray
    ) {
        super.onRequestPermissionsResult(requestCode, permissions, grantResults)

        if (requestCode == INTERNET_PERMISSION_CODE) {
            if (grantResults.isNotEmpty() && grantResults[0] == PackageManager.PERMISSION_GRANTED) {
                this.startBtn.isEnabled = true
            }
        }
    }

    private fun startWebSocket() {
        val url = "ws://echo.websocket.org"
        val request = Request.Builder().url(url).build()

        this.okhttp.newWebSocket(request, EchoWebSocketListener())
        this.okhttp.dispatcher().executorService().shutdown()
    }

    inner class EchoWebSocketListener() : WebSocketListener() {

        private val NORMAL_CLOSURE_STATUS = 1000

        override fun onFailure(webSocket: WebSocket, t: Throwable, response: Response?) {
            output("Error: " + t.message)
            Log.e(TAG, "Error: " + t.message)
        }

        override fun onOpen(webSocket: WebSocket, response: Response) {
            webSocket.send("Hello, it's Laurel!")
            webSocket.send("What's up?")
            // webSocket.send(ByteString.decodeHex("Try it!"))
            webSocket.close(NORMAL_CLOSURE_STATUS, "Good bye!")
        }

        override fun onMessage(webSocket: WebSocket, bytes: ByteString) {
            output("Receiving Bytes: " + bytes.hex())
        }

        override fun onMessage(webSocket: WebSocket, text: String) {
            output("Receiving Text: $text")
        }

        override fun onClosing(webSocket: WebSocket, code: Int, reason: String) {
            webSocket.close(NORMAL_CLOSURE_STATUS, null)
            output("Closing: $code/$reason")
        }

        override fun onClosed(webSocket: WebSocket, code: Int, reason: String) {
            // webSocket.close(NORMAL_CLOSURE_STATUS, null)
            output("Closed: $code/$reason")
        }

        private fun output(s: String) {
            runOnUiThread {
                val color = ContextCompat.getColor(this@MainActivity, R.color.primary)
                val hexColor: String = String.format("#%06X", color)
                val text = SpannableString(outputTxt.text.toString() + "\r\n" + s ?: "")
                val span = ForegroundColorSpan(Color.parseColor(hexColor));
                
                text.setSpan(span,0,text.length, Spannable.SPAN_INCLUSIVE_INCLUSIVE)

                outputTxt.text = text
            }
        }
    }
}
  ]]>
    </c:sourceContent>

    <c:comment>
      <c:comment1>
        <![CDATA[]]>
      </c:comment1>
    </c:comment>
  </c:entry>


</c:component>
