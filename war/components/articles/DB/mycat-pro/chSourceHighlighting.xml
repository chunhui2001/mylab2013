<?xml version="1.0" encoding="utf-8"?>
<c:component type="chSourceHighlighting" componentId="chSourceHighlighting_1" xmlns:c="http://com.snnmo.website">
  <c:abstract>
    <![CDATA[
<div>
在MySQL中间件出现之前，对于MySQL主从集群，如果要实现其读写分离，一般是在程序端实现，这样就带来一个问题，即数据库和程序的耦合度太高，如果我数据库的地址发生改变了，那么我程序端也要进行相应的修改，如果数据库不小心挂掉了，则同时也意味着程序的不可用，而这对很多应用来说，并不能接受。
</div>
<div style="margin-top:.625em;">
引入MySQL中间件能很好的对程序端和数据库进行解耦，这样，程序端只需关注数据库中间件的地址，而无需知晓底层数据库是如何提供服务。
</div>
<div style="margin-top:.625em;">
作为当前炙手可热的MySQL中间件，MyCAT实现MySQL主从集群的读写分离自是应有之义，其配置也相当简单。
</div>
<div style="margin-top:.625em;">
在这里，我用三个实例组成MySQL主从集群，来验证MyCAT的读写分离功能，其实，一主一从就可以满足，之所以用三个，是为了验证MyCAT的分片功能。
</div>
]]>
  </c:abstract>

  <c:entry style="margin-top:1em;color:rgb(175, 0, 190);font-size:2em;">
    <c:title>集群组成如下：</c:title>
    <c:desc>
      <c:desc1> <![CDATA[]]></c:desc1>
    </c:desc>
    <c:sourceContent type="" title="" id="sourceContent1"
                     titleStyle="padding-left:0;color:black;font-size:1.8em;background-color:white;"
                     bodyStyle="padding:0;font-size:1.2em;line-height:1.3;font-family:monospace;">
      <![CDATA[
角色             主机名                  主机IP
master          mysql-server1          192.168.244.145
slave           mysql-server2          192.168.244.146
slave           mysql-server3          192.168.244.144
    ]]>
    </c:sourceContent>
    <c:sourceContent type="html" title="" id="sourceContent1"
                     titleStyle="padding-left:0;color:black;font-size:1.8em;background-color:white;"
                     bodyStyle="padding:0;font-size:1em;line-height:1.125;font-family:monospace;margin-top:1.125em;">
      <![CDATA[
<div>
在这里，还是使用 Travelrecord 表进行测试。
</div>
<div style="margin-top:.625em;">
首先编辑 MyCAT 的配置文件 schema.xml，关于 dataHost 的配置信息如下：
</div>
    ]]>
    </c:sourceContent>
    <c:sourceContent type="" title="" id="sourceContent1"
                     titleStyle="padding-left:0;color:black;font-size:1.8em;background-color:white;"
                     bodyStyle="padding:0;font-size:1em;line-height:1.125;font-family:monospace;margin-top:1.125em;">
      <![CDATA[
<dataHost name="localhost1" maxCon="1000" minCon="10" 
          balance="1" writeType="0" dbType="mysql" dbDriver="native" switchType="-1"  slaveThreshold="100">
  <heartbeat>select user()</heartbeat>
  <!-- can have multi write hosts -->
  <writeHost host="hostM1" url="localhost:3306" user="root" password="123456"></writeHost>
  <writeHost host="hostS1" url="192.168.244.146:3306" user="root" password="123456" />
  <writeHost host="hostS2" url="192.168.244.144:3306" user="root" password="123456" />
</dataHost>
    ]]>
    </c:sourceContent>
    <c:sourceContent type="html" title="" id="sourceContent1"
                     titleStyle="padding-left:0;color:black;font-size:1.8em;background-color:white;"
                     bodyStyle="padding:0;font-size:1em;line-height:1.225em;font-family:monospace;margin-top:1.125em;">
      <![CDATA[
<div>
这里面，有两个参数需要注意，balance和 switchType。
</div>
<div style="margin-top:1.625em;">
<b>其中，balance指的负载均衡类型，目前的取值有4种：</b>
</div>
<div style="margin-top:.625em;">
1. balance="0", 不开启读写分离机制，所有读操作都发送到当前可用的writeHost上。
</div>
<div style="margin-top:.625em;">
2. balance="1"，全部的readHost与stand by writeHost参与select语句的负载均衡，简单的说，当双主双从模式(M1->S1，M2->S2，并且M1与 M2互为主备)，正常情况下，M2,S1,S2都参与select语句的负载均衡。
</div>
<div style="margin-top:.625em;">
3. balance="2"，所有读操作都随机的在writeHost、readhost上分发。
</div>
<div style="margin-top:.625em;">
4. balance="3"，所有读请求随机的分发到wiriterHost对应的readhost执行，writerHost不负担读压力
</div>
<div style="margin-top:1.625em;">
<b>switchType 指的是切换的模式，目前的取值也有4种：</b>
</div>
<div style="margin-top:.625em;">
1. switchType='-1' 表示不自动切换
</div>
<div style="margin-top:.625em;">
2. switchType='1' 默认值，表示自动切换
</div>
<div style="margin-top:.625em;">
3. switchType='2' 基于MySQL主从同步的状态决定是否切换,心跳语句为 show slave status
</div>
<div style="margin-top:.625em;">
4. switchType='3'基于MySQL galary cluster的切换机制（适合集群）（1.4.1），心跳语句为 show status like 'wsrep%'。
</div>
<div style="margin-top:.625em;line-height:1.625em;">
因此，该配置文件中的balance="1"意味着作为stand by writeHost的hostS1和hostS2将参与select语句的负载均衡，这就实现了主从的读写分离，switchType='-1'意味着当主挂掉的时候，不进行自动切换，即hostS1和hostS2并不会被提升为主，仍只提供读的功能。这就避免了将数据写进slave的可能性，毕竟，单纯的MySQL主从集群并不允许将数据读进slave中，除非配置的是双master。
</div>
    ]]>
    </c:sourceContent>
    <c:comment>
      <c:comment1>
        <![CDATA[]]>
      </c:comment1>
    </c:comment>
  </c:entry>



  <c:entry style="margin-top:1em;color:rgb(175, 0, 190);font-size:2em;">
    <c:title>验证读写分离</c:title>
    <c:desc>
      <c:desc1> <![CDATA[]]></c:desc1>
    </c:desc>
    <c:sourceContent type="" title="创建Travelrecord表" id="sourceContent1"
                     titleStyle="padding-left:0;color:black;font-size:1.3em;background-color:white;"
                     bodyStyle="padding:0;font-size:1.2em;line-height:1.3;font-family:monospace;">
      <![CDATA[
create table travelrecord (id bigint not null primary key,user_id varchar(100),traveldate DATE, fee decimal,days int);
    ]]>
    </c:sourceContent>
    <c:sourceContent type="" title="插入数据" id="sourceContent1"
                     titleStyle="padding-left:0;color:black;font-size:1.3em;background-color:white;margin-top:1em;"
                     bodyStyle="padding:0;font-size:1em;line-height:1.125;font-family:monospace;">
      <![CDATA[
mysql> insert into travelrecord(id,user_id,traveldate,fee,days)  values(1,@@hostname,20160101,100,10);
Query OK, 1 row affected, 1 warning (0.02 sec)

mysql> insert into travelrecord(id,user_id,traveldate,fee,days)  values(5000001,@@hostname,20160102,100,10);
Query OK, 1 row affected, 1 warning (0.01 sec)
    ]]>
    </c:sourceContent>
    <c:sourceContent type="html" title="" id="sourceContent1"
                     titleStyle="padding-left:0;color:black;font-size:1.3em;background-color:white;"
                     bodyStyle="padding:0;font-size:1em;line-height:1.625em;font-family:monospace;margin-top:1em;">
      <![CDATA[
在这里，用了一个取巧的方法，即对 user_id 插入了当前实例的主机名，这样可直观的观察读写是否分离以及 MyCAT 的分片功能。能这样做的原因在于我当前的 MySQL版本-5.6.26 默认是基于 statement 的复制，如果是基于 row 的复制，则这个方法将不可取。
    ]]>
    </c:sourceContent>
    <c:sourceContent type="" title="查询数据" id="sourceContent1"
                     titleStyle="padding-left:0;color:black;font-size:1.3em;background-color:white;margin-top:1em;"
                     bodyStyle="padding:0;font-size:1em;line-height:1.125;font-family:monospace;">
      <![CDATA[
mysql> select * from travelrecord;
+---------+---------------+------------+------+------+
| id      | user_id       | traveldate | fee  | days |
+---------+---------------+------------+------+------+
|       1 | mysql-server2 | 2016-01-01 |  100 |   10 |
| 5000001 | mysql-server3 | 2016-01-02 |  100 |   10 |
+---------+---------------+------------+------+------+
2 rows in set (0.01 sec)

mysql> select * from travelrecord;
+---------+---------------+------------+------+------+
| id      | user_id       | traveldate | fee  | days |
+---------+---------------+------------+------+------+
| 5000001 | mysql-server3 | 2016-01-02 |  100 |   10 |
|       1 | mysql-server2 | 2016-01-01 |  100 |   10 |
+---------+---------------+------------+------+------+
2 rows in set (0.02 sec)

mysql> select * from travelrecord;
+---------+---------------+------------+------+------+
| id      | user_id       | traveldate | fee  | days |
+---------+---------------+------------+------+------+
| 5000001 | mysql-server3 | 2016-01-02 |  100 |   10 |
|       1 | mysql-server3 | 2016-01-01 |  100 |   10 |
+---------+---------------+------------+------+------+
2 rows in set (0.01 sec)

mysql> select * from travelrecord;
+---------+---------------+------------+------+------+
| id      | user_id       | traveldate | fee  | days |
+---------+---------------+------------+------+------+
| 5000001 | mysql-server3 | 2016-01-02 |  100 |   10 |
|       1 | mysql-server3 | 2016-01-01 |  100 |   10 |
+---------+---------------+------------+------+------+
2 rows in set (0.01 sec)

mysql> select * from travelrecord;
+---------+---------------+------------+------+------+
| id      | user_id       | traveldate | fee  | days |
+---------+---------------+------------+------+------+
|       1 | mysql-server2 | 2016-01-01 |  100 |   10 |
| 5000001 | mysql-server2 | 2016-01-02 |  100 |   10 |
+---------+---------------+------------+------+------+
    ]]>
    </c:sourceContent>
    <c:sourceContent type="html" title="" id="sourceContent1"
                     titleStyle="padding-left:0;color:black;font-size:1.3em;background-color:white;"
                     bodyStyle="padding:0;font-size:1em;line-height:1.625em;font-family:monospace;margin-top:1em;">
      <![CDATA[
<div>
  从上面的输出结果，可以得出以下两点：
</div>
<div>
一、该配置已实现读写分离，读出来的数据没有master节点的。
</div>
<div>
二、MyCAT的随机分发不是基于statement的，即一个select语句查询其中一个节点，另外一个select语句查询另外一个节点。它分发针对的是片的，同一个select语句的结果是有不同dataNode返回的。
</div>
<div style="margin-top:.6em;">
不仅如此，从MyCAT日志中也可以获取读写分离的相关信息，当然，前提是MyCAT的日志级别是debug。日志相关信息如下：
</div>
    ]]>
    </c:sourceContent>
    <c:sourceContent type="html" title="" id="sourceContent1"
                     titleStyle="padding-left:0;color:black;font-size:1.3em;background-color:white;margin-top:1em;"
                     bodyStyle="padding:0;font-size:1em;line-height:1.125;font-family:monospace;margin-top:.325em;">
      <![CDATA[
<img src="/images/mysql/576154-20160115124145163-263417526.png" />
    ]]>
    </c:sourceContent>
    <c:comment>
      <c:comment1>
        <![CDATA[]]>
      </c:comment1>
    </c:comment>
  </c:entry>




  <c:entry style="margin-top:1em;color:rgb(175, 0, 190);font-size:2em;">
    <c:title>验证mater挂了，slave还能提供读的功能</c:title>
    <c:desc>
      <c:desc1> <![CDATA[]]></c:desc1>
    </c:desc>
    <c:sourceContent type="" title="" id="sourceContent1"
                     titleStyle="padding-left:0;color:black;font-size:1.3em;background-color:white;"
                     bodyStyle="padding:0;font-size:1.2em;line-height:1.3;font-family:monospace;">
      <![CDATA[
### 对于 MySQL 主从集群，我们的需求是 master 挂了，slave 还能提供读的功能。人为的关闭主库: 
[root@mysql-server1 ~]# /etc/init.d/mysqld stop
### 登录 MyCAT
[root@mysql-server1 ~]# mysql -utest -ptest -h127.0.0.1 -P8066 -DTESTDB
    ]]>
    </c:sourceContent>
    <c:sourceContent type="" title="插入数据" id="sourceContent1"
                     titleStyle="padding-left:0;color:black;font-size:1.3em;background-color:white;margin-top:1em;"
                     bodyStyle="padding:0;font-size:1em;line-height:1.125;font-family:monospace;">
      <![CDATA[
mysql> insert into travelrecord(id,user_id,traveldate,fee,days)  values(10000001,@@hostname,20160103,100,10);
ERROR 1184 (HY000): Connection refused
mysql> select * from travelrecord;
+---------+---------------+------------+------+------+
| id      | user_id       | traveldate | fee  | days |
+---------+---------------+------------+------+------+
|       1 | mysql-server2 | 2016-01-01 |  100 |   10 |
| 5000001 | mysql-server3 | 2016-01-02 |  100 |   10 |
+---------+---------------+------------+------+------+
2 rows in set (0.02 sec)
    ]]>
    </c:sourceContent>
    <c:sourceContent type="html" title="" id="sourceContent1"
                     titleStyle="padding-left:0;color:black;font-size:1.3em;background-color:white;"
                     bodyStyle="padding:0;font-size:1em;line-height:1.625em;font-family:monospace;margin-top:1em;">
      <![CDATA[
<div>
可见无法插入数据，但不影响读取数据。
</div>
<div style="margin-top:.6em;">
至此，MyCAT实现MySQL的读写分离部署测试完毕。
</div>
    ]]>
    </c:sourceContent>
    <c:comment>
      <c:comment1>
        <![CDATA[]]>
      </c:comment1>
    </c:comment>
  </c:entry>


</c:component>
