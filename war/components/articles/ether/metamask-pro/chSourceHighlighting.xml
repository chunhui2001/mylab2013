<?xml version="1.0" encoding="utf-8"?>
<c:component type="chSourceHighlighting" componentId="chSourceHighlighting_1" xmlns:c="http://com.snnmo.website">
  <c:abstract style="font-size:1em;line-height:1.6em;">
    <![CDATA[
<div style="margin-bottom:1em;">
metamask 源码分析系列文章，基于 7.4.0 版本
</div>
<div style="margin-bottom:1em;">
<h1>GitHub: <a href="https://github.com/MetaMask/metamask-extension">https://github.com/MetaMask/metamask-extension</a></h1>
</div>
<ul style="margin-top:.325em;list-style: disc;margin-left: 1.5em;">
  <li style="margin: .325em 0;">
    <p><a href="#materials" style="color:firebrick;text-decoration: underline;">参考资料</a></p>
    <ul style="margin-top:.325em;list-style: disc;margin-left: 1.5em;">
      <li><a href="#chrome-extension-development" style="color:firebrick;text-decoration: underline;">Chrome Extension Development</a></li>
      <li>Stream</li>
    </ul>
  </li>
  <li style="margin: .325em 0;"><p><a href="#metamask-structrues" style="color:firebrick;text-decoration: underline;">metamask 架构</a></p></li>
  <li style="margin: .325em 0;"><p><a href="#metamask-developer" style="color:firebrick;text-decoration: underline;">metamask 开发</a></p></li>
  <li>
    <p><a href="#metamask-dependencies" style="color:firebrick;text-decoration: underline;">metamask 依赖分析</a></p>
    <ul style="margin-top:.325em;list-style: disc;margin-left: 1.5em;">
      <li><a href="#3box" style="color:firebrick;text-decoration: underline;">3box</a></li>
      <li><a href="#eth-block-tracker" style="color:firebrick;text-decoration: underline;">eth-block-tracker</a></li>
      <li><a href="#json-rpc-engine" style="color:firebrick;text-decoration: underline;">json-rpc-engine</a></li>
      <li><a href="#json-rpc-middleware-stream" style="color:firebrick;text-decoration: underline;">json-rpc-middleware-stream</a></li>
      <li><a href="#metamask-inpage-provider" style="color:firebrick;text-decoration: underline;">metamask-inpage-provider</a></li>
      <li><a href="#nonce-tracker" style="color:firebrick;text-decoration: underline;">nonce-tracker</a></li>
      <li><a href="#obs-store" style="color:firebrick;text-decoration: underline;">obs-store</a></li>
      <li><a href="#post-message-stream" style="color:firebrick;text-decoration: underline;">post-message-stream</a></li>
    </ul>
  </li>
  <li style="margin: .325em 0;">
    <p>metamask 目录</p>
    <ul style="margin-top:.325em;list-style: disc;margin-left: 1.5em;">
      <li>
        <p>UI</p>
        <ul style="margin-top:.325em;list-style: disc;margin-left: 1.5em;">
          <li>MetaMask UI 编写规则</li>
          <li>ui/index.js</li>
        </ul>
      </li>
      <li>
        <p>app</p>
        <ul style="margin-top:.325em;list-style: disc;margin-left: 1.5em;">
          <li>app/scripts/account-import-strategies/index.js</li>
          <li>app/scripts/controllers/network/createInfuraClient.js</li>
          <li>app/scripts/controllers/network/createJsonRpcClient.js</li>
          <li>app/scripts/controllers/network/createLocalhostClient.js</li>
          <li>app/scripts/controllers/network/createMetamaskMiddleware.js</li>
          <li>app/scripts/controllers/network/network.js</li>
          <li>app/scripts/controllers/transactions
          <li>app/scripts/controllers/transactions/lib/tx-state-history-helper.js</li>
          <li>app/scripts/controllers/transactions/lib/util.js</li>
          <li>app/scripts/controllers/transactions/tx-state-manager.js</li>
          <li>app/scripts/controllers/transactions/pending-tx-tracker.js</li>
          <li>app/scripts/controllers/transactions/tx-gas-utils.js</li>
          <li>app/scripts/controllers/transactions/index.js</li>
          <li>app/scripts/controllers/balance.js</li>
          <li>app/scripts/controllers/cached-balances.js</li>
          <li>app/scripts/controllers/detect-tokens.js</li>
          <li>app/scripts/controllers/incoming-transactions.js</li>
          <li>app/scripts/controllers/preferences.js</li>
          <li>app/scripts/controllers/provider-approval.js</li>
          <li>app/scripts/controllers/recent-blocks.js</li>
          <li>app/scripts/controllers/threebox.js</li>
          <li>app/scripts/controllers/token-rates.js</li>
          <li>app/scripts/lib/ens-ipfs/resolver.js</li>
          <li>app/scripts/lib/ens-ipfs/setup.js</li>
          <li>app/scripts/lib/migrator/index.js</li>
          <li>app/scripts/lib/account-tracker.js</li>
          <li>app/scripts/lib/diagnostics-reporter.js</li>
          <li>app/scripts/lib/message-manager.js</li>
          <li>app/scripts/lib/pending-balance-calculator.js</li>
          <li>app/scripts/lib/personal-message-manager.js</li>
          <li>app/scripts/lib/stream-utils.js</li>
          <li>app/scripts/lib/typed-message-manager.js</li>
          <li>app/scripts/lib/util.js</li>
          <li>app/scripts/background.js</li>
          <li>app/scripts/chromereload.js</li>
          <li>app/scripts/contentscript.js</li>
          <li>app/scripts/createStandardProvider.js</li>
          <li>app/scripts/edge-encryptor.js</li>
          <li>app/scripts/inpage.js</li>
          <li>app/scripts/metamask-controller.js</li>
          <li>app/scripts/ui.js</li>
          <li>app/manifest.json</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>
]]>
  </c:abstract>
  


  <c:entry style="margin-top:1em;">
    <c:title id="materials"><![CDATA[<div style="color:blue;font-size:1.625em;">参考资料</div>]]></c:title>
    <c:desc>
      <c:desc1> <![CDATA[
]]></c:desc1>
    </c:desc>
    <c:sourceContent type="html" title="" id="sourceContent1"
                     titleStyle="padding-left:0;color:green;font-size:1em;background-color:white;font-size:1.2em;"
                     bodyStyle="background-color:white;padding:0;font-size:1.2em;line-height:1.625em;font-family:monospace;">
      <![CDATA[

<div style="margin-top:.425em;">
官方文档：<br />
<a href="https://metamask.github.io/metamask-docs/">https://metamask.github.io/metamask-docs/</a><br />
<a href="https://github.com/MetaMask/metamask-extension/tree/develop/docs">https://github.com/MetaMask/metamask-extension/tree/develop/docs</a><br />
<a href="https://medium.com/metamask">https://medium.com/metamask</a><br />
<a href="https://github.com/MetaMask/faq">https://github.com/MetaMask/faq</a><br />
</div>
<div style="margin-top:.425em;">
未来升级计划<br />
<a href="https://medium.com/metamask/breaking-changes-to-the-metamask-inpage-provider-b4dde069dd0a">https://medium.com/metamask/breaking-changes-to-the-metamask-inpage-provider-b4dde069dd0a</a>
</div>
<div style="margin-top:.425em;">
web3.js 文档<br />
<a href="https://web3js.readthedocs.io/en/v1.2.4/">https://web3js.readthedocs.io/en/v1.2.4/</a>
</div>
<div style="margin-top:.425em;">
conflux web3<br />
<a href="https://github.com/Conflux-Chain/ConfluxWeb">https://github.com/Conflux-Chain/ConfluxWeb</a>
</div>
<div style="margin-top:.425em;">
《Mastering Ethereum》<br />
<a href="https://github.com/ethereumbook/ethereumbook/blob/develop/book.asciidoc">https://github.com/ethereumbook/ethereumbook/blob/develop/book.asciidoc</a><br />
<a href="https://github.com/inoutcode/ethereum_book">https://github.com/inoutcode/ethereum_book</a>
</div>
<div style="margin-top:.425em;">
《Mastering Bitcoin》<br />
<a href="https://wizardforcel.gitbooks.io/masterbitcoin2cn/">https://wizardforcel.gitbooks.io/masterbitcoin2cn/</a>
</div>
<div style="margin-top:.425em;">
EIPs<br />
<a href="https://eips.ethereum.org/all">https://eips.ethereum.org/all</a>
</div>
<div style="margin-top:.425em;">
WebExtensions 开发文档<br />
<a href="https://developer.mozilla.org/zh-CN/docs/Mozilla/Add-ons/WebExtensions">https://developer.mozilla.org/zh-CN/docs/Mozilla/Add-ons/WebExtensions</a>
</div>
<div style="margin-top:.425em;">
其他博客资料<br />
<a href="https://www.cnblogs.com/wanghui-garcia/category/1309162.html">https://www.cnblogs.com/wanghui-garcia/category/1309162.html</a>
</div>
<div style="margin-top:.425em;">
Stream<br />
<a href="https://nodejs.org/api/stream.html">https://nodejs.org/api/stream.html</a><br />
<a href="http://nodejs.cn/api/stream.html">http://nodejs.cn/api/stream.html</a><br />
<a href="https://github.com/jabez128/stream-handbook">https://github.com/jabez128/stream-handbook</a>
</div>
<div style="margin-top:.425em;">
0xcert<br />
<a href="https://github.com/0xcert/framework">https://github.com/0xcert/framework</a>
</div>

   ]]>
    </c:sourceContent>

    <c:comment>
      <c:comment1>
        <![CDATA[]]>
      </c:comment1>
    </c:comment>
  </c:entry>


  <c:entry style="margin-top:1em;">
    <c:title id="chrome-extension-development"><![CDATA[<div style="color:blue;font-size:1.625em;">Chrome Extension Development</div>]]></c:title>
    <c:desc>
      <c:desc1> <![CDATA[
<div style="margin-bottom:.425em;font-size:1.225em;line-height:1.625em;">
官方文档: https://developer.chrome.com/extensions
</div>
]]></c:desc1>
    </c:desc>
    <c:sourceContent type="html" title="" id="sourceContent1"
                     titleStyle="padding-left:0;color:green;font-size:1em;background-color:white;font-size:1.2em;"
                     bodyStyle="background-color:white;padding:0;font-size:1.2em;line-height:1.625em;font-family:monospace;">
      <![CDATA[

<h1 style="padding-bottom:0;">核心模块</h1>
<h2>&#x02713; manifest.json</h2>
<div style="margin-bottom:.425em;">
  Chrome 插件最重要也是必不可少的文件，用来配置所有和插件相关的配置，必须放在根目录。其中，manifest_version、name、version 3个是必不可少的，description 和 icons 是推荐的。
</div>

<h2>&#x02713; content-scripts</h2>
<div style="margin-bottom:.425em;">
Chrome 插件中向页面注入脚本的一种形式（虽然名为script，其实还可以包括css的），借助 content-scripts 我们可以实现通过配置的方式轻松向指定页面注入 JS 和 CSS。
</div>
<div style="margin-bottom:.425em;">
content-scripts 和原始页面共享DOM，但是不共享JS，如要访问页面JS（例如某个JS变量），只能通过 injected js来实现。
</div>

<h2>&#x02713; background</h2>
<div style="margin-bottom:.425em;">
后台（姑且这么翻译吧），是一个常驻的页面，它的生命周期是插件中所有类型页面中最长的，它随着浏览器的打开而打开，随着浏览器的关闭而关闭，所以通常把需要一直运行的、启动就运行的、全局的代码放在 background 里面。
</div>
<div style="margin-bottom:.425em;">
background 的权限非常高，几乎可以调用所有的 Chrome 扩展 API（除了devtools），而且它可以无限制跨域，也就是可以跨域访问任何网站而无需要求对方设置CORS。
</div>
<div style="margin-bottom:.425em;">
配置中，background 可以通过 page 指定一张网页，也可以通过 scripts 直接指定一个JS，Chrome 会自动为这个 JS 生成一个默认的网页。
</div>
<div style="margin-bottom:.425em;">
你可以打开无数个 background.html，但是真正在后台常驻的只有一个，而且这个你永远看不到它的界面，只能调试它的代码。
</div>

<h2>&#x02713; event-pages</h2>
<div style="margin-bottom:.425em;">
鉴于 background 生命周期太长，长时间挂载后台可能会影响性能，所以 Google 又弄一个 event-pages，在配置文件上，它与 background 的唯一区别就是多了一个 persistent 参数：
</div>
<pre style="background-color:darkblue;color:cadetblue;padding:.625em 1em;margin-top:.325em;">
{
    "background":
    {
        "scripts": ["event-page.js"],
        "persistent": false
    },
}
</pre>
<div style="margin-bottom:.425em;margin-top:.425em;">
它的生命周期是：在被需要时加载，在空闲时被关闭，什么叫被需要时呢？比如第一次安装、插件更新、有 content-script 向它发送消息，等等。
</div>

<h2>&#x02713; popup</h2>
<div style="margin-bottom:.425em;">
popup 是点击 browser_action 或者 page_action 图标时打开的一个小窗口网页，焦点离开网页就立即关闭，一般用来做一些临时性的交互。
</div> 
<div>
  <img style="width:550px;" src="/images/ether/1577419133949-035ae8d6-f151-47a5-8f87-d446a8558527.png" />
</div>
<div style="margin-bottom:.425em;">
popup 可以包含任意你想要的 HTML 内容，并且会自适应大小。可以通过 default_popup 字段来指定 popup 页面，也可以调用 setPopup() 方法。
</div>
<div style="margin-bottom:.425em;">
需要特别注意的是，由于单击图标打开 popup，焦点离开又立即关闭，所以 popup 页面的生命周期一般很短，需要长时间运行的代码千万不要写在 popup 里面。
</div>
<div style="margin-bottom:.425em;">
在权限上，它和 background 非常类似，它们之间最大的不同是生命周期的不同，popup 中可以直接通过 chrome.extension.getBackgroundPage() 获取 background 的 window 对象。
</div> 

<h2>&#x02713; injected-script</h2>
<div style="margin-bottom:.425em;">
通过DOM操作的方式向页面注入的一种JS。
</div>
<div style="margin-bottom:.425em;">
content-script 有一个很大的“缺陷”，也就是无法访问页面中的JS，虽然它可以操作DOM，但是DOM却不能调用它，也就是无法在DOM中通过绑定事件的方式调用 content-script 中的代码。
</div>

<h2>&#x02713; homepage_url</h2>
<div>
  <img style="width:auto;" src="/images/ether/1577419123158-3a22fd54-c161-4891-a1fb-f8fe33e9c158.png" />
</div>

<h1 style="padding-bottom:0;">展示形式</h1>
<h2>&#x02713; browserAction(浏览器右上角)</h2>
<div>
  <img style="width:auto;" src="/images/ether/1577419228310-10eb3132-915e-4b38-ae44-2191851cf605.png" />
</div>

<h2>&#x02713; pageAction(地址栏右侧)</h2>
<div>
  只有当某些特定页面打开才显示的图标，它和 browserAction 最大的区别是一个始终都显示，一个只在特定情况才显示，平时置灰。
</div>

<h2>&#x02713; 右键菜单</h2>
<div>
  主要是通过chrome.contextMenusAPI实现。
</div>
<div>
  <img style="width:auto;" src="/images/ether/1577419396349-27ea3297-27db-4838-a3e7-634b45816d79.png" />
</div>

<h2>&#x02713; override(覆盖特定页面)</h2>
<div>
使用 override 页可以将 Chrome 默认的一些特定页面替换掉，改为使用扩展提供的页面。扩展可以替代如下页面：
</div>
<ul style="margin-top:.325em;list-style: disc;margin-left:1.5em;font-size: 1em;line-height: 1.625em;">
  <li>历史记录：从工具菜单上点击历史记录时访问的页面，或者从地址栏直接输入 chrome://history</li>
  <li>新标签页：当创建新标签的时候访问的页面，或者从地址栏直接输入 chrome://newtab</li>
  <li>书签：浏览器的书签，或者直接输入 chrome://bookmarks</li>
</ul>

<h2>&#x02713; devtools(开发者工具)</h2>
<div>
Chrome允许插件在开发者工具(devtools)上动手脚，主要表现在：
</div>
<ul style="margin-top:.325em;list-style: none;font-size: 1em;line-height: 1.625em;">
  <li><b>&#x02ABC; 自定义一个和多个和Elements、Console、Sources等同级别的面板；</li>
  <li><b>&#x02ABC; 自定义侧边栏(sidebar)，目前只能自定义Elements面板的侧边栏；</li>
</ul>
<div>
  <img style="width:auto;" src="/images/ether/1577419557354-f6a8fc7a-0a4f-44d2-a6d1-acdd55ce3f90.png" />
</div>

<h2>&#x02713; option(选项页)</h2>
<div>
所谓 options 页，就是插件的设置页面，有2个入口，一个是右键图标有一个 “选项” 菜单，还有一个在插件管理页面：
</div>
<div>
  <img style="width:auto;" src="/images/ether/1577427044275-68e54dca-fc11-4211-be67-4d6a7c02e93f.png" />
</div>

<h2>&#x02713; omnibox</h2>
<div>
omnibox 是向用户提供搜索建议的一种方式。
</div>
<div>
  <img style="width:auto;" src="/images/ether/1577427106075-c8019fb6-fb7d-4b9f-8113-72f7a7590b97.gif" />
</div>

<h2>&#x02713; 桌面通知</h2>
<div>
Chrome 提供了一个 chrome.notificationsAPI 以便插件推送桌面通知。在后台JS中，无论是使用 chrome.notifications 还是 Notification 都不需要申请权限（HTML5方式需要申请权限），直接使用即可。
</div>
<div>
  <img style="width:auto;" src="/images/ether/1577427162579-e5d32482-e702-4e1f-8df3-1ec03a9d90c7.png" />
</div>

<h2>&#x02713; 消息通信</h2>
<table style="width:100%;font-size: .8em;">
  <thead>
    <tr>
      <th style="border: dashed 1px;padding: 5px 10px;">&nbsp;</th>
      <th style="border: dashed 1px;padding: 5px 10px;">injected-script</th>
      <th style="border: dashed 1px;padding: 5px 10px;">content-script</th>
      <th style="border: dashed 1px;padding: 5px 10px;width: 225px;">popup-js</th>
      <th style="border: dashed 1px;padding: 5px 10px;">background-js</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="border: dashed 1px darkgray;padding: 5px 5px;">injected-script</td>
      <td style="border: dashed 1px darkgray;padding: 5px 5px;">-</td>
      <td style="border: dashed 1px darkgray;padding: 5px 5px;word-break: break-all;">window.postMessage</td>
      <td style="border: dashed 1px darkgray;padding: 5px 5px;">-</td>
      <td style="border: dashed 1px darkgray;padding: 5px 5px;">-</td>
    </tr>
    <tr>
      <td style="border: dashed 1px darkgray;padding: 5px 5px;">content-script</td>
      <td style="border: dashed 1px darkgray;padding: 5px 5px;">window.postMessage</td>
      <td style="border: dashed 1px darkgray;padding: 5px 5px;">-</td>
      <td style="border: dashed 1px darkgray;padding: 5px 5px;word-break: break-all;">chrome.runtime.sendMessage <br /> chrome.runtime.connect</td>
      <td style="border: dashed 1px darkgray;padding: 5px 5px;word-break: break-all;">chrome.runtime.sendMessage <br /> chrome.runtime.connect</td>
    </tr>
    <tr>
      <td style="border: dashed 1px darkgray;padding: 5px 5px;">popup-js</td>
      <td style="border: dashed 1px darkgray;padding: 5px 5px;">-</td>
      <td style="border: dashed 1px darkgray;padding: 5px 5px;word-break: break-all;">chrome.tabs.sendMessage <br /> chrome.tabs.connect</td>
      <td style="border: dashed 1px darkgray;padding: 5px 5px;">-</td>
      <td style="border: dashed 1px darkgray;padding: 5px 5px;word-break: break-all;">chrome.extension.getBackgroundPage()</td>
    </tr>
    <tr>
      <td style="border: dashed 1px darkgray;padding: 5px 5px;">background-js</td>
      <td style="border: dashed 1px darkgray;padding: 5px 5px;">-</td>
      <td style="border: dashed 1px darkgray;padding: 5px 5px;word-break: break-all;">chrome.tabs.sendMessage chrome.tabs.connect</td>
      <td style="border: dashed 1px darkgray;padding: 5px 5px;">chrome.extension.getViews</td>
      <td style="border: dashed 1px darkgray;padding: 5px 5px;word-break: break-all;">-</td>
    </tr>
    <tr>
      <td style="border: dashed 1px darkgray;padding: 5px 5px;">devtools-js</td>
      <td style="border: dashed 1px darkgray;padding: 5px 5px;">chrome.devtools. inspectedWindow.eval</td>
      <td style="border: dashed 1px darkgray;padding: 5px 5px;word-break: break-all;">-</td>
      <td style="border: dashed 1px darkgray;padding: 5px 5px;">chrome.runtime.sendMessage</td>
      <td style="border: dashed 1px darkgray;padding: 5px 5px;word-break: break-all;">chrome.runtime.sendMessage</td>
    </tr>
  </tbody>
</table>
<div>
  <img style="width:auto;" src="/images/ether/1577432410206-e7d22a9c-1c60-4a95-bd0f-84a9a598e978.png" />
</div>
<div>
Chrome插件中有2种通信方式，一个是短连接（chrome.tabs.sendMessage和chrome.runtime.sendMessage），一个是长连接（chrome.tabs.connect和chrome.runtime.connect）。
</div>
<div style="margin-top:.625em;">
短连接的话就是挤牙膏一样，我发送一下，你收到了再回复一下，如果对方不回复，你只能重新发，而长连接类似WebSocket会一直建立连接，双方可以随时互发消息。
</div>

<h1 style="padding-bottom:0;">content script与 background 的通信</h1>
<h2>&#x02713; content-script 向 background 发送消息</h2>
<pre style="background-color:darkblue;color:cadetblue;padding:.625em 1em;margin-top:.325em;">
// 在 content-script 端：
chrome.runtime.sendMessege(
    message,
    function(response) {…}
)
</pre>
<pre style="background-color:darkblue;color:cadetblue;padding:.625em 1em;margin-top:.325em;">
// 在 background 端：
chrome.runtime.onMessege.addListener(
    // request 发来的消息
    // sendResponse 一个函数，用于对发来的消息进行回应，如 
    // sendResponse('我已收到你的消息：'+JSON.stringify(request));
    function(request, sender, sendResponse) {…}
)
</pre>
<div style="margin-top:.625em;">
由于 background 监听所有页面上的 content script 上发来的消息，如果多个页面同时发送同种消息，background 的 onMessage 只会处理最先收到的那个，其他的不了了之了。
</div>

<h2>&#x02713; background 向 content-script 发送消息</h2>
<div>
一个插件里只有一个 background 环境，而 content-script 有多个（一个页面一个），那么 background 怎么向特定的 content-script 发送消息？
</div>
<div style="margin-top:.625em;">
在 background 端
</div>
<div style="margin-top:.625em;">
首先我们需要知道要向哪个 content scripts 发送消息，一般一个页面一份 content scripts，而一个页面对应一个浏览器 tab，每个 tab 都有自己的 tabId，因此首先要获取要发送消息的 tab 对应的 tabId。
</div>
<pre style="background-color:darkblue;color:cadetblue;padding:.625em 1em;margin-top:.325em;">
/**
 * 获取当前选项卡id
 * @param callback - 获取到id后要执行的回调函数
 */
function getCurrentTabId(callback) {
    chrome.tabs.query({active: true, currentWindow: true}, function (tabs) {
        if (callback) {
            callback(tabs.length ? tabs[0].id: null);
        }
    });
}
</pre>
<div style="margin-top:.625em;">
当知道了 tabId 后，就使用该 api 进行发送消息
</div>
<pre style="background-color:darkblue;color:cadetblue;padding:.625em 1em;margin-top:.325em;">
chrome.tabs.sendMessage(tabId, message, function(response) {...});
</pre>
<div style="margin-top:.625em;">
在 content scripts 端
</div>
<pre style="background-color:darkblue;color:cadetblue;padding:.625em 1em;margin-top:.325em;">
chrome.runtime.onMessege.addListener(function(request, sender, sendResponse) {…})
</pre>

<h1 style="padding-bottom:0;">popup 与 background 的通信</h1>
<div style="margin-top:.625em;">
一般地，popup 与 background 的交流，常见于 popup 要获取 background 里的某些 “东西”
</div>
<pre style="background-color:darkblue;color:cadetblue;padding:.625em 1em;margin-top:.325em;">
var bg = chrome.extension.getBackgroundPage();
bg.someMethod();    //someMethod()是background中的一个方法
</pre>

<h1 style="padding-bottom:0;">popup 与 content script 的通信</h1>
<div style="margin-top:.625em;">
这里的通信，实际上跟 background 与 content script 的方式是一样的
</div>

<h1 style="padding-bottom:0;">插件 iframe 网站与插入网页的通信</h1>
<div style="margin-top:.625em;">
同域的情况下，可以通过 DOM 操作达到通信的目的，如获取 dom 元素，获取值赋值之类的。<br />
在父窗体里，用 window.contentWindow 获取到 iframe 的 window 对象 <br />
在 iframe 里，用 window.parent 获取到父窗体的 window 对象 <br />
在跨域下，使用 window 对象的 postMessage() 和 onmessage。
</div>

<h1 style="padding-bottom:0;">iframe 向父窗体发送消息</h1>
<pre style="background-color:darkblue;color:cadetblue;padding:.625em 1em;margin-top:.325em;">
window.parent.postMessage(message, '*');
</pre>

<h1 style="padding-bottom:0;">在父窗体端</h1>
<div style="margin-top:.625em;">
由于一个页面，可能有来自页面本身的 postMessage 来的消息，也有可能来自该页面其他 chrome extension 发送来的消息，因此用 onmessage 来监听，要做好区分来源，这里使用以下方法:
</div>
<pre style="background-color:darkblue;color:cadetblue;padding:.625em 1em;margin-top:.325em;">
window.addEventListener('message', function (event, a, b) {
    // 如果没消息就退出
    if (!event.data) {
        return;
    }
    var iframes = document.getElementsByClassName('extension-iframe');
    var extensionIframe = null; // 存插件iframe节点对象
    var correctSource = false;  // 是否来源正确
    // 找出真正的插件生成的iframe
    for (var i = 0; i < iframes.length; i++) {
        if (iframes[i].contentWindow && (event.source === iframes[i].contentWindow)) {
            correctSource = true;
            extensionIframe = iframes[i];
            break;
        }
    }
    // 如果来源不是来自插件的，就退出
    if (!correctSource) {
        return;
    }
}, false);
</pre>

<h1 style="padding-bottom:0;">父窗体向iframe发送消息</h1>
<div style="margin-top:.625em;">
在父窗体端
</div>
<pre style="background-color:darkblue;color:cadetblue;padding:.625em 1em;margin-top:.325em;">
extensionIframe.contentWindow.postMessage(message, '*');
// message: {from: 'content-script', other: xxx}
</pre>
<div style="margin-top:.625em;">
在 iframe 端
</div>
<pre style="background-color:darkblue;color:cadetblue;padding:.625em 1em;margin-top:.325em;">
window.addEventListener('message', function (event, a, b) {
    let result = event.data;
    if (result && (result.from === 'content-script') 
        && (event.source === window.parent)) {...}
});
</pre>

<h1 style="padding-bottom:0;">本地存储</h1>
<div style="margin-top:.625em;">
本地存储建议用 chrome.storage 而不是普通的 localStorage
</div>
<div style="margin-top:.625em;">
chrome.storage 是针对插件全局的，即使你在 background 中保存的数据，在 content-script 也能获取到；
chrome.storage.sync 可以跟随当前登录用户自动同步，这台电脑修改的设置会自动同步到其它电脑，很方便，如果没有登录或者未联网则先保存到本地，等登录了再同步至网络；
</div>

<h1 style="padding-bottom:0;">webRequest</h1>
<div style="margin-top:.625em;">
通过 webRequest 系列API可以对HTTP请求进行任性地修改、定制。插件要实现一些 ajax 请求，尽量搬到 background 里实现，可以跨域。
</div>
<pre style="background-color:darkblue;color:cadetblue;padding:.625em 1em;margin-top:.325em;">
iframe -> content script -> background -> content script -> iframe
</pre>

<h1 style="padding-bottom:0;">国际化</h1>
<div style="margin-top:.625em;">
插件根目录新建一个名为 _locales 的文件夹，再在下面新建一些语言的文件夹，如en、zh_CN、zh_TW，然后再在每个文件夹放入一个 messages.json，同时必须在清单文件中设置 default_locale。
</div>
<div style="margin-top:.625em;">
JS中则直接 chrome.i18n.getMessage("helloWorld")。
</div>
<div style="margin-top:.625em;">
测试时，通过给 chrome 建立一个不同的快捷方式 chrome.exe --lang=en 来切换语言。
</div>

<h1 style="padding-bottom:0;">注意事项</h1>
<h2>&#x02713; 特别注意background的报错</h2>
<div>
很多时候你发现你的代码会莫名其妙的失效，找来找去又找不到原因，这时打开 background 的控制台才发现原来某个地方写错了导致代码没生效，正式由于 background 报错的隐蔽性(需要主动打开对应的控制台才能看到错误)，所以特别注意这点。
</div>
<h2>&#x02713; 如何让 popup 页面不关闭</h2>
<div>
在对 popup 页面审查元素的时候 popup 会被强制打开无法关闭，只有控制台关闭了才可以关闭 popup，原因很简单：如果 popup 关闭了控制台就没用了。这种方法在某些情况下很实用！
</div>
<h2>&#x02713; 不支持内联JavaScript的执行</h2>
<div>
不支持将js直接写在html中。
</div>
<h2>&#x02713; 注入CSS的时候必须小心</h2>
<div>
由于通过 content_scripts 注入的CSS优先级非常高，几乎仅次于浏览器默认样式，稍不注意可能就会影响一些网站的展示效果，所以尽量不要写一些影响全局的样式。
</div>

TODOTODO
   ]]>
    </c:sourceContent>

    <c:comment>
      <c:comment1>
        <![CDATA[]]>
      </c:comment1>
    </c:comment>
  </c:entry>


  <c:entry style="margin-top:1em;">
    <c:title id="metamask-structrues"><![CDATA[<div style="color:blue;font-size:1.625em;">metamask 架构</div>]]></c:title>
    <c:desc>
      <c:desc1> <![CDATA[
<div style="margin-bottom:.425em;font-size:1.225em;">
  metamask 既是钱包，也是和以太网交互的途径。
</div>
<div>
  <img style="width:550px;" src="/images/ether/1576481371539-60166627-5cd7-4717-b69d-151c289e2029.png" />
</div>
]]></c:desc1>
    </c:desc>
    <c:sourceContent type="html" title="" id="sourceContent1"
                     titleStyle="padding-left:0;color:green;font-size:1em;background-color:white;font-size:1.2em;"
                     bodyStyle="background-color:white;padding:0;font-size:1.2em;line-height:1.625em;font-family:monospace;">
      <![CDATA[
<div style="margin-bottom:.425em;">
  通过架构图，可以知道，作为用户，要么可以在 metamask UI界面里面直接玩，要么可以在玩耍 dApp 的时候，调用 metamask，不管怎么样，都是通过 metamask-background ，最终调用 eth 的 rpc。
</div>
<div style="margin-bottom:.425em;">
  源码的类、对象等的详细解释: <br />
  <a href="https://metamask.github.io/metamask-extension/index.html">https://metamask.github.io/metamask-extension/index.html</a> 
</div>
<div style="margin-bottom:.425em;">
  Guide to Porting MetaMask to a New Environment 这篇文章大概梳理了一下流程: <br />
  <a href="https://github.com/MetaMask/metamask-extension/blob/develop/docs/porting_to_new_environment.md">https://github.com/MetaMask/metamask-extension/blob/develop/docs/porting_to_new_environment.md</a>
</div>
   ]]>
    </c:sourceContent>
    <c:sourceContent type="html" title="metamask-background" id="sourceContent1"
                     titleStyle="padding-left:0;color:green;font-size:1em;background-color:white;font-size:1.6em;"
                     bodyStyle="background-color:white;padding:0;font-size:1.2em;line-height:1.625em;font-family:monospace;">
      <![CDATA[
<div style="margin-bottom:.425em;">
  <a href="https://github.com/MetaMask/metamask-extension/blob/develop/app/scripts/background.js">https://github.com/MetaMask/metamask-extension/blob/develop/app/scripts/background.js</a>
</div>
<div style="margin-bottom:.425em;">
<a href="https://www.yuque.com/jnoodle/ox47v8/pn8ynl">background.js</a> 里面实例化了 MetaMask Controller，MetaMask Controller 主要用于用户账户、和链的连接还有和 dapp 的交互。
</div>
<div style="margin-bottom:.425em;">
每当访问一个新站点，插件都会创建一个 ContentScript 在页面中：
</div>
<div style="margin-bottom:.425em;">
<a href="https://github.com/MetaMask/metamask-extension/blob/develop/app/scripts/contentscript.js">https://github.com/MetaMask/metamask-extension/blob/develop/app/scripts/contentscript.js</a> <br />
<a href="https://www.yuque.com/jnoodle/ox47v8/anceie">https://www.yuque.com/jnoodle/ox47v8/anceie</a>
</div>
<div style="margin-bottom:.425em;">
ContentScript 在每个页面里都注入了 web3 api，通过 Port API （使用 <a href="https://github.com/jabez128/stream-handbook">stream</a> 抽象包裹） 连接到 background，在页面加载之间注入 DOM。
</div>
<div style="margin-bottom:.425em;">
<a href="https://github.com/MetaMask/metamask-inpage-provider">https://github.com/MetaMask/metamask-inpage-provider</a> 就是一个 eth provider，MetaMask 把 metamask-inpage-provider 注入到页面中，我们自己也可以构造一个 provider：
</div>
<pre style="background-color:darkblue;color:cadetblue;padding:.625em 1em;margin-top:.325em;">
const providerFromEngine = require('eth-json-rpc-middleware/providerFromEngine')

/**
 * returns a provider restricted to the requesting domain
 **/
function incomingConnection (domain) {
  const engine = metamaskController.setupProviderEngine(domain)
  const provider = providerFromEngine(engine)
  return provider
} 
</pre>
   ]]>
    </c:sourceContent>
    <c:sourceContent type="html" title="使用 Streams Interface" id="sourceContent1"
                     titleStyle="padding-left:0;color:green;font-size:1em;background-color:white;font-size:1.6em;margin-top:.625em;"
                     bodyStyle="background-color:white;padding:0;font-size:1.2em;line-height:1.625em;font-family:monospace;">
      <![CDATA[
<div style="margin-bottom:.425em;">
  可以看一下 MetaMask 如何在 <a href="https://github.com/MetaMask/metamask-extension/blob/develop/app/scripts/inpage.js">inpage.js</a> 中来创建 <a href="https://github.com/MetaMask/metamask-inpage-provider/blob/master/index.js">MetamaskInpageProvider</a>。其实 MetaMask 在 <a href="https://developer.chrome.com/extensions/runtime#property-Port-postMessage">Port postMessage API</a> 基础上做了一层封装。
</div>
<div style="margin-bottom:.425em;">
  通过 setupUntrustedCommunication(stream, domain)，可以和 MetaMaskController 通信。
</div>
   ]]>
    </c:sourceContent>
    <c:sourceContent type="html" title="MetaMask Controller" id="sourceContent1"
                     titleStyle="padding-left:0;color:green;font-size:1em;background-color:white;font-size:1.6em;margin-top:.625em;"
                     bodyStyle="background-color:white;padding:0;font-size:1.2em;line-height:1.625em;font-family:monospace;">
      <![CDATA[
<div style="margin-bottom:.425em;">
<a href="https://github.com/MetaMask/metamask-extension/blob/master/app/scripts/metamask-controller.js">https://github.com/MetaMask/metamask-extension/blob/master/app/scripts/metamask-controller.js</a> <br />
<a href="https://www.yuque.com/jnoodle/ox47v8/xot5gg">https://www.yuque.com/jnoodle/ox47v8/xot5gg</a>
</div>

<div style="margin-bottom:.425em;">
MetaMask 的核心功能都在 MetaMask Controller 里面。创建 MetaMask Controller 的目标是让他可以导入到任何 JS 上下文中，可以管理 app 和 Ethereum 之间的关系。
</div>

<h1 style="padding-bottom:0;">Contructor</h1>
<h2>&#x02713; new MetaMask(opts)</h2>
<ul style="margin-top:.325em;list-style: disc;margin-left: 1.5em;font-size: 1em;line-height: 1.625em;">
  <li><b>initState:</b> The last emitted state, used for restoring persistent state between sessions. 最后发出的状态，用于在会话之间恢复持久状态</li>
  <li>
    <p><b>platform:</b> The platform object defines a variety of platform-specific functions, including opening the confirmation view, and opening websites. 平台对象定义了各种特定于平台的功能，包括打开确认视图和打开web站点。</p>
    <ul style="margin-top:.325em;list-style: none;font-size: 1em;line-height: 1.625em;">
      <li><b>&#x02ABC; reload (function)</b> - Will be called when MetaMask would like to reload its own context. 将在MetaMask想要重新加载其自己的上下文时调用</li>
      <li><b>&#x02ABC; openWindow ({ url })</b> - Will be called when MetaMask would like to open a web page. It will be passed a single options object with a url key, with a string value. 在MetaMask想要打开web页面时调用。它将传递一个带有url键和字符串值的单一选项对象</li>
      <li><b>&#x02ABC; getVersion()</b> - Should return the current MetaMask version, as described in the current CHANGELOG.md or app/manifest.json. 应该返回当前MetaMask的版本，即在当前的 CHANGELOG.md或app/manifest.json中所述的版本号</li>
    </ul>
  </li>
  <li>
    <p><b>encryptor</b> - An object that provides access to the desired encryption methods. 供对所需加密方法的访问的对象，提供两种可以以你喜欢的任何格式进行加密的简单方法的对象。这个参数是可选的，默认为浏览器本地的WebCrypto API。</p>
    <ul style="margin-top:.325em;list-style: none;font-size: 1em;line-height: 1.625em;">
      <li><b>&#x02ABC; encrypt(password, object)</b> - returns a Promise of a string that is ready for storage.</li>
      <li><b>&#x02ABC; decrypt(password, encryptedString)</b> - Accepts the encrypted output of encrypt and returns a Promise of a restored object as it was encrypted.</li>
    </ul>
  </li>
</ul>

<h2>&#x02713; metamask.getState()</h2>
<div style="margin-bottom:.425em;">
该方法返回一个 javascript 对象，表示当前的 MetaMask state。这包括已知的帐户、发送的交易、当前汇率等等。控制器也是一个事件发射器，所以你可以通过 metamask.on('update', handleStateUpdate) 来订阅状态更新。<a href="https://github.com/MetaMask/metamask-extension/tree/master/development/states">状态示例</a> 即一系列json文件，即 "metamask" 键下的值的信息。
</div>

<h2>&#x02713; metamask.getApi()</h2>
<div style="margin-bottom:.425em;">
返回一个JavaScript对象，该对象中包含回调函数，表示用户界面执行的每个操作。通过这些API方法提供了从创建新帐户、更改当前网络到发送交易的所有内容。我们在对象上导出这个外部API，因为它允许我们使用 dnode 在端口上轻松地公开这个API，这就是 WebExtension UI 的工作方式!
</div>


<h1 style="padding-bottom:0;">UI</h1>
<div style="margin-bottom:.425em;">
MetaMask UI本质上只是一个网站，可以通过从上面传递API和状态订阅来配置它。任何人都可以创建一个使用这些的UI，有效地重新设计MetaMask
</div>
<div style="margin-bottom:.425em;">
UI 的实现：<br />
<a href="https://github.com/MetaMask/metamask-extension/blob/master/ui/index.js">https://github.com/MetaMask/metamask-extension/blob/master/ui/index.js</a>
<a href="https://www.yuque.com/jnoodle/ox47v8/tkc19z">https://www.yuque.com/jnoodle/ox47v8/tkc19z</a>
</div>
<div style="margin-bottom:.425em;">
backgroundConnection 会被传到 UI 里，backgroundConnection 对于 MetaMask Controller 非常重要，通过访问它，UI能够初始化整个依赖于该API实现其帐户/区块链相关/持久状态的React/Redux应用程序。
</div>
<h2>&#x02713; Putting it Together</h2>
<pre style="background-color:darkblue;color:cadetblue;padding:.625em 1em;margin-top:.325em;">
// manifest.json
...
  "background": {
    "scripts": [
      "chromereload.js",
      "bg-libs.js",
      "background.js"
    ],
    "persistent": true
  },
...
</pre>
<pre style="background-color:darkblue;color:cadetblue;padding:.625em 1em;margin-top:.325em;">
const controller = new MetamaskController({
    // User confirmation callbacks:
    showUnconfirmedMessage: triggerUi,
    showUnapprovedTx: triggerUi,
    // initial state
    initState,
    // platform specific api
    platform,
})
</pre>
<div style="margin-bottom:.425em;margin-top:1em;">
background.js 完成的事情：
</div>
<ul style="margin-top:.325em;list-style: none;font-size: 1em;line-height: 1.825em;">
  <li>&starf; Defining how to open the UI for new messages, transactions, and even requests to unlock (reveal to the site) their account. 定义如何为新消息、事务、甚至为解锁(向站点显示)其帐户的请求打开UI</li>
  <li>&starf; Provide the instance's initial state, leaving MetaMask persistence to the platform. 提供实例的初始状态，将MetaMask持久化保留到平台</li>
  <li>&starf; Providing a platform object. This is becoming our catch-all adapter for platforms to define a few other platform-variant features we require, like opening a web link. (Soon we will be moving encryption out here too, since our browser-encryption isn't portable enough!) 提供平台对象。这将成为平台的通用适配器，用于定义我们需要的其他一些平台变体特性，比如打开web链接。(不久我们也将把加密技术移到这里，因为我们的浏览器加密还不够便携!)</li>
</ul>


<h1>Ports, streams, and Web3!</h1>
<div style="margin-bottom:.425em;">
到目前为止，在几乎所有运行JS的平台上都可以创建一个MetaMask wallet，但MetaMask最独特的功能不是钱包，而是为网站提供了一个Ethereum-enabled的JavaScript环境。
</div>
<div style="margin-bottom:.425em;">
MetaMask 暴露了两种 <a href="https://github.com/substack/stream-handbook#duplex">duplex stream APIs</a>
</div>
<ul style="margin-top:.325em;list-style: none;font-size: 1em;line-height: 1.825em;">
  <li>&starf; <b>metamask.setupTrustedCommunication(connectionStream, originDomain)</b> - This stream is used to connect the user interface over a remote port, and may not be necessary for contexts where the interface and the metamask-controller share a process.  此流用于通过远程端口连接用户界面，对于接口和metamask控制器共享进程的上下文可能不需要此流</li>
  <li>&starf; <b>metamask.setupUntrustedCommunication(connectionStream, originDomain)</b> - This method is used to connect a new web site's web3 API to MetaMask's blockchain connection. Additionally, the originDomain is used to block detected phishing sites. 此方法用于将新web站点的web3 API连接到MetaMask的区块链连接。另外，originDomain可以用来阻止检测到的钓鱼网站</li>
</ul>


<h1>Web3 as a Stream</h1>
<div style="margin-bottom:.425em;">
如果正在为一个新平台开发一个基于 MetaMask-powered 的浏览器，那么最棘手的任务之一就是将 Web3 API 注入到访问的网站中。在 WebExtensions，我们实际上需要通过总共三个JS上下文来传输数据，只是为了让站点与我们的后台进程对话 (site -> contentscript -> background)
</div>
<div style="margin-bottom:.425em;">
可以看一下 <a href="https://github.com/MetaMask/metamask-extension/blob/master/app/scripts/inpage.js">https://github.com/MetaMask/metamask-extension/blob/master/app/scripts/inpage.js</a> 来了解是怎么往网站里面注入的。创建了一个到后台的多路复用的 stream，并使用它来初始化 <a href="https://github.com/MetaMask/metamask-inpage-provider/blob/master/index.js">MetamaskInpageProvider</a>，可以看到 inpage-provider 的一些方法输出了stubs（存根），但它的大多数方法只是通过它传递的流来传递对sendAsync的调用! 一旦你有了一个可用的 MetaMask 流，以上就是在远程上下文中创建类似 web3 的API所需要的所有操作。
</div>
<div style="margin-bottom:.425em;">
在 inpage.js 你可以看到我们创建了一个我们用来将 WebExtension 端口包装成流的 <a href="https://github.com/MetaMask/metamask-extension/blob/develop/app/scripts/inpage.js#L52">PortMessage Stream</a>，因此我们可以在 WebExtension 的更加不规则的API表面上重用我们喜欢的流抽象。在新的平台中，您可能需要以不同的方式构造这个流。关键是您需要构建一个从站点上下文到后台的流。一旦你设置好了，它就会像魔术一样运作!
</div>
<div style="margin-bottom:.425em;">
学习 stream：<br />
<a href="https://github.com/substack/stream-handbook">https://github.com/substack/stream-handbook</a>（中文：<a href="https://github.com/jabez128/stream-handbook">https://github.com/jabez128/stream-handbook</a>）
<a href="https://github.com/workshopper/stream-adventure">https://github.com/workshopper/stream-adventure</a>
</div>


<h1>MetaMask 实现了 RPC 接管</h1>
<div style="margin-bottom:.425em;">
chrome 扩展程序基本结构：
</div>
<ul style="margin-top:.325em;list-style: none;font-size: 1em;line-height: 1.825em;">
  <li>&starf; contentscripts.js：插件中唯一拥有操作当前活动标签页面dom权限的js</li>
  <li>&starf; background.js：全局运行的js(类似于`插件后台`)</li>
  <li>&starf; propub.html：插件界面UI</li>
</ul>
<div style="margin-bottom:.425em;margin-top:1em;">
插件中的 js 之间可以通过 postMessage 接口通信
</div>
<div style="margin-bottom:.425em;">
Metamask 在 contentscripts.js 中 injects inpage.js。
</div>
<div style="margin-bottom:.425em;">
inpage.js 中注册 MetamaskInpageProvider（metamask-inpage-provider库）为 web3。
</div>
<div style="margin-bottom:.425em;">
MetamaskInpageProvider 实现了 web3 的方法。
</div>


   ]]>
    </c:sourceContent>

    <c:comment>
      <c:comment1>
        <![CDATA[]]>
      </c:comment1>
    </c:comment>
  </c:entry>


  <c:entry style="margin-top:1em;">
    <c:title id="metamask-developer"><![CDATA[<div style="color:blue;font-size:1.625em;">metamask 开发</div>]]></c:title>
    <c:desc>
      <c:desc1> <![CDATA[
<div style="margin-bottom:.425em;font-size:1.225em;line-height:1.625em;">
MetaMask 主要是用来在浏览器中直接连接 ETH 网络的插件，本身带有钱包功能。
</div>
<div style="margin-bottom:.425em;font-size:1.225em;line-height:1.625em;">
大部分 Dapp 是运行在浏览器里的，这样通过浏览器插件来使用 ETH 上面的合约很方便。这里说的开发主要是 dapp 调用 MetaMask 来进行一些链操作。
</div>
]]></c:desc1>
    </c:desc>
    <c:sourceContent type="html" title="" id="sourceContent1"
                     titleStyle="padding-left:0;color:green;font-size:1em;background-color:white;font-size:1.2em;"
                     bodyStyle="background-color:white;padding:0;font-size:1.2em;line-height:1.625em;font-family:monospace;">
      <![CDATA[
<div style="margin-bottom:.425em;">
metamask 提供了 window.ethereum 与用户应用交互。
</div>
<div style="margin-bottom:.425em;">
用 ethereum.isMetaMask 检测 metamask。
</div>
<div style="margin-bottom:.425em;">
What is the current network?  ethereum.networkVersion<br />
What is the current account?  ethereum.selectedAddress
</div>
<div style="margin-bottom:.425em;">
连接 metamask，不要在页面载入后自动连接，而是要通过用户事件触发，比如点击 “连接 MetaMask” 按钮。
</div>
<pre style="background-color:darkblue;color:cadetblue;padding:.625em 1em;margin-top:.325em;">
const accounts = await ethereum.enable()
const account = accounts[0] // We currently only ever provide a single account,
                            // but the array gives us some room to grow.
</pre>

<h1 style="padding-bottom:0;">术语</h1>
<ul style="margin-top:.325em;list-style: none;font-size: 1em;line-height: 1.825em;">
  <li>&starf; <b>Wallet：</b>钱包是用来管理账户的 interface / client / wrapper / holder</li>
  <li>&starf; <b>Account：</b>A public & private keypair that "holds" your funds.</li>
  <li>&starf; <b>Address (“Public Key”) ：</b>You use this to send funds to an account. 0x + 40 hexadecimal characters </li>
  <li>&starf; <b>Public Key：</b>You can derive a public key from a private key. </li>
  <li>&starf; <b>Private Key：</b>You use this to send funds from an account. A string of 64 hexadecimal characters. 一般不用明文保存，而是加密下保存，比如 the Keystore File / Mnemonic Phrase</li>
  <li>&starf; <b>Keystore File：</b>Encrypted version of your private key in JSON format</li>
  <li>&starf; <b>Mnemonic Phrase / Seed Phrase / Seed Words：</b>助记词 A (typically) 12 or 24 word phrase that allows you to access infinite number of accounts.</li>
  <li>&starf; <b>Hardware Wallet：</b>注意离线备份助记词</li>
  <li>&starf; <b>Identicon / AddressIdenticon / AddressIcon：</b>通过图标快速区分地址</li>
  <li>&starf; <b>Hexadecimal：</b>十六进制</li>
  <li>&starf; <b>Seed：</b>随机产生私钥</li>
  <li>&starf; <b>Brain Wallet：</b>An account generated from a seed or password or passphrase of your choosing. Don't use brain wallets.</li>
  <li>&starf; <b>Entropy：</b>熵 Also known as "randomness". The more random something is, the more entropy it has, and the more secure it is.</li>
  <li>&starf; <b>Derive / Derivation：</b>To derive something is to obtain it from an original source.</li>
  <li>&starf; <b>Encryption：</b>加密</li>
  <li>&starf; <b>Encrypted vs Unencrypted Keys：</li>
  <li>&starf; <b>Decentralize / Decentralization：</b>分散集权</li>
  <li>&starf; <b>Trustless：</b>A distributed trustless consensus which the blockchain is responsible for. </li>
  <li>&starf; <b>Smart Contracts：</b>A piece of code (or program) that is stored on the blockchain network.</li>
  <li>&starf; <b>Blockchain：</b>A decentralized publicly owned ledger.</li>
</ul>

<h1 style="padding-bottom:0;">Dapps</h1>
<div style="margin-bottom:.425em;margin-top:.325em;">
一些 dapp 可以识别用户当前网络，自动切换合约地址。
</div>
<div style="margin-bottom:.425em;">
智能合约都要有个地址 Contract Address。
</div>
<div style="margin-bottom:.425em;">
Contract ABI：类比 API
</div>
<div style="margin-bottom:.425em;">
Contract Bytecode：字节码用来发布，没有 ABI，只有字节码，也没法交互。
</div>

<h1 style="padding-bottom:0;">访问账户</h1>
<div style="margin-bottom:.425em;margin-top:.325em;">
ethereum.selectedAddress  订阅账户变化：
</div>
<pre style="background-color:darkblue;color:cadetblue;padding:.625em 1em;margin-top:.325em;">
ethereum.on('accountsChanged', function (accounts) {
  // Time to reload your interface with accounts[0]!
})
</pre>
<div style="margin-bottom:.425em;margin-top:.625em;">
下面调用钱包的方法都需要用户账户参数：
</div>
<ul style="margin-top:.325em;list-style: none;font-size: 1em;line-height: 1.825em;">
  <li>&starf; eth_sendTransaction</li>
  <li>&starf; eth_sign (insecure and unadvised to use)</li>
  <li>&starf; eth_personalSign</li>
  <li>&starf; eth_signTypedData</li>
</ul>

<h1 style="padding-bottom:0;">发送交易</h1>
<div style="margin-bottom:.425em;margin-top:.325em;">
在 Metamask 里使用 ethereum.sendAsync 发送交易，背后调用 eth_sendTransaction  方法
</div>
<pre style="background-color:darkblue;color:cadetblue;padding:.625em 1em;margin-top:.325em;">
const transactionParameters = {
  
  // ignored by MetaMask, MetaMask 自动管理
  nonce: '0x00',
  
  // customizable by user during MetaMask confirmation. 
  // 一般自己不用管
  // MetaMask 通过 API 请求 MyCrypto，获取 “slow,” “medium,” and “fast” 的 gas price
  gasPrice: '0x09184e72a000', 
  
  // customizable by user during MetaMask confirmation.
  // 一般也不用管
  gas: '0x2710',  
  
  // Required except during contract publications.
  // 一般不是创建合约的话，都需要
  to: '0x0000000000000000000000000000000000000000', 
  
  // must match user's active address.
  from: web3.eth.accounts[0], 
  
  // Only required to send ether to the recipient from the initiating external account.
  // 单位 wei 1e-18 
  // 尽量使用 BN.js 处理
  value: '0x00', 
  
  // Optional, but used for defining smart contract creation and interaction.
  // 一般创建智能合约需要
  data: '0x7f7465737432000000000000000000000000000000000000000000000000000000600057', 
  
  // Used to prevent transaction reuse across blockchains. Auto-filled by MetaMask.
  // 现在直接用 ethereum.networkVersion，未来可能需要传
  chainId: 3 
  
}

ethereum.sendAsync({
  method: 'eth_sendTransaction',
  params: [transactionParameters],
  from: ethereum.selectedAddress,
}, callback)
</pre>

<h1 style="padding-bottom:0;">接入到一个自定义的网络</h1>
<div>
  <img style="width:330px;" src="/images/ether/1577242873553-3e536465-f9be-430d-b349-e5c687d89b77.png" />
</div>
<div style="margin-top:1em;">
  修改下面的文件：
</div>
<pre style="background-color:darkblue;color:cadetblue;padding:.625em 1em;margin-top:.325em;">
app/scripts/config.js
app/scripts/lib/buy-eth-url.js
ui/app/index.js
ui/app/components/buy-button-subview.js
ui/app/components/drop-menu-item.js
ui/app/components/network.js
ui/app/components/transaction-list-item.js
ui/app/config.js
ui/app/css/lib.css
ui/lib/account-link.js
ui/lib/explorer-link.js
</pre>
<div style="margin-top:1em;">
  需要:
</div>
<ul style="margin-top:.325em;list-style: none;font-size: 1em;line-height: 1.825em;">
  <li>&starf; The network ID</li>
  <li>&starf; An RPC Endpoint url</li>
  <li>&starf; An explorer link</li>
  <li>&starf; CSS for the display icon</li>
</ul>

<h1 style="padding-bottom:0;">接口</h1>
<div>
  metamask 主要是把 web3 注入到了所有页面的 js 上下文中，如果这个页面是个 dapp，就可以直接和 eth 链交互了。
</div>
<pre style="background-color:darkblue;color:cadetblue;padding:.625em 1em;margin-top:.325em;">
if (typeof window.ethereum !== 'undefined') {
  // Ethereum user detected. You can now use the provider.
  const provider = window['ethereum']
}
</pre>
<div style="margin-top:1em;">
  MetaMask 的接口总体比较简单。
</div>

<h1 style="padding-bottom:0;">属性</h1>
<div>
  &sdotb; ethereum.networkVersion 当前网络ID，未来会删除
</div>
<pre style="background-color:darkblue;color:cadetblue;padding:.625em 1em;margin-top:.325em;">
'1': Ethereum Main Network
'2': Morden Test network
'3': Ropsten Test Network
'4': Rinkeby Test Network
'5': Goerli Test Network
'42': Kovan Test Network
</pre>
<div style="margin-top:.625em;">
  &sdotb; ethereum.selectedAddress 当前用户地址，未来会删除
</div>
<div>
  &sdotb; ethereum.isMetaMask 是否安装了 MetaMask
</div>

<h1 style="padding-bottom:0;">方法</h1>
<div>
  &sdotb; ethereum.enable() 返回用户 eth 地址
</div>
<pre style="background-color:darkblue;color:cadetblue;padding:.625em 1em;margin-top:.325em;">
try {
  const accounts = await ethereum.enable()
  // You now have an array of accounts!
  // Currently only ever one:
  // ['0xFDEa65C8e26263F6d9A1B5de9555D2931A33b825']

} catch (error) {
  // Handle error. Likely the user rejected the login
  console.error(error)
}
</pre>
<div style="margin-top:.625em;">
  注意新的API是 ethereum.send(‘eth_requestAccounts’) 
</div>
<pre style="background-color:darkblue;color:cadetblue;padding:.625em 1em;margin-top:.325em;">
try {
  const accounts = await ethereum.send('eth_requestAccounts')
  // You now have an array of accounts!
  // Currently only ever one:
  // ['0xFDEa65C8e26263F6d9A1B5de9555D2931A33b825']

} catch (error) {
  if (error.code === 4001) { // EIP 1193 userRejectedRequest error
    console.log('Please connect to MetaMask.')
  } else {
    console.error(error)
  }
}
</pre>
<div style="margin-top:.625em;">
  &sdotb; ethereum.send(options, callback)
</div>
<pre style="background-color:darkblue;color:cadetblue;padding:.625em 1em;margin-top:.325em;">
params: [{
  "from": "0xb60e8dd61c5d32be8058bb8eb970870f07233155",
  "to": "0xd46e8dd67c5d32be8058bb8eb970870f07244567",
  "gas": "0x76c0", // 30400
  "gasPrice": "0x9184e72a000", // 10000000000000
  "value": "0x9184e72a", // 2441406250
  "data": "0xd46e8dd67c5d32be8d46e8dd67c5d32be8058bb8eb970870f072445675058bb8eb970870f072445675"
}]

ethereum.send('eth_sendTransaction', params)
.then(function (result) {
  // The result varies by method, per the JSON RPC API.
  // For example, this method will return a transaction hash on success.
})
.catch(function (error) {
 // Like a typical promise, returns an error on rejection.
})
</pre>
<div style="margin-top:.625em;">
  &sdotb; ethereum.sendAsync(options, callback) (Deprecated)
</div>
<div style="">
  向 web3 发消息，格式：the Ethereum JSON-RPC API，建议都用新的 send
</div>
<pre style="background-color:darkblue;color:cadetblue;padding:.625em 1em;margin-top:.325em;">
params: [{
  "from": "0xb60e8dd61c5d32be8058bb8eb970870f07233155",
  "to": "0xd46e8dd67c5d32be8058bb8eb970870f07244567",
  "gas": "0x76c0", // 30400
  "gasPrice": "0x9184e72a000", // 10000000000000
  "value": "0x9184e72a", // 2441406250
  "data": "0xd46e8dd67c5d32be8d46e8dd67c5d32be8058bb8eb970870f072445675058bb8eb970870f072445675"
}]

ethereum.sendAsync({
  method: 'eth_sendTransaction',
  params: params,
  from: accounts[0], // Provide the user's account to use.
}, function (err, result) {
  // A typical node-style, error-first callback.
  // The result varies by method, per the JSON RPC API.
  // For example, this method will return a transaction hash on success.
})
</pre>
<div style="margin-top:.625em;">
  &sdotb; ethereum.autoRefreshOnNetworkChange (To Be Removed) 切换网络会刷新页面
</div>
<div style="margin-top:.425em;">
  &sdotb; ethereum.on(eventName, callback) 监听一些事件：accountsChanged ， networkChanged ， chainChanged 
</div>
<div style="margin-top:.425em;">
  MetaMask 未来版本的 API 会更简单，主要就是 isMetaMask ， send() ， on()
</div>
<div style="margin-top:.425em;">
EIP-1193 规定了 Ethereum Provider JavaScript API：<br />
<a href="https://github.com/ethereum/EIPs/blob/master/EIPS/eip-1193.md">https://github.com/ethereum/EIPs/blob/master/EIPS/eip-1193.md</a>
</div>
<pre style="background-color:darkblue;color:cadetblue;padding:.625em 1em;margin-top:.325em;">
ethereum.send(method: String, params?: Array<any>): Promise<any>; 
ethereum.on('notification', listener: (result: any) => void): this; 
ethereum.on('connect', listener: () => void): this; 
ethereum.on('close', listener: (code: Number, reason: String) => void): this; 
ethereum.on('chainChanged', listener: (chainId: String) => void): this; 
ethereum.on('networkChanged', listener: (networkId: String) => void): this; 
ethereum.on('accountsChanged', listener: (accounts: Array<String>) => void): this; 
</pre>
<div style="margin-top:.425em;">
一个新 API 的例子 <a href="https://gist.github.com/rekmarks/d318677c8fc89e5f7a2f526e00a0768a">https://gist.github.com/rekmarks/d318677c8fc89e5f7a2f526e00a0768a</a>
</div>
<pre style="background-color:darkblue;color:cadetblue;padding:.625em 1em;margin-top:.325em;">
// 先判断是否安装了 MetaMask
if (!ethereum || !ethereum.isMetaMask) {
  throw new Error('Please install MetaMask.')
}

/*********************************************************/
/* Handle chain (network) and chainChanged, per EIP 1193 */
/*********************************************************/

let currentChainId = null
ethereum.send('eth_chainId')
  .then(handleChainChanged)
  .catch(err => console.error(err)) // This should never happen

ethereum.on('chainChanged', handleChainChanged)

function handleChainChanged (chainId) {

  if (currentChainId !== chainId) {

    currentChainId = chainId
    // Run any other necessary logic...
  }
}

/**********************************************************/
/* Handle user accounts and accountsChanged, per EIP 1193 */
/**********************************************************/

let currentAccount = null
ethereum.send('eth_accounts')
  .then(handleAccountsChanged)
  .catch(err => {
    // In the future, maybe in 2020, this will return a 4100 error if
    // the user has yet to connect
    if (err.code === 4100) { // EIP 1193 unauthorized error
      console.log('Please connect to MetaMask.')
    } else {
      console.error(err)
    }
  })

// Note that this event is emitted on page load.
// If the array of accounts is non-empty, you're already
// connected.
ethereum.on('accountsChanged', handleAccountsChanged)

// For now, 'eth_accounts' will continue to always return an array
function handleAccountsChanged (accounts) {

  if (accounts.length === 0) {

    // MetaMask is locked or the user has not connected any accounts
    console.log('Please connect to MetaMask.')

  } else if (accounts[0] !== currentAccount) {

    currentAccount = accounts[0]
    // Run any other necessary logic...
  }
}

/***********************************/
/* Handle connecting, per EIP 1102 */
/***********************************/

// You should only attempt to connect in response to user interaction,
// such as a button click. Otherwise, you're popup-spamming the user
// like it's 1999.
// If you can't retrieve the user's account(s), you should encourage the user
// to initiate a connection attempt.
document.getElementById('connectButton', connect)

function connect () {

  // This is equivalent to ethereum.enable()
  ethereum.send('eth_requestAccounts')
    .then(handleAccountsChanged)
    .catch(err => {
      if (err.code === 4001) { // EIP 1193 userRejectedRequest error
        console.log('Please connect to MetaMask.')
      } else {
        console.error(err)
      }
    })
}
</pre>

<h1 style="padding-bottom:0;">实验性质API</h1>
<div style="margin-top:.425em;">
  <b>wallet_watchAsset</b> 管理代币 <a href="https://github.com/estebanmino/EIPs/blob/master/EIPS/eip-747.md">EIP 747</a>
</div>
<pre style="background-color:darkblue;color:cadetblue;padding:.625em 1em;margin-top:.325em;">
ethereum.sendAsync({
  method: 'metamask_watchAsset',
  params: {
    "type":"ERC20", // Initially only supports ERC20, but eventually more!
    "options":{
      "address": tokenAddress, // The address that the token is at.
      "symbol": tokenSymbol, // A ticker symbol or shorthand, up to 5 chars.
      "decimals": tokenDecimals, // The number of decimals in the token
      "image": tokenImage, // A string url of the token logo
    },
  },
  id: Math.round(Math.random() * 100000),
}, (err, addedBoolean) => {

})
</pre>
<div style="margin-top:.425em;">
  加入代币的一个示例：<a href="https://github.com/MetaMask/Add-Token">https://github.com/MetaMask/Add-Token</a>
</div>
<div style="margin-top:.425em;">
  <b>ethereum._metamask</b> 这个是 MetaMask 特有的，一般 dapp 编写应该兼容所有的 dapp 浏览器，其他浏览器可能没有这个属性。不建议使用。
</div>
<pre style="background-color:darkblue;color:cadetblue;padding:.625em 1em;margin-top:.325em;">
ethereum._metamask.isUnlocked: () => Promise<boolean> 
</pre>

<h1 style="padding-bottom:0;">签名</h1>

<div style="margin-top:.425em;">
签名库：<a href="https://github.com/MetaMask/eth-sig-util">https://github.com/MetaMask/eth-sig-util</a><br />
使用例子：https://github.com/danfinlay/js-eth-personal-sign-examples
</div>
<div style="margin-top:.425em;">
MetaMask 目前有物种签名方法：
</div>

<div style="margin-top:.425em;">
&starf; eth_sign
</div>
<div style="margin-top:.425em;">
没有时间限制，可以用来签署交易，容易被钓鱼网站利用，受到 <a href="https://en.wikipedia.org/wiki/Chosen-ciphertext_attack">https://en.wikipedia.org/wiki/Chosen-ciphertext_attack </a> 攻击（<a href="https://www.zhihu.com/question/34624915">https://www.zhihu.com/question/34624915</a>）。
一般不建议使用，不过由于历史原因也还支持，会显示红色警告，不建议使用。
</div>

<div style="margin-top:.425em;">
&starf; personal_sign
</div>
<div style="margin-top:.425em;">
<a href="https://github.com/ethereum/go-ethereum/pull/2940">https://github.com/ethereum/go-ethereum/pull/2940</a> <br />
和 eth_sign 类似，增加了个消息，存了签名之后，以后可以知道用户签署了这个消息，比如同意了什么协议。这样即使用户没有 ETH，也可以做签名，证明自己对账户有控制权。这样可以用户网站登录之类的。
<a href="https://medium.com/metamask/the-new-secure-way-to-sign-data-in-your-browser-6af9dd2a1527">https://medium.com/metamask/the-new-secure-way-to-sign-data-in-your-browser-6af9dd2a1527</a>
</div>

<div style="margin-top:.425em;">
&starf; signTypedData
</div>
<div style="margin-top:.425em;">
不过这些签名在链上进行验证比较昂贵，就有了 <a href="https://eips.ethereum.org/EIPS/eip-712">EIP712</a> <a href="https://segmentfault.com/a/1190000015647458">中文</a>，可以用结构化的方式在签名中提示信息。
</div>
<div style="margin-top:.425em;">
  <img src="/images/ether/1577262997496-2ee6ee01-0223-4de1-b04a-56593710c84e.png" />
</div>
<div style="margin-top:.425em;">
不过 signTypedData 有不同的版本，所以 MetaMask 选择了根据版本号区分。
</div>

<div style="margin-top:.425em;">
&starf; signTypedData_v1 老版本，不用了
</div>
<div style="margin-top:.425em;">
  <a href="https://medium.com/metamask/scaling-web3-with-signtypeddata-91d6efc8b290">https://medium.com/metamask/scaling-web3-with-signtypeddata-91d6efc8b290</a>
</div>

<div style="margin-top:.425em;">
&starf; signTypedData_v3
</div>
<div style="margin-top:.425em;">
&starf; signTypedData_v4
</div>
<div style="margin-top:.425em;">
  <a href="https://medium.com/metamask/eip712-is-coming-what-to-expect-and-how-to-use-it-bb92fd1a7a26">https://medium.com/metamask/eip712-is-coming-what-to-expect-and-how-to-use-it-bb92fd1a7a26</a>
</div>
<div style="margin-top:.425em;">
  例子: <a href="https://weijiekoh.github.io/eip712-signing-demo/index.html">https://weijiekoh.github.io/eip712-signing-demo/index.html</a>
</div>

   ]]>
    </c:sourceContent>

    <c:comment>
      <c:comment1>
        <![CDATA[]]>
      </c:comment1>
    </c:comment>
  </c:entry>


  <c:entry style="margin-top:1em;">
    <c:title id="metamask-dependencies"><![CDATA[<div style="color:blue;font-size:1.2em;">metamask 依赖分析</div>]]></c:title>
    <c:desc>
      <c:desc1> <![CDATA[
metamask 由于项目比较久，用的依赖有新有旧，有很多已经过时不维护了，有的功能有重复。
]]></c:desc1>
    </c:desc>
    <c:sourceContent type="" title="package.json" id="sourceContent1"
                     titleStyle="padding-left:0;color:green;font-size:1em;background-color:white;font-size:1.2em;"
                     bodyStyle="background-color:white;padding:0;font-size:.625em;line-height:1em;font-family:monospace;">
      <![CDATA[
{
  "name": "metamask-crx",
  "version": "0.0.0",
  "private": true,
  "scripts": {
    // 开发构建 with logging and file watching
    "start": "gulp dev:extension",
    // 发布构建
    "dist": "gulp dist",
    // 生成文档
    "doc": "jsdoc -c development/.jsdoc.json",
    // 发布文档
    "publish-docs": "gh-pages -d docs/jsdocs",
    // 测试相关
    "start:test": "gulp dev:test",
    "build:test": "gulp build:test",
    "test": "yarn test:unit && yarn lint",
    // e2e dapp test
    "dapp": "static-server test/e2e/contract-test --port 8080",
    // e2e dapp test by ganache
    "dapp-chain": "GANACHE_ARGS='-b 2' concurrently -k -n ganache,dapp -p '[{time}][{name}]' 'yarn ganache:start' 'sleep 5 && static-server test/e2e/contract-test --port 8080'",
    "watch:test:unit": "nodemon --exec \"yarn test:unit\" ./test ./app ./ui",
    "sendwithprivatedapp": "static-server test/e2e/send-eth-with-private-key-test --port 8080",
    "test:unit": "cross-env METAMASK_ENV=test mocha --exit --require test/setup.js --recursive \"test/unit/**/*.js\" \"ui/app/**/*.test.js\"",
    "test:unit:global": "mocha test/unit-global/*",
    "test:single": "cross-env METAMASK_ENV=test mocha --require test/helper.js",
    "test:integration": "yarn test:integration:build && yarn test:flat",
    "test:integration:build": "gulp build:scss",
    "test:e2e:chrome": "SELENIUM_BROWSER=chrome test/e2e/run-all.sh",
    "test:web3:chrome": "SELENIUM_BROWSER=chrome test/e2e/run-web3.sh",
    "test:web3:firefox": "SELENIUM_BROWSER=firefox test/e2e/run-web3.sh",
    "test:e2e:firefox": "SELENIUM_BROWSER=firefox test/e2e/run-all.sh",
    "test:coverage": "nyc --reporter=text --reporter=html npm run test:unit",
    "test:coveralls-upload": "if [ $COVERALLS_REPO_TOKEN ]; then nyc report --reporter=text-lcov | coveralls; fi",
    "test:flat": "yarn test:flat:build && karma start test/flat.conf.js",
    "test:flat:build": "yarn test:flat:build:ui && yarn test:flat:build:tests && yarn test:flat:build:locales",
    "test:flat:build:tests": "node test/integration/index.js",
    "test:flat:build:states": "node development/genStates.js",
    "test:flat:build:locales": "mkdirp dist/chrome && cp -R app/_locales dist/chrome/_locales",
    "test:flat:build:ui": "yarn test:flat:build:states && browserify --transform babelify --transform brfs ./development/mock-dev.js -o ./development/bundle.js",
    "ganache:start": "./development/run-ganache",
    "sentry:publish": "node ./development/sentry-publish.js",
    // lint
    "lint": "eslint . --ext js,json",
    "lint:fix": "eslint . --ext js,json --fix",
    "lint:changed": "{ git ls-files --others --exclude-standard ; git diff-index --name-only --diff-filter=d HEAD ; } | grep --regexp='[.]js$' --regexp='[.]json$' | tr '\\n' '\\0' | xargs -0 eslint",
    "lint:changed:fix": "{ git ls-files --others --exclude-standard ; git diff-index --name-only --diff-filter=d HEAD ; } | grep --regexp='[.]js$' --regexp='[.]json$' | tr '\\n' '\\0' | xargs -0 eslint --fix",
    // 语言文件校验
    "verify-locales": "node ./development/verify-locale-strings.js",
    "mozilla-lint": "addons-linter dist/firefox",
    "watch": "cross-env METAMASK_ENV=test mocha --watch --require test/setup.js --reporter min --recursive \"test/unit/**/*.js\" \"ui/app/**/*.test.js\"",
    "devtools:react": "react-devtools",
    "devtools:redux": "remotedev --hostname=localhost --port=8000",
    // start the React DevTools and Redux DevTools Extension alongside the app
    // 主要用于开发
    "start:dev": "concurrently -k -n build,react,redux yarn:start yarn:devtools:react yarn:devtools:redux",
    "announce": "node development/announcer.js",
    "version:bump": "node development/run-version-bump.js",
    // 这里 storybook 启动有点问题
    // 需要 yarn add -D @storybook/addon-actions babel-loader 
    // 然后改造 .storybook/webpack.config.js ，增加 css rule，要不会报错
    "storybook": "start-storybook -p 6006 -c .storybook",
    "update-changelog": "./development/auto-changelog.sh",
    "rollback": "./development/rollback.sh"
  },
  "resolutions": {
    "3box/ipfs/ipld-zcash/zcash-bitcore-lib/lodash": "^4.17.12",
    "pubnub/superagent-proxy": "^2.0.0"
  },
  "dependencies": {
    "3box": "^1.10.2",
    "@babel/runtime": "^7.5.5",
    "@material-ui/core": "1.0.0",
    "@sentry/browser": "^4.1.1",
    "@zxing/library": "^0.8.0",
    "abi-decoder": "^1.2.0",
    "abortcontroller-polyfill": "^1.3.0",
    "asmcrypto.js": "^2.3.2",
    "await-semaphore": "^0.1.1",
    "bignumber.js": "^4.1.0",
    "bip39": "^2.2.0",
    "bluebird": "^3.5.0",
    "bn.js": "^4.11.7",
    "boron": "^0.2.3",
    "browser-passworder": "^2.0.3",
    "browserify-derequire": "^0.9.4",
    "browserify-unibabel": "^3.0.0",
    "c3": "^0.6.7",
    "classnames": "^2.2.5",
    "clone": "^2.1.2",
    "content-hash": "^2.4.4",
    "copy-to-clipboard": "^3.0.8",
    "currency-formatter": "^1.4.2",
    "d3": "^5.7.0",
    "debounce": "1.1.0",
    "debounce-stream": "^2.0.0",
    "deep-extend": "^0.5.1",
    "deep-freeze-strict": "1.1.1",
    "detect-node": "^2.0.3",
    "detectrtc": "^1.3.6",
    "dnode": "^1.2.2",
    "end-of-stream": "^1.1.0",
    "eth-block-tracker": "^4.4.2",
    "eth-contract-metadata": "^1.9.2",
    "eth-ens-namehash": "^2.0.8",
    "eth-json-rpc-errors": "^1.1.0",
    "eth-json-rpc-filters": "^4.1.1",
    "eth-json-rpc-infura": "^4.0.1",
    "eth-json-rpc-middleware": "^4.2.0",
    "eth-keyring-controller": "^5.3.0",
    "eth-ledger-bridge-keyring": "^0.2.0",
    "eth-method-registry": "^1.2.0",
    "eth-phishing-detect": "^1.1.4",
    "eth-query": "^2.1.2",
    "eth-sig-util": "^2.3.0",
    "eth-token-tracker": "^1.1.10",
    "eth-trezor-keyring": "^0.4.0",
    "ethereumjs-abi": "^0.6.4",
    "ethereumjs-tx": "1.3.7",
    "ethereumjs-util": "5.1.0",
    "ethereumjs-wallet": "^0.6.0",
    "etherscan-link": "^1.0.2",
    "ethjs": "^0.4.0",
    "ethjs-contract": "^0.2.3",
    "ethjs-ens": "^2.0.0",
    "ethjs-query": "^0.3.4",
    "extension-port-stream": "^1.0.0",
    "extensionizer": "^1.0.1",
    "fast-json-patch": "^2.0.4",
    "fuse.js": "^3.2.0",
    "gaba": "^1.8.0",
    "human-standard-token-abi": "^2.0.0",
    "jazzicon": "^1.2.0",
    "json-rpc-engine": "^5.1.4",
    "json-rpc-middleware-stream": "^2.1.1",
    "jsonschema": "^1.2.4",
    "lodash.debounce": "^4.0.8",
    "lodash.shuffle": "^4.2.0",
    "loglevel": "^1.4.1",
    "luxon": "^1.8.2",
    "metamask-inpage-provider": "^3.0.0",
    "metamask-logo": "^2.1.4",
    "mkdirp": "^0.5.1",
    "multihashes": "^0.4.12",
    "nonce-tracker": "^1.0.0",
    "number-to-bn": "^1.7.0",
    "obj-multiplex": "^1.0.0",
    "obs-store": "^4.0.3",
    "percentile": "^1.2.0",
    "pify": "^3.0.0",
    "polyfill-crypto.getrandomvalues": "^1.0.0",
    "post-message-stream": "^3.0.0",
    "promise-filter": "^1.1.0",
    "promise-to-callback": "^1.0.0",
    "prop-types": "^15.6.1",
    "pubnub": "4.24.4",
    "pump": "^3.0.0",
    "punycode": "^2.1.1",
    "qrcode-generator": "1.4.1",
    "ramda": "^0.24.1",
    "react": "^15.6.2",
    "react-dnd": "^3.0.2",
    "react-dnd-html5-backend": "^7.4.4",
    "react-dom": "^15.6.2",
    "react-hyperscript": "^3.0.0",
    "react-idle-timer": "^4.2.5",
    "react-inspector": "^2.3.0",
    "react-media": "^1.8.0",
    "react-redux": "^5.0.5",
    "react-router-dom": "^4.2.2",
    "react-select": "^1.0.0",
    "react-simple-file-input": "^2.0.0",
    "react-tippy": "^1.2.2",
    "react-toggle-button": "^2.2.0",
    "react-tooltip-component": "^0.3.0",
    "react-transition-group": "^1.2.1",
    "react-trigger-change": "^1.0.2",
    "reactify": "^1.1.1",
    "readable-stream": "^2.3.3",
    "recompose": "^0.25.0",
    "redux": "^3.0.5",
    "redux-logger": "^3.0.6",
    "redux-thunk": "^2.2.0",
    "request-promise": "^4.2.1",
    "reselect": "^3.0.1",
    "safe-event-emitter": "^1.0.1",
    "single-call-balance-checker-abi": "^1.0.0",
    "string.prototype.matchall": "^3.0.1",
    "swappable-obj-proxy": "^1.1.0",
    "textarea-caret": "^3.0.1",
    "valid-url": "^1.0.9",
    "web3": "^0.20.7",
    "web3-stream-provider": "^4.0.0",
    "webrtc-adapter": "^6.3.0",
    "xtend": "^4.0.1"
  },
  "devDependencies": {
    "@babel/core": "^7.5.5",
    "@babel/plugin-proposal-class-properties": "^7.5.5",
    "@babel/plugin-proposal-object-rest-spread": "^7.5.5",
    "@babel/plugin-transform-runtime": "^7.5.5",
    "@babel/preset-env": "^7.5.5",
    "@babel/preset-react": "^7.0.0",
    "@babel/register": "^7.5.5",
    "@sentry/cli": "^1.30.3",
    "@storybook/addon-info": "^5.1.1",
    "@storybook/addon-knobs": "^3.4.2",
    "@storybook/react": "^5.1.1",
    "addons-linter": "1.14.0",
    "babel-eslint": "^10.0.2",
    "babelify": "^10.0.0",
    "brfs": "^1.6.1",
    "browserify": "^16.2.3",
    "browserify-transform-tools": "^1.7.0",
    "chai": "^4.1.0",
    "chromedriver": "^2.41.0",
    "concurrently": "^4.1.1",
    "coveralls": "^3.0.0",
    "cross-env": "^5.1.4",
    "css-loader": "^2.1.1",
    "del": "^3.0.0",
    "deps-dump": "^1.1.0",
    "envify": "^4.0.0",
    "enzyme": "^3.4.4",
    "enzyme-adapter-react-15": "^1.0.6",
    "eslint": "^6.0.1",
    "eslint-plugin-chai": "0.0.1",
    "eslint-plugin-json": "^1.2.0",
    "eslint-plugin-mocha": "^5.0.0",
    "eslint-plugin-react": "^7.4.0",
    "fetch-mock": "^6.5.2",
    "file-loader": "^1.1.11",
    "fs-extra": "^6.0.1",
    "fs-promise": "^2.0.3",
    "ganache-cli": "^6.4.4",
    "ganache-core": "2.8.0",
    "geckodriver": "^1.16.2",
    "gh-pages": "^1.2.0",
    "gulp": "^4.0.0",
    "gulp-autoprefixer": "^5.0.0",
    "gulp-babel": "^7.0.0",
    "gulp-debug": "^3.2.0",
    "gulp-eslint": "^4.0.0",
    "gulp-imagemin": "^6.1.0",
    "gulp-json-editor": "^2.2.1",
    "gulp-livereload": "4.0.0",
    "gulp-multi-process": "^1.3.1",
    "gulp-rename": "^1.4.0",
    "gulp-replace": "^0.6.1",
    "gulp-rtlcss": "^1.4.0",
    "gulp-sass": "^4.0.0",
    "gulp-sourcemaps": "^2.6.0",
    "gulp-stylelint": "^7.0.0",
    "gulp-terser-js": "^5.0.0",
    "gulp-util": "^3.0.7",
    "gulp-watch": "^5.0.1",
    "gulp-zip": "^4.0.0",
    "http-server": "^0.11.1",
    "isomorphic-fetch": "^2.2.1",
    "jsdoc": "^3.6.2",
    "jsdom": "^11.2.0",
    "jsdom-global": "^3.0.2",
    "karma": "^4.1.0",
    "karma-chrome-launcher": "^2.2.0",
    "karma-cli": "^1.0.1",
    "karma-firefox-launcher": "^1.0.1",
    "karma-qunit": "^1.2.1",
    "lodash.assign": "^4.0.6",
    "mocha": "^5.0.0",
    "mocha-eslint": "^4.0.0",
    "mocha-jsdom": "^1.1.0",
    "mocha-sinon": "^2.0.0",
    "nock": "^9.0.14",
    "node-sass": "^4.12.0",
    "nyc": "^13.0.0",
    "path": "^0.12.7",
    "prepend-file": "^1.3.1",
    "proxyquire": "2.0.1",
    "qs": "^6.2.0",
    "qunitjs": "^2.4.1",
    "radgrad-jsdoc-template": "^1.1.3",
    "react-devtools": "^3.6.1",
    "react-test-renderer": "^15.6.2",
    "read-installed": "^4.0.3",
    "redux-mock-store": "^1.5.3",
    "redux-test-utils": "^0.2.2",
    "remote-redux-devtools": "^0.5.16",
    "remotedev-server": "^0.3.1",
    "resolve-url-loader": "^2.3.0",
    "rimraf": "^2.6.2",
    "sass-loader": "^7.0.1",
    "selenium-webdriver": "^3.5.0",
    "sesify": "^4.2.1",
    "sesify-viz": "^3.0.5",
    "sinon": "^5.0.0",
    "source-map": "^0.7.2",
    "source-map-explorer": "^2.0.1",
    "static-server": "^2.2.1",
    "style-loader": "^0.21.0",
    "stylelint": "^9.10.1",
    "stylelint-config-standard": "^18.2.0",
    "testem": "^2.16.0",
    "through2": "^2.0.3",
    "vinyl-buffer": "^1.0.1",
    "vinyl-source-stream": "^2.0.0",
    "watchify": "^3.11.1"
  },
  "engines": {
    // 注意：Node 和 Yarn 版本
    "node": "^10.16.0",
    "yarn": "^1.16.0"
  }
}
   ]]>
    </c:sourceContent>

    <c:sourceContent type="html" title="" id="sourceContent1"
                     titleStyle="padding-left:0;color:green;font-size:1em;background-color:white;font-size:1.2em;"
                     bodyStyle="background-color:white;padding:0;font-size:0.85em;line-height:1em;font-family:monospace;">
      <![CDATA[
<h2 style="font-size: 1.625em;margin-top:.625em;padding-bottom: 0;">&diams; 构建相关</h2>
<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>@babel/runtime</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">babel 相关</p>

<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>browserify-derequire</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">
Browserify plugin for renaming require() calls in the output bundle. <br />
<a href="https://github.com/rse/browserify-derequire">https://github.com/rse/browserify-derequire</a>
</p>


<h2 style="font-size: 1.625em;margin-top:.625em;padding-bottom: 0;">&diams; 日志相关</h2>
<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>@sentry/browser</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">Sentry SDK for Browsers  错误记录 <br />
<a href="https://sentry.io">https://sentry.io</a> <br />
<a href="https://github.com/getsentry/sentry-javascript">https://github.com/getsentry/sentry-javascript</a>
</p>

<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>loglevel</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">Minimal lightweight logging for JavaScript, adding reliable log level methods to wrap any available console.log methods <br />
<a href="https://github.com/pimterry/loglevel">https://github.com/pimterry/loglevel</a>
</p>


<h2 style="font-size: 1.625em;margin-top:.625em;padding-bottom: 0;">&diams; 二维码</h2>
<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>@zxing/library</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">1/2维码库 <br />
<a href="https://github.com/zxing-js/library">https://github.com/zxing-js/library</a>
</p>

<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>qrcode-generator</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">QR Code Generator implementation in JavaScript, Java and more.<br />
<a href="https://github.com/kazuhikoarase/qrcode-generator">https://github.com/kazuhikoarase/qrcode-generator</a>
</p>


<h2 style="font-size: 1.625em;margin-top:.625em;padding-bottom: 0;">&diams; 加密相关</h2>
<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>asmcrypto.js</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">JavaScript Cryptographic Library 性能比较好<br />
<a href="https://github.com/asmcrypto/asmcrypto.js">https://github.com/asmcrypto/asmcrypto.js</a>
</p>

<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>await-semaphore</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">Awaitable semaphore/mutex js 信号量控制实现<br />
<a href="https://github.com/notenoughneon/await-semaphore">https://github.com/notenoughneon/await-semaphore</a>
</p>

<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>browser-passworder</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">A simple browserifiable module for encrypting and decrypting JSON-serializable objects with a password. AES-GCM algorithm: <br />
<a href="https://github.com/danfinlay/browser-passworder">https://github.com/danfinlay/browser-passworder</a>
</p>

<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>multihashes</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">multihash implementation in JavaScript 同样的 hash，不同的算法生成，为未来扩展<br />
<a href="https://github.com/multiformats/js-multihash">https://github.com/multiformats/js-multihash</a>
</p>


<h2 style="font-size: 1.625em;margin-top:.625em;padding-bottom: 0;">&diams; 大数处理</h2>
<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>bignumber.js</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">A JavaScript library for arbitrary-precision decimal and non-decimal arithmetic
高精度数字处理，注意数字格式 Number, String or BigNumber<br />
<a href="https://github.com/MikeMcl/bignumber.js">https://github.com/MikeMcl/bignumber.js</a>
</p>

<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>bn.js</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">BigNum in pure javascript 处理大数的计算<br />
<a href="https://github.com/indutny/bn.js">https://github.com/indutny/bn.js</a>
</p>

<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>number-to-bn</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">Converts a number to a BN.js object, throw if invalid number.<br />
<a href="https://github.com/SilentCicero/number-to-bn">https://github.com/SilentCicero/number-to-bn</a>
</p>


<h2 style="font-size: 1.625em;margin-top:.625em;padding-bottom: 0;">&diams; bluebird 相关</h2>
<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>bluebird</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">full featured promise library with unmatched performance<br />
<a href="https://github.com/petkaantonov/bluebird">https://github.com/petkaantonov/bluebird</a>
</p>

<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>request-promise</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">The simplified HTTP request client 'request' with Promise support. Powered by Bluebird.<br />
<a href="https://github.com/request/request-promise">https://github.com/request/request-promise</a>
</p>

<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>promise-filter</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">Filter an array and return a Promise 和 bluebird.filter 一样<br />
<a href="https://github.com/yoshuawuyts/promise-filter">https://github.com/yoshuawuyts/promise-filter</a>
</p>


<h2 style="font-size: 1.625em;margin-top:.625em;padding-bottom: 0;">&diams; JS基础功能增强</h2>
<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>clone</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">deeply clone arbitrary objects in javascript<br />
<a href="https://github.com/pvorb/clone">https://github.com/pvorb/clone</a>
</p>

<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>debounce</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">防抖的一个实现<br />
<a href="https://github.com/component/debounce">https://github.com/component/debounce</a>
</p>

<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>debounce-stream</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">Debounces a stream. 用户输入流去抖<br />
<a href="https://github.com/fardog/debounce-stream">https://github.com/fardog/debounce-stream</a>
</p>

<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>deep-extend</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">Recursive extend module 递归扩展 obj 属性<br />
<a href="https://github.com/unclechu/node-deep-extend">https://github.com/unclechu/node-deep-extend</a>

<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>deep-freeze-strict</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">recursively Object.freeze() on objects and functions<br />
<a href="https://github.com/jsdf/deep-freeze">https://github.com/jsdf/deep-freeze</a>

<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>lodash.debounce</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">The lodash method _.debounce<br />
<a href="https://github.com/lodash/lodash">https://github.com/lodash/lodash</a>

<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>lodash.shuffle</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">The lodash method _.shuffle<br />
<a href="https://github.com/lodash/lodash">https://github.com/lodash/lodash</a>

<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>xtend</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">xtend is a basic utility library which allows you to extend an object by appending all of the properties from each object in a list.<br />
<a href="https://github.com/Raynos/xtend">https://github.com/Raynos/xtend</a>
</p>


<h2 style="font-size: 1.625em;margin-top:.625em;padding-bottom: 0;">&diams; JSON增强</h2>
<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>fast-json-patch</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">Lean and mean Javascript implementation of the JSON-Patch standard (RFC 6902). Update JSON documents using delta patches.<br />
<a href="https://github.com/Starcounter-Jack/JSON-Patch">https://github.com/Starcounter-Jack/JSON-Patch</a>
</p>

<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>jsonschema</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">JSON Schema validation 校验 json 文档<br />
<a href="https://github.com/tdegrunt/jsonschema">https://github.com/tdegrunt/jsonschema</a>
</p>


<h2 style="font-size: 1.625em;margin-top:.625em;padding-bottom: 0;">&diams; RPC相关</h2>
<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>dnode</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">turtles all the way down rpc RPC调用<br />
<a href="https://github.com/substack/dnode">https://github.com/substack/dnode</a>
</p>

<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>json-rpc-engine -- metamask 自有库</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">a tool for processing JSON RPC<br />
<a href="https://github.com/MetaMask/json-rpc-engine">https://github.com/MetaMask/json-rpc-engine</a>
</p>

<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>json-rpc-middleware-stream -- metamask 自有库</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">A small toolset for streaming json rpc and matching requests and responses. Made to be used with json-rpc-engine.
metamask 封装了很多 stream 操作<br />
<a href="https://github.com/MetaMask/json-rpc-middleware-stream">https://github.com/MetaMask/json-rpc-middleware-stream</a>
</p>


<h2 style="font-size: 1.625em;margin-top:.625em;padding-bottom: 0;">&diams; Shim / polyfill</h2>
<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>abortcontroller-polyfill</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">Polyfill for the AbortController DOM API and abortable fetch 中止fetch<br />
<a href="https://github.com/mo/abortcontroller-polyfill">https://github.com/mo/abortcontroller-polyfill</a>
</p>

<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>polyfill-crypto.getrandomvalues</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">This is a polyfill for window.crypto.getRandomValues() .<br />
<a href="https://github.com/kumavis/polyfill-crypto.getrandomvalues">https://github.com/kumavis/polyfill-crypto.getrandomvalues</a>
</p>

<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>string.prototype.matchall</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">Spec-compliant polyfill for String.prototype.matchAll ESnext proposal.<br />
<a href="https://github.com/ljharb/String.prototype.matchAll">https://github.com/ljharb/String.prototype.matchAll</a>
</p>


<h2 style="font-size: 1.625em;margin-top:.625em;padding-bottom: 0;">&diams; WebRTC</h2>
<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>detectrtc</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">detect WebRTC features e.g. system having speakers, microphone or webcam, screen capturing is supported, number of audio/video devices etc.<br />
<a href="https://github.com/muaz-khan/DetectRTC">https://github.com/muaz-khan/DetectRTC</a>
</p>

<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>webrtc-adapter</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">adapter.js is a shim to insulate apps from spec changes and prefix differences.<br />
<a href="https://github.com/webrtchacks/adapter">https://github.com/webrtchacks/adapter</a>
</p>

<h2 style="font-size: 1.625em;margin-top:.625em;padding-bottom: 0;">&diams; Stream 相关</h2>
<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>end-of-stream</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">A node module that calls a callback when a readable/writable/duplex stream has completed or failed.<br />
<a href="https://github.com/mafintosh/end-of-stream">https://github.com/mafintosh/end-of-stream</a>
</p>
<pre style="background-color:darkblue;color:cadetblue;padding:.625em 1em;margin-top:.325em;">
// Usage
var eos = require('end-of-stream');

eos(readableStream, function(err) {
  // this will be set to the stream instance
  if (err) return console.log('stream had an error or closed early');
  console.log('stream has ended', this === readableStream);
});

eos(writableStream, function(err) {
  if (err) return console.log('stream had an error or closed early');
  console.log('stream has finished', this === writableStream);
});

eos(duplexStream, function(err) {
  if (err) return console.log('stream had an error or closed early');
  console.log('stream has ended and finished', this === duplexStream);
});

eos(duplexStream, {readable:false}, function(err) {
  if (err) return console.log('stream had an error or closed early');
  console.log('stream has finished but might still be readable');
});

eos(duplexStream, {writable:false}, function(err) {
  if (err) return console.log('stream had an error or closed early');
  console.log('stream has ended but might still be writable');
});

eos(readableStream, {error:false}, function(err) {
  // do not treat emit('error', err) as a end-of-stream
});
</pre>

<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>extension-port-stream -- metamask 自有库</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">A module for creating a node style stream over a WebExtension port object.<br />
<a href="https://github.com/MetaMask/extension-port-stream">https://github.com/MetaMask/extension-port-stream</a>
</p>

<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>obj-multiplex</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">simple stream multiplexing for objectMode  多路复用<br />
其实就是一个多路复用流能够使用name来区分各个子流，以达到一个parent流下其实有多个子流在运行，可以通过多个子流来读入写出数据，效率更高。而且parent流结束了，则所有子流也会被销毁<br />
<a href="https://github.com/kumavis/obj-multiplex">https://github.com/kumavis/obj-multiplex</a><br />
<a href="https://github.com/zoubin/streamify-your-node-program/blob/master/docs/objectMode.md">https://github.com/zoubin/streamify-your-node-program/blob/master/docs/objectMode.md</a>
</p>
<pre style="background-color:darkblue;color:cadetblue;padding:.625em 1em;margin-top:.325em;">
// usage
// create multiplexer
const mux = new ObjMultiplex()

// setup substreams
const streamA = mux.createStream('hello')
const streamB = mux.createStream('world')

// pipe over transport (and back)
mux.pipe(transport).pipe(mux)

// send values over the substreams
streamA.write({ thisIsAn: 'object' })
streamA.write(123)

// or pipe together normally
streamB.pipe(evilAiBrain).pipe(streamB)
</pre>

<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>pump</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">pipe streams together and close all of them if one of them closes<br />
<a href="https://github.com/mafintosh/pump">https://github.com/mafintosh/pump</a>
</p>

<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>readable-stream</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">Node-core streams for userland<br />
<a href="https://github.com/nodejs/readable-stream">https://github.com/nodejs/readable-stream</a>
</p>


<h2 style="font-size: 1.625em;margin-top:.625em;padding-bottom: 0;">&diams; 其他工具库</h2>
<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>copy-to-clipboard</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">Copy stuff into clipboard from your browser using JS<br />
<a href="https://github.com/nodejs/readable-stream">https://github.com/sudodoki/copy-to-clipboard</a>
</p>

<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>currency-formatter</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">A simple Javascript utility that helps you to display currency properly<br />
<a href="https://github.com/nodejs/readable-stream">https://github.com/smirzaei/currency-formatter</a>
</p>

<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>detect-node</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">Detect Node.JS 就是看看有没有定义process属性<br />
<a href="https://github.com/nodejs/readable-stream">https://github.com/iliakan/detect-node</a>
</p>

<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>extensionizer -- metamask 自有库</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">A JS module for writing cross-browser extensions.
把各浏览器的一些隐藏 API 实现暴露出来<br />
<a href="https://github.com/nodejs/readable-stream">https://github.com/MetaMask/extensionizer</a>
</p>

<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>fuse.js</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">Lightweight fuzzy-search, in JavaScript https://fusejs.io/<br />
<a href="https://github.com/nodejs/readable-stream">https://github.com/krisk/Fuse</a>
</p>

<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>browserify-unibabel</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">A simple browserify style version of Unibabel<br />
<a href="https://github.com/nodejs/readable-stream">https://github.com/Daplie/unibabel-js</a>
</p>

<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>luxon</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">A library for working with dates and times in JS moment的一个替代品<br />
<a href="https://github.com/nodejs/readable-stream">https://github.com/moment/luxon</a>
</p>

<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>mkdirp</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">Recursively mkdir, like `mkdir -p`, but in node.js<br />
<a href="https://github.com/nodejs/readable-stream">https://github.com/substack/node-mkdirp</a>
</p>

<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>obs-store -- metamask 自有库</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">ObservableStore is a synchronous in-memory store for a single value, that you can subscribe to updates on.<br />
<a href="https://github.com/nodejs/readable-stream">https://github.com/MetaMask/obs-store</a>
</p>

<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>percentile</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">Calculate percentile for given array of values<br />
<a href="https://github.com/nodejs/readable-stream">https://github.com/d4rkr00t/percentile</a>
</p>

<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>post-message-stream</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">Sets up a duplex object stream over window.postMessage<br />
<a href="https://github.com/nodejs/readable-stream">https://github.com/kumavis/post-message-stream</a>
</p>

<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>pify</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">Promisify a callback-style function<br />
<a href="https://github.com/nodejs/readable-stream">https://github.com/sindresorhus/pify</a>
</p>

<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>promise-to-callback</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">Convert promise to callback interface 和 pify 相反<br />
<a href="https://github.com/nodejs/readable-stream">https://github.com/stevemao/promise-to-callback</a>
</p>

<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>pubnub</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">PubNub JavaScript SDK https://www.pubnub.com/<br />
<a href="https://github.com/nodejs/readable-stream">https://github.com/pubnub/javascript</a>
</p>

<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>ramda</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">A practical functional library for JavaScript programmers.<br />
<a href="https://github.com/nodejs/readable-stream">https://github.com/ramda/ramda</a>
</p>

<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>safe-event-emitter -- metamask 自有库</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">An EventEmitter that isolates the emitter from errors in handlers. If an error is thrown in a handler it is caught and re-thrown inside of a setTimeout so as to not interupt the emitter's code flow. 
如果在处理程序中抛出错误，就会被捕获并在setTimeout中重新抛出，以便不会中断发射器的代码流<br />
<a href="https://github.com/MetaMask/safe-event-emitter">https://github.com/MetaMask/safe-event-emitter</a>
</p>
<pre style="background-color:darkblue;color:cadetblue;padding:.625em 1em;margin-top:.325em;">
// usage
const SafeEventEmitter = require('safe-event-emitter')

const ee = new SafeEventEmitter()
ee.on('boom', () => { throw new Error() })
ee.emit('boom') // no error here

// error is thrown after setTimeout
</pre>
<pre style="background-color:darkblue;color:cadetblue;padding:.625em 1em;margin-top:.325em;">
// 源码分析
const util = require('util')
const EventEmitter = require('events/')

var R = typeof Reflect === 'object' ? Reflect : null
// 定义 ReflectApply，对一个函数进行调用操作 http://es6.ruanyifeng.com/#docs/reflect
var ReflectApply = R && typeof R.apply === 'function'
  ? R.apply
  : function ReflectApply(target, receiver, args) {
    return Function.prototype.apply.call(target, receiver, args);
}

module.exports = SafeEventEmitter


function SafeEventEmitter() {
  EventEmitter.call(this)
}

util.inherits(SafeEventEmitter, EventEmitter)

SafeEventEmitter.prototype.emit = function (type) {
  // copied from https://github.com/Gozala/events/blob/master/events.js
  // modified lines are commented with "edited:"
  var args = [];
  for (var i = 1; i < arguments.length; i++) args.push(arguments[i]);
  var doError = (type === 'error');

  var events = this._events;
  if (events !== undefined)
    doError = (doError && events.error === undefined);
  else if (!doError)
    return false;

  // If there is no 'error' event listener then throw.
  if (doError) {
    var er;
    if (args.length > 0)
      er = args[0];
    if (er instanceof Error) {
      // Note: The comments on the `throw` lines are intentional, they show
      // up in Node's output if this results in an unhandled exception.
      throw er; // Unhandled 'error' event
    }
    // At least give some kind of context to the user
    var err = new Error('Unhandled error.' + (er ? ' (' + er.message + ')' : ''));
    err.context = er;
    throw err; // Unhandled 'error' event
  }

  var handler = events[type];

  if (handler === undefined)
    return false;

  if (typeof handler === 'function') {
    // edited: using safeApply, source: ReflectApply(handler, this, args)
    safeApply(handler, this, args);
  } else {
    var len = handler.length;
    var listeners = arrayClone(handler, len);
    for (var i = 0; i < len; ++i)
      // edited: using safeApply
      safeApply(listeners[i], this, args);
  }

  return true;
}

function safeApply(handler, context, args) {
  try {
    ReflectApply(handler, context, args)
  } catch (err) {
    // throw error after timeout so as not to interupt the stack
    setTimeout(() => {
      throw err
    })
  }
}

function arrayClone(arr, n) {
  var copy = new Array(n);
  for (var i = 0; i < n; ++i)
    copy[i] = arr[i];
  return copy;
}
</pre>

<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>swappable-obj-proxy</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">Creates a Proxy around any object / EventEmitter.<br />
<a href="https://github.com/kumavis/swappable-obj-proxy">https://github.com/kumavis/swappable-obj-proxy</a>
</p>

<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>valid-url</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">Node module that provides URI validation functions<br />
<a href="https://github.com/ogt/valid-url">https://github.com/ogt/valid-url</a>
</p>


<h2 style="font-size: 1.625em;margin-top:.625em;padding-bottom: 0;">&diams; 钱包相关</h2>
<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>bip39</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">JavaScript implementation of Bitcoin BIP39: Mnemonic code for generating deterministic keys<br />
如果对个人隐私比较注重，就需要为每一次交易生成一个新的地址，仅需要记住助记词便可保证拥有对所有地址的操作权。<br />
<a href="https://github.com/bitcoinjs/bip39">https://github.com/bitcoinjs/bip39</a><br />
<a href="https://github.com/bitcoin/bips/blob/master/bip-0039/bip-0039-wordlists.md">https://github.com/bitcoin/bips/blob/master/bip-0039/bip-0039-wordlists.md</a>
</p>

<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>eth-keyring-controller -- metamask 自有库</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">A module for managing groups of Ethereum accounts called "Keyrings", defined originally for MetaMask's multiple-account-type feature.<br />
<a href="https://github.com/MetaMask/KeyringController">https://github.com/MetaMask/KeyringController</a><br />
<a href="https://github.com/MetaMask/eth-simple-keyring">https://github.com/MetaMask/eth-simple-keyring</a>
</p>

<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>eth-ledger-bridge-keyring -- metamask 自有库</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">A javascript wrapper around LedgerJS libraries, to support the KeyringController protocol used by MetaMask<br />
<a href="https://github.com/MetaMask/KeyringController">https://github.com/MetaMask/eth-ledger-bridge-keyring</a>
</p>

<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>eth-sig-util -- metamask 自有库</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">A collection of functions for signing and verifying data with Ethereum keys.<br />
<a href="https://github.com/MetaMask/eth-sig-util">https://github.com/MetaMask/eth-sig-util</a><br />
例子：<a href="https://github.com/danfinlay/js-eth-personal-sign-examples">https://github.com/danfinlay/js-eth-personal-sign-examples</a>
</p>

<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>eth-token-tracker -- metamask 自有库</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">A JS module for tracking Ethereum token balances over block changes. 轮询查余额<br />
<a href="https://github.com/MetaMask/eth-token-tracker">https://github.com/MetaMask/eth-token-tracker</a>
</p>

<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>eth-trezor-keyring -- metamask 自有库</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">A javascript wrapper around Trezor Connect javascript libraries, to support the KeyringController protocol used by MetaMask Trezor硬件钱包<br />
<a href="https://github.com/metamask/eth-trezor-keyring">https://github.com/metamask/eth-trezor-keyring</a>
</p>

<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>ethereumjs-tx</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">A simple module for creating, manipulating and signing ethereum transactions 签名交易, 用于 web3 的 sendRawTransaction<br />
<a href="https://github.com/ethereumjs/ethereumjs-tx">https://github.com/ethereumjs/ethereumjs-tx</a>
</p>

<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>ethereumjs-util</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">A collection of utility functions for Ethereum 一些 eth 用到的工具方法<br />
<a href="https://github.com/ethereumjs/ethereumjs-util">https://github.com/ethereumjs/ethereumjs-util</a>
</p>

<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>ethereumjs-wallet</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">Utilities for handling Ethereum keys 产生和管理公私钥<br />
HD Wallet: var hdkey = require('ethereumjs-wallet/hdkey')<br />
<a href="https://github.com/ethereumjs/ethereumjs-wallet">https://github.com/ethereumjs/ethereumjs-wallet</a>
</p>
<ul style="margin-top:.325em;list-style: disc;margin-left: 1.5em;font-size: 1.5em;line-height: 1.325em;">
  <li>ethereumjs-tx 签名交易</li>
  <li>ethereumjs-util 工具方法</li>
  <li>ethereumjs-wallet 管理公私钥</li>
  <li>web3 发送交易</li>
</ul>

<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>gaba -- metamask 自有库</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">Collection of platform-agnostic modules for creating secure data models for cryptocurrency wallets
<br />
<a href="https://github.com/MetaMask/gaba">https://github.com/MetaMask/gaba</a>
</p>

<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>metamask-inpage-provider</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">An ethereum provider that connects over a stream, as injected into websites by MetaMask.
Used to initialize the inpage ethereum provider injected by MetaMask.<br />
这个库的作用有设置浏览器本地信息存储publicConfig流、构建RpcProvider双向传送json rpc及其结果流，以及对从浏览器中得到的json rpc进行处理，send/sendsync的处理是不同的，然后将他们根据得到的特殊id存储到数组中，等待传送到区块链进行处理。<br />
<a href="https://github.com/MetaMask/metamask-inpage-provider/blob/master/index.js">https://github.com/MetaMask/metamask-inpage-provider/blob/master/index.js</a><br />
<a href="https://github.com/MetaMask/metamask-inpage-provider">metamask 自有库
: https://github.com/MetaMask/metamask-inpage-provider</a>
</p>
<pre style="background-color:darkblue;color:cadetblue;padding:.625em 1em;margin-top:.325em;">
// usage
// Create a stream to a remote provider:
var metamaskStream = new LocalMessageDuplexStream({
  name: 'inpage',
  target: 'contentscript',
})

// compose the inpage provider
var inpageProvider = new MetamaskInpageProvider(metamaskStream)
</pre>

<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>nonce-tracker -- metamask 自有库</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">How metamask calculates nonces<br />
<a href="https://github.com/MetaMask/nonce-tracker">https://github.com/MetaMask/nonce-tracker</a>
</p>


<h2 style="font-size: 1.625em;margin-top:.625em;padding-bottom: 0;">&diams; 合约相关</h2>
<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>abi-decoder</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">Nodejs and Javascript library for decoding data params and events from etherem transactions<br />
<a href="https://github.com/ConsenSys/abi-decoder">https://github.com/ConsenSys/abi-decoder</a>
</p>

<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>eth-contract-metadata -- metamask 自有库</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">A mapping of ethereum contract addresses to broadly accepted icons for those addresses. 合约和图标映射<br />
<a href="https://github.com/MetaMask/eth-contract-metadata">https://github.com/MetaMask/eth-contract-metadata</a>
</p>

<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>eth-method-registry -- metamask 自有库</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">A javascript library for getting Solidity method data from a four-byte method signature.<br />
<a href="https://github.com/MetaMask/nonce-tracker">https://github.com/MetaMask/eth-method-registry</a>
</p>

<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>eth-query</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">minimal rpc wrapper<br />
<a href="https://github.com/ethereumjs/eth-query">https://github.com/ethereumjs/eth-query</a>
</p>

<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>ethereumjs-abi</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">Decoder and encoder for the Ethereum ABI<br />
<a href="https://github.com/ethereumjs/ethereumjs-abi">https://github.com/ethereumjs/ethereumjs-abi</a>
</p>
<div>
  <img src="/images/ether/1576745460249-8e0eaa4a-0392-4e50-8f67-654577204111.png" />
</div>

<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>ethjs-contract</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">A simple contract object for the Ethereum RPC layer.<br />
<a href="https://github.com/ethjs/ethjs-contract">https://github.com/ethjs/ethjs-contract</a>
</p>

<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>human-standard-token-abi</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">A JSON ABI for the Ethereum ERC 20 Token Standard , ERC 20 Token 的 abi<br />
<a href="https://github.com/danfinlay/human-standard-token-abi">https://github.com/danfinlay/human-standard-token-abi</a>
</p>

<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>single-call-balance-checker-abi</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">A simple node module that exports the [Ethereum ABI] for eth-balance-checker smart contract<br />
<a href="https://etherscan.io/address/0xb1f8e55c7f64d203c1400b9d8555d050f94adf39#code">https://etherscan.io/address/0xb1f8e55c7f64d203c1400b9d8555d050f94adf39#code</a>
</p>


<h2 style="font-size: 1.625em;margin-top:.625em;padding-bottom: 0;">&diams; RPC相关</h2>
<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>eth-block-tracker</b> -- metamask 自有库</h3>
<p style="font-size: 1.325em;line-height: 1.625em;">A JS module for keeping track of the latest Ethereum block by polling an ethereum provider.<br />
<a href="https://github.com/MetaMask/eth-block-tracker">https://github.com/MetaMask/eth-block-tracker</a>
</p>

<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>eth-json-rpc-errors</b> -- metamask 自有库</h3>
<p style="font-size: 1.325em;line-height: 1.625em;">Errors for JSON RPC 2.0 and ETH JSON RPC.<br />
<a href="https://github.com/MetaMask/eth-json-rpc-errors">https://github.com/MetaMask/eth-json-rpc-errors</a>
</p>

<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>eth-json-rpc-filters</b> -- metamask 自有库</h3>
<p style="font-size: 1.325em;line-height: 1.625em;">json-rpc-engine middleware implementing ethereum filter methods eth的过滤器实现，接收事件通知<br />
<a href="https://github.com/MetaMask/eth-json-rpc-filters">https://github.com/MetaMask/eth-json-rpc-filters</a>
</p>

<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>eth-json-rpc-infura</b> -- metamask 自有库</h3>
<p style="font-size: 1.325em;line-height: 1.625em;">json-rpc-engine middleware for infura's REST endpoints.
metamask 利用 infura 的节点来广播交易<br />
https://infura.io/ infura 用于 dApp 快速接入以太坊<br />
<a href="https://github.com/MetaMask/eth-json-rpc-infura">https://github.com/MetaMask/eth-json-rpc-infura</a>
</p>

<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>eth-json-rpc-middleware</b> -- metamask 自有库</h3>
<p style="font-size: 1.325em;line-height: 1.625em;">Ethereum middleware for composing an ethereum provider using json-rpc-engine. Intended to replace provider-engine.<br />
<a href="https://github.com/MetaMask/eth-json-rpc-middleware">https://github.com/MetaMask/eth-json-rpc-middleware</a>
</p>

<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>ethjs</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">A highly optimised, light-weight JS utility for Ethereum.
web3 的一个替代品，还有个类似的是 ethers.js<br />
<a href="https://github.com/ethjs/ethjs">https://github.com/ethjs/ethjs</a>
</p>

<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>ethjs-query</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">A simple query module for the Ethereum RPC.<br />
<a href="https://github.com/ethjs/ethjs-query">https://github.com/ethjs/ethjs-query</a>
</p>

<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>web3</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">Ethereum JavaScript API
metamask 用的是 0.20.7 版本，未来有改进计划<br />
<a href="https://github.com/ethereum/web3.js">https://github.com/ethereum/web3.js</a>
</p>

<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>web3-stream-provider</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">creates an Ethereum web3 provider that forwards payloads through a stream<br />
<a href="https://github.com/kumavis/web3-stream-provider">https://github.com/kumavis/web3-stream-provider</a>
</p>


<h2 style="font-size: 1.625em;margin-top:.625em;padding-bottom: 0;">&diams; ENS相关</h2>
<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>content-hash</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">simple tool to encode/decode content hash for EIP 1577 compliant ENS Resolvers<br />
参考：https://learnblockchain.cn/docs/ens/contract-api-reference/publicresolver.html#%E8%8E%B7%E5%8F%96%E5%86%85%E5%AE%B9%E6%95%A3%E5%88%97<br />
<a href="https://github.com/pldespaigne/content-hash">https://github.com/pldespaigne/content-hash</a>
</p>

<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>eth-ens-namehash</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">A javascript library for generating Ethereum Name Service (ENS) namehashes per spec.<br />
<a href="https://github.com/danfinlay/eth-ens-namehash">https://github.com/danfinlay/eth-ens-namehash</a>
</p>

<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>ethjs-ens</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">An Ethereum Name Service interface module built on EthJS<br />
<a href="https://github.com/ethjs/ethjs-ens">https://github.com/ethjs/ethjs-ens</a>
</p>


<h2 style="font-size: 1.625em;margin-top:.625em;padding-bottom: 0;">&diams; 其他</h2>
<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>3box</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">set, get, and remove private and public data associated with an ethereum account<br />
<a href="https://github.com/3box/3box-js">https://github.com/3box/3box-js</a>
</p>

<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>eth-phishing-detect</b> -- metamask 自有库</h3>
<p style="font-size: 1.325em;line-height: 1.625em;">Utility for detecting phishing domains targeting Ethereum users 钓鱼网站检测<br />
<a href="https://github.com/MetaMask/eth-phishing-detect">https://github.com/MetaMask/eth-phishing-detect</a>
</p>

<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>etherscan-link</b> -- metamask 自有库</h3>
<p style="font-size: 1.325em;line-height: 1.625em;">A library for generating etherscan links.<br />
<a href="https://github.com/MetaMask/etherscan-link">https://github.com/MetaMask/etherscan-link</a>
</p>

<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>metamask-logo</b> -- metamask 自有库</h3>
<p style="font-size: 1.325em;line-height: 1.625em;">A 3d take on the metamask logo, in browser, as a browserifyable module.<br />
<a href="https://github.com/MetaMask/metamask-logo">https://github.com/MetaMask/metamask-logo</a>
</p>


<h2 style="font-size: 1.625em;margin-top:.625em;padding-bottom: 0;">&diams; 通用UI库</h2>
<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>@material-ui/core</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">React components that implement Google's Material Design.<br />
<a href="https://github.com/mui-org/material-ui">https://github.com/mui-org/material-ui</a>
</p>

<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>d3</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">Bring data to life with SVG, Canvas and HTML. https://d3js.org<br />
<a href="https://github.com/d3/d3">https://github.com/d3/d3</a>
</p>

<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>c3</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">A D3-based reusable chart library. http://c3js.org<br />
<a href="https://github.com/c3js/c3">https://github.com/c3js/c3</a>
</p>

<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>jazzicon</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">Jazzy deterministic identicons for a more entertaining future. 生成五颜六色头像图标<br />
<a href="https://github.com/flyswatter/jazzicon">https://github.com/flyswatter/jazzicon</a>
</p>

<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>textarea-caret</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">xy coordinates of a textarea or input's caret<br />
<a href="https://github.com/component/textarea-caret-position">https://github.com/component/textarea-caret-position</a>
</p>


<h2 style="font-size: 1.625em;margin-top:.625em;padding-bottom: 0;">&diams; React 相关</h2>
<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>react</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">
<a href="https://github.com/facebook/react">https://github.com/facebook/react</a>
</p>

<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>react-dom</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">This package serves as the entry point to the DOM and server renderers for React.</p>

<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>classnames</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">A simple javascript utility for conditionally joining classNames together<br />
<a href="https://github.com/JedWatson/classnames">https://github.com/JedWatson/classnames</a>
</p>

<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>prop-types</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">Runtime type checking for React props and similar objects<br />
<a href="https://github.com/facebook/prop-types">https://github.com/facebook/prop-types</a>
</p>

<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>react-hyperscript</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">Hyperscript syntax for React.js markup. <br />
<a href="https://github.com/mlmorg/react-hyperscript">https://github.com/mlmorg/react-hyperscript</a>
</p>

<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>react-idle-timer</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">User activity timer component 检测用户是否发呆<br />
<a href="https://github.com/supremetechnopriest/react-idle-timer">https://github.com/supremetechnopriest/react-idle-timer</a>
</p>

<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>react-inspector</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">Power of Browser DevTools inspectors right inside your React app<br />
<a href="https://github.com/xyc/react-inspector">https://github.com/xyc/react-inspector</a>
</p>

<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>react-media</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">CSS media queries for React<br />
<a href="https://github.com/ReactTraining/react-media">https://github.com/ReactTraining/react-media</a>
</p>

<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>react-router-dom</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">Declarative routing for React<br />
<a href="https://github.com/ReactTraining/react-router">https://github.com/ReactTraining/react-router</a>
</p>

<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>react-trigger-change</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">Trigger React's synthetic change events on input, textarea and select elements 主要用来测试<br />
<a href="https://github.com/vitalyq/react-trigger-change">https://github.com/vitalyq/react-trigger-change</a>
</p>

<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>reactify [DEPRECATED]</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">[DEPRECATED] Browserify transform for JSX (superset of JavaScript used in React library by Facebook)<br />
<a href="https://github.com/andreypopp/reactify">https://github.com/andreypopp/reactify</a>
</p>

<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>recompose</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">A React utility belt for function components and higher-order components.
react 的 lodash<br />
<a href="https://github.com/acdlite/recompose">https://github.com/acdlite/recompose</a>
</p>


<h2 style="font-size: 1.625em;margin-top:.625em;padding-bottom: 0;">&diams; React UI 组件</h2>
<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>boron</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">A collection of dialog animations with React.js<br />
<a href="https://github.com/yuanyan/boron">https://github.com/yuanyan/boron</a>
</p>


<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>react-dnd</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">Drag and Drop for React  <br />
<a href="https://github.com/react-dnd/react-dnd">https://github.com/react-dnd/react-dnd</a>
</p>

<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>react-dnd-html5-backend</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">The officially supported HTML5 backend for React DnD.</p>

<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>react-select</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">The Select Component for React.js https://react-select.com/home<br />
<a href="https://github.com/JedWatson/react-select">https://github.com/JedWatson/react-select</a>
</p>

<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>react-simple-file-input</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">Simple wrapper for the HTML input tag and HTML5 FileReader API<br />
<a href="https://github.com/greena13/react-simple-file-input">https://github.com/greena13/react-simple-file-input</a>
</p>

<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>react-tippy</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">A lightweight tooltip for React.<br />
<a href="https://github.com/tvkhoa/react-tippy">https://github.com/tvkhoa/react-tippy</a>
</p>

<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>react-toggle-button</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">It's a toggle button<br />
<a href="https://github.com/gdowens/react-toggle-button">https://github.com/gdowens/react-toggle-button</a>
</p>

<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>react-tooltip-component</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">React tooltip component.<br />
<a href="https://github.com/minhtranite/react-tooltip-component">https://github.com/minhtranite/react-tooltip-component</a>
</p>

<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>react-transition-group</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">An easy way to perform animations when a React component enters or leaves the DOM<br />
<a href="https://github.com/reactjs/react-transition-group">https://github.com/reactjs/react-transition-group</a>
</p>


<h2 style="font-size: 1.625em;margin-top:.625em;padding-bottom: 0;">&diams; Redux相关</h2>
<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>react-redux</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">Official React bindings for Redux<br />
<a href="https://github.com/reduxjs/react-redux">https://github.com/reduxjs/react-redux</a>
</p>

<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>redux</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">Predictable state container for JavaScript apps<br />
<a href="https://github.com/reduxjs/redux">https://github.com/reduxjs/redux</a>
</p>

<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>redux-logger</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">Logger for Redux<br />
<a href="https://github.com/LogRocket/redux-logger">https://github.com/LogRocket/redux-logger</a>
</p>

<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>redux-thunk</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">Thunk middleware for Redux<br />
<a href="https://github.com/reduxjs/redux-thunk">https://github.com/reduxjs/redux-thunk</a>
</p>

<h3 style="font-size: 1.325em;padding-bottom: 0;color: brown;"><b>reselect</b></h3>
<p style="font-size: 1.325em;line-height: 1.625em;">Selector library for Redux<br />
<a href="https://github.com/reduxjs/reselect">https://github.com/reduxjs/reselect</a>
</p>


<h2 style="font-size: 1.625em;margin-top:.625em;padding-bottom: 0;">&diams; ETH测试</h2>
<p style="font-size: 1.325em;line-height: 1.625em;">ganache-cli: <a href="https://www.trufflesuite.com/ganache">https://www.trufflesuite.com/ganache</a> Ganache 是一个为开发者提供的私有 Ethereum 区块链客户端, 可以用于本地部署, 开发, 测试应用程序, 测试代码.
ganache-core
</p>


<h2 style="font-size: 1.625em;margin-top:.625em;padding-bottom: 0;">&diams; 增强</h2>
<p style="font-size: 1.325em;line-height: 1.625em;">
<b>fs-extra:</b> fs-extra adds file system methods that aren't included in the native fs module and adds promise support to the fs methods.<br />
<b>fs-promise[DEPRECATED]</b> <br />
<b>lodash.assign:</b> The lodash method _.assign exported as a Node.js module.<br />
<b>path:</b> This is an exact copy of the NodeJS ’path’ module published to the NPM registry.<br />
<b>prepend-file:</b> Prepend data to a file, creating the file if it not yet exists.<br />
<b>qs:</b> A querystring parsing and stringifying library with some added security.
</p>


<h2 style="font-size: 1.625em;margin-top:.625em;padding-bottom: 0;">&diams; 其他</h2>
<p style="font-size: 1.325em;line-height: 1.625em;">
<b>@sentry/cli</b><br />
<b>gh-pages:</b> Publish files to a gh-pages branch on GitHub<br />
<b>http-server:</b> a command-line http server<br />
<b>jsdoc:</b> An API documentation generator for JavaScript.<br />
<b>radgrad-jsdoc-template:</b> A Semantic UI documentation template theme for JSDoc 3.<br />
<b>read-installed:</b> Read all the installed packages in a folder, and return a tree structure with all the data.<br />
<b>source-map</b><br />
<b>source-map-explorer</b><br />
<b>static-server:</b> A simple http server to serve static resource files from a local directory.
</p>
   ]]>
    </c:sourceContent>
    <c:comment>
      <c:comment1>
        <![CDATA[]]>
      </c:comment1>
    </c:comment>
  </c:entry>


  <c:entry style="margin-top:1em;">
    <c:title id="3box"><![CDATA[<div style="color:blue;font-size:1.625em;">3box</div>]]></c:title>
    <c:desc>
      <c:desc1> <![CDATA[
<div style="margin-bottom:.425em;font-size:1.425em;">
  https://github.com/3box/3box-js
</div>
]]></c:desc1>
    </c:desc>
    <c:sourceContent type="html" title="" id="sourceContent1"
                     titleStyle="padding-left:0;color:green;font-size:1em;background-color:white;font-size:1.2em;"
                     bodyStyle="background-color:white;padding:0;font-size:1em;line-height:1.625em;font-family:monospace;">
      <![CDATA[
<div style="margin-bottom:.425em;">
  3box 可让您设置，获取和删除与以太坊账户相关的私人和公共数据。使用启用了Web3的浏览器的dapp可以使用它存储身份数据，用户设置等。只要用户可以访问已使用的以太坊账户的私钥，就可以检索数据。数据已加密，未经用户授权的任何第三方都无法读取。默认情况下，所有授权的dapp都有一个共享的数据空间，然后dapp必须请求明确同意访问这些空间。
</div>
   ]]>
    </c:sourceContent>
    <c:sourceContent type="" title="" id="sourceContent1"
                     titleStyle="padding-left:0;color:green;font-size:1.425em;background-color:white;margin-top:.25em;font-size:1.2em;"
                     bodyStyle="background-color:white;padding:0;font-size:1em;line-height:1.25em;font-family:monospace;">
      <![CDATA[
const profile = await Box.getProfile('0x12345abcde')
console.log(profile)
   ]]>
    </c:sourceContent>
    <c:sourceContent type="" title="" id="sourceContent1"
                     titleStyle="padding-left:0;color:green;font-size:1.425em;background-color:white;margin-top:.25em;font-size:1.2em;"
                     bodyStyle="background-color:white;padding:0;font-size:1em;line-height:1.25em;font-family:monospace;">
      <![CDATA[
// 1. Create a 3Box instance
const box = await Box.create(provider)

// 2. Authenticate user
const address = '0x12345abcde'
const spaces = ['myDapp']
await box.auth(spaces, { address })

// 3. Sync user's available 3Box data from the network
await box.syncDone

// 4. Interact with 3Box profile data
// use the public profile
// get
const nickname = await box.public.get('name')
console.log(nickname)
// set
await box.public.set('name', 'oed')
// remove
await box.public.remove('name')

// use the private store
// get
const email = await box.private.get('email')
console.log(email)
// set
await box.private.set('email', 'oed@email.service')
// remove
await box.private.remove('email')

const fields = ['name', 'website', 'employer']
const values = ['Jon Schwartz', 'openworklabs.com', 'Open Work Labs']

await box.public.setMultiple(fields, values)

const privateFields = ['age', 'coinBalance']
const privateValues = ['xxx', 'yyy']

await box.private.setMultiple(privateFields, privateValues)
   ]]>
    </c:sourceContent>

    <c:comment>
      <c:comment1>
        <![CDATA[]]>
      </c:comment1>
    </c:comment>
  </c:entry>


  <c:entry style="margin-top:1em;">
    <c:title id="eth-block-tracker"><![CDATA[<div style="color:blue;font-size:1.625em;">eth-block-tracker</div>]]></c:title>
    <c:desc>
      <c:desc1> <![CDATA[
<div style="margin-bottom:.425em;font-size:1.425em;">
  https://github.com/MetaMask/eth-block-tracker
</div>
]]></c:desc1>
    </c:desc>
    <c:sourceContent type="html" title="" id="sourceContent1"
                     titleStyle="padding-left:0;color:green;font-size:1em;background-color:white;font-size:1.2em;"
                     bodyStyle="background-color:white;padding:0;font-size:1em;line-height:1.625em;font-family:monospace;">
      <![CDATA[
<div style="margin-bottom:.425em;">
  A JS module for keeping track of the latest Ethereum block by polling an ethereum provider.
通过拉取以太坊的provider来跟踪最新的以太坊区块
</div>
<div style="margin-bottom:.425em;">
  This module walks the Ethereum blockchain, keeping track of the latest block. It uses a web3 provider as a data source and will continuously poll for the next block.
使用web3 provider作为其数据源，并不停地从最新的区块中拉取数据
</div>
   ]]>
    </c:sourceContent>
    <c:sourceContent type="" title="" id="sourceContent1"
                     titleStyle="padding-left:0;color:green;font-size:1.425em;background-color:white;margin-top:.25em;font-size:1.2em;"
                     bodyStyle="background-color:white;padding:0;font-size:1em;line-height:1.25em;font-family:monospace;">
      <![CDATA[
const HttpProvider = require('ethjs-provider-http')
const PollingBlockTracker = require('eth-block-tracker')

const provider = new HttpProvider('https://mainnet.infura.io')
const blockTracker = new PollingBlockTracker({ provider })
blockTracker.on('latest', console.log)
   ]]>
    </c:sourceContent>
    <c:sourceContent type="html" title="" id="sourceContent1"
                     titleStyle="padding-left:0;color:green;font-size:1.425em;background-color:white;font-size:1.2em;"
                     bodyStyle="background-color:white;padding:0;font-size:1em;line-height:1.25em;font-family:monospace;margin-top:.65em;">
      <![CDATA[

<h2 style="font-size: 1.625em;margin-top:.625em;">&diams; methods</h2>
<pre style="background-color:darkblue;color:cadetblue;padding:.625em 1em;">
/**
 * creates a new block tracker with provider as a data source and
 * pollingInterval (ms) timeout between polling for the latest block.
 * If an Error is encountered when fetching blocks, it will wait retryTimeout (ms) before attempting again.
 * If keepEventLoopActive is false, in Node.js it will unref the polling timeout, allowing the process to exit during the polling interval. defaults to true, meaning the process will be kept alive.
 */

new PollingBlockTracker({ provider, pollingInterval, retryTimeout, keepEventLoopActive })
</pre>
<div style="margin-top:.425em;font-size:1.1em;line-height:1.625em;">
创建了一个指定 provider 数据源的区块追踪器，并在 pollingInterval 的间隔时间内拉取最新区块。当获取区块的时候如果出现了错误，那么她就会等待 retryTimeout (ms)再重新获取。如果 keepEventLoopActive 是 false，在 nodejs 中它会取消轮询超时，即在拉取的间隔中允许进程退出。默认是 true，意味着进程始终保持活跃
</div>

<h3 style="font-size: 1.425em;padding-bottom: 0;color: brown;"><b>getCurrentBlock()</b></h3>
<div style="margin-top:.425em;font-size:1.1em;line-height:1.625em;">
synchronous returns the current block. may be null. 同步获取当前的区块
</div>
<pre style="background-color:darkblue;color:cadetblue;padding:.625em 1em;margin-top:.325em;margin-bottom:.25em;">
console.log(blockTracker.getCurrentBlock())
</pre>

<h3 style="font-size: 1.425em;padding-bottom: 0;color: brown;"><b>async getLatestBlock()</b></h3>
<div style="margin-top:.425em;font-size:1.1em;line-height:1.625em;">
Asynchronously returns the latest block. 异步获取最新区块
if not immediately available, it will fetch one.
</div>

<h3 style="font-size: 1.425em;padding-bottom: 0;color: brown;"><b>async checkForLatestBlock()</b></h3>
<div style="margin-top:.425em;font-size:1.1em;line-height:1.625em;">
Tells the block tracker to ask for a new block immediately, in addition to its normal polling interval.
Useful if you received a hint of a new block (e.g. via tx.blockNumber from getTransactionByHash).
</div>
<div style="margin-top:.425em;font-size:1.1em;line-height:1.625em;">
Will resolve to the new latest block when its done polling.
要求区块追踪器马上去取新的区块，除非现在正处于正常的polling间隔。如果你收到了新的区块的暗示时这个功能就十分有用（via tx.blockNumber from getTransactionByHash）。当其拉取完后，将释放最新的区块
</div>

<h2 style="font-size: 1.625em;margin-top:.625em;padding-bottom: 0;">&diams; EVENTS</h2>
<h3 style="font-size: 1.425em;padding-bottom: 0;color: brown;"><b>latest</b></h3>
<div style="margin-top:.425em;font-size:1.1em;line-height:1.625em;">
The latest event is emitted for whenever a new latest block is detected.
This may mean skipping blocks if there were two created since the last polling period.
当新的区块被检测到时，这个事件就会被触发。如果在上一个拉取周期中生成了两个区块，那么将会跳过，不会触发事件
</div>
<pre style="background-color:darkblue;color:cadetblue;padding:.625em 1em;margin-top:.325em;margin-bottom:.25em;">
blockTracker.on('latest', (newBlock) => console.log(newBlock))
</pre>

<h3 style="font-size: 1.425em;padding-bottom: 0;color: brown;"><b>sync</b></h3>
<div style="margin-top:.425em;font-size:1.1em;line-height:1.625em;">
The sync event is emitted the same as "latest" but includes the previous block.
它跟"latest"是相同的，不同在与它还返回了之前的一个区块
</div>
<pre style="background-color:darkblue;color:cadetblue;padding:.625em 1em;margin-top:.325em;margin-bottom:.25em;">
blockTracker.on('sync', ({ newBlock, oldBlock }) => console.log(newBlock, oldBlock))
</pre>

<h3 style="font-size: 1.425em;padding-bottom: 0;color: brown;"><b>error</b></h3>
<div style="margin-top:.425em;font-size:1.1em;line-height:1.625em;">
The error event means an error occurred while polling for the latest block.
当拉取最新的区块的时候出现错误时触发
</div>
<pre style="background-color:darkblue;color:cadetblue;padding:.625em 1em;margin-top:.325em;margin-bottom:.25em;">
blockTracker.on('error', (err) => console.error(err))
</pre>
   ]]>
    </c:sourceContent>

    <c:comment>
      <c:comment1>
        <![CDATA[]]>
      </c:comment1>
    </c:comment>
  </c:entry>


  <c:entry style="margin-top:1em;">
    <c:title id="json-rpc-engine"><![CDATA[<div style="color:blue;font-size:1.625em;">json-rpc-engine</div>]]></c:title>
    <c:desc>
      <c:desc1> <![CDATA[
<div style="margin-bottom:.425em;font-size:1.425em;">
  A tool for processing JSON RPC: https://github.com/MetaMask/json-rpc-engine
</div>
]]></c:desc1>
    </c:desc>
    <c:sourceContent type="" title="使用" id="sourceContent1"
                     titleStyle="padding-left:0;padding-bottom: 0;color:green;font-size:1em;background-color:white;font-size:1.2em;"
                     bodyStyle="background-color:white;padding:0;font-size:1em;line-height:1.625em;font-family:monospace;">
      <![CDATA[
const RpcEngine = require('json-rpc-engine')

let engine = new RpcEngine()

// Build a stack of json rpc processors by pushing in RpcEngine middleware.
engine.push(function(req, res, next, end){
  res.result = 42
  end()
})

// JSON RPC are handled asynchronously, stepping down the stack until complete.
let request = { id: 1, jsonrpc: '2.0', method: 'hello' }

engine.handle(request, function(err, res){
  // do something with res.result
})

// RpcEngine middleware has direct access to the request and response objects. It can let processing continue down the stack with next() or complete the request with end().
engine.push(function(req, res, next, end){
  if (req.skipCache) return next()
  res.result = getResultFromCache(req)
  end()
})

// By passing a 'return handler' to the next function, you can get a peek at the result before it returns.
engine.push(function(req, res, next, end){
  next(function(cb){
    insertIntoCache(res, cb)
  })
})

// RpcEngines can be nested by converting them to middleware asMiddleware(engine)
const asMiddleware = require('json-rpc-engine/lib/asMiddleware')

let engine = new RpcEngine()
let subengine = new RpcEngine()
engine.push(asMiddleware(subengine))
   ]]>
    </c:sourceContent>
    <c:sourceContent type="" title="gotchas" id="sourceContent1"
                     titleStyle="padding-left:0;padding-bottom: 0;color:green;font-size:1.425em;background-color:white;margin-top:.25em;font-size:1.2em;"
                     bodyStyle="background-color:white;padding:0;font-size:1em;line-height:1.25em;font-family:monospace;">
      <![CDATA[
// Handle errors via end(err), NOT next(err).
// That said, next() will detect errors on the RPC response, and cause end(res.error) to be called.
/* INCORRECT */
engine.push(function(req, res, next, end){
  next(new Error())
})

/* CORRECT */
engine.push(function(req, res, next, end){
  end(new Error())
})
   ]]>
    </c:sourceContent>

    <c:comment>
      <c:comment1>
        <![CDATA[]]>
      </c:comment1>
    </c:comment>
  </c:entry>


  <c:entry style="margin-top:1em;">
    <c:title id="json-rpc-middleware-stream"><![CDATA[<div style="color:blue;font-size:1.625em;">json-rpc-middleware-stream</div>]]></c:title>
    <c:desc>
      <c:desc1> <![CDATA[
<div style="margin-bottom:.425em;font-size:1.225em;">
  A small toolset for streaming json rpc and matching requests and responses. Made to be used with json-rpc-engine.
</div>
<div style="margin-bottom:.425em;font-size:1.225em;">
  可以用来与json-rpc-engine结合使用，对输入的json rpc进行读入、写出处理
</div>
<div style="margin-bottom:.425em;font-size:1.425em;">
  https://github.com/MetaMask/json-rpc-middleware-stream
</div>
]]></c:desc1>
    </c:desc>
    <c:sourceContent type="" title="" id="sourceContent1"
                     titleStyle="padding-left:0;padding-bottom: 0;color:green;font-size:1em;background-color:white;font-size:1.2em;"
                     bodyStyle="background-color:white;padding:0;font-size:1em;line-height:1.625em;font-family:monospace;">
      <![CDATA[
   ]]>
    </c:sourceContent>

    <c:comment>
      <c:comment1>
        <![CDATA[]]>
      </c:comment1>
    </c:comment>
  </c:entry>


  <c:entry style="margin-top:1em;">
    <c:title id="metamask-inpage-provider"><![CDATA[<div style="color:blue;font-size:1.625em;">metamask-inpage-provider</div>]]></c:title>
    <c:desc>
      <c:desc1> <![CDATA[
<div style="margin-bottom:.425em;font-size:1.225em;">
  Used to initialize the inpage ethereum provider injected by MetaMask.
</div>
<div style="margin-bottom:.425em;font-size:1.425em;">
  https://github.com/MetaMask/metamask-inpage-provider
</div>
]]></c:desc1>
    </c:desc>
    <c:sourceContent type="" title="使用" id="sourceContent1"
                     titleStyle="padding-left:0;padding-bottom: 0;color:green;font-size:1em;background-color:white;font-size:1.2em;"
                     bodyStyle="background-color:white;padding:0;font-size:1em;line-height:1.625em;font-family:monospace;">
      <![CDATA[
// Create a stream to a remote provider:
var metamaskStream = new LocalMessageDuplexStream({
  name: 'inpage',
  target: 'contentscript',
})

// compose the inpage provider
var inpageProvider = new MetamaskInpageProvider(metamaskStream)
   ]]>
    </c:sourceContent>
    <c:sourceContent type="" title="核心源码" id="sourceContent1"
                     titleStyle="padding-left:0;padding-bottom: 0;color:green;font-size:1em;background-color:white;font-size:1.2em;margin-top:1em;"
                     bodyStyle="background-color:white;padding:0;font-size:1em;line-height:1.625em;font-family:monospace;">
      <![CDATA[
// https://github.com/MetaMask/metamask-inpage-provider/blob/master/index.js
const pump = require('pump')
const RpcEngine = require('json-rpc-engine')
const createIdRemapMiddleware = require('json-rpc-engine/src/idRemapMiddleware')
const createJsonRpcStream = require('json-rpc-middleware-stream')
const ObservableStore = require('obs-store')
const asStream = require('obs-store/lib/asStream')
const ObjectMultiplex = require('obj-multiplex')
const { inherits } = require('util')
const SafeEventEmitter = require('safe-event-emitter')
const dequal = require('fast-deep-equal')
const { ethErrors } = require('eth-json-rpc-errors')
const log = require('loglevel')

const messages = require('./src/messages')
const { sendSiteMetadata } = require('./src/siteMetadata')
const {
  createErrorMiddleware,
  logStreamDisconnectWarning,
  makeThenable,
} = require('./src/utils')

// resolve response.result, reject errors
const getRpcPromiseCallback = (resolve, reject) => (error, response) => {
  error || response.error
    ? reject(error || response.error)
    : Array.isArray(response)
      ? resolve(response)
      : resolve(response.result)
}

module.exports = MetamaskInpageProvider

inherits(MetamaskInpageProvider, SafeEventEmitter)

function MetamaskInpageProvider (connectionStream) {

  // super constructor
  SafeEventEmitter.call(this)

  // private state, kept here in part for use in the _metamask proxy
  this._state = {
    sentWarnings: {
      enable: false,
      experimentalMethods: false,
      isConnected: false,
      sendAsync: false,
      // TODO:deprecate:2020-Q1
      autoReload: false,
      sendSync: false,
    },
    isConnected: undefined,
    accounts: undefined,
    isUnlocked: undefined,
  }

  this._metamask = getExperimentalApi(this)

  // public state
  this.selectedAddress = null
  this.networkVersion = undefined
  this.chainId = undefined

  // setup connectionStream multiplexing
  const mux = this.mux = new ObjectMultiplex()
  pump(
    connectionStream,
    mux,
    connectionStream,
    this._handleDisconnect.bind(this, 'MetaMask'),
  )

  // subscribe to metamask public config (one-way)
  this._publicConfigStore = new ObservableStore({ storageKey: 'MetaMask-Config' })

  // handle isUnlocked changes, and chainChanged and networkChanged events
  this._publicConfigStore.subscribe(state => {

    if ('isUnlocked' in state && state.isUnlocked !== this._state.isUnlocked) {
      this._state.isUnlocked = state.isUnlocked
      this.emit('wallet_isUnlocked', this._state.isUnlocked)
      if (!this._state.isUnlocked) {
        // accounts are never exposed when the extension is locked
        this._handleAccountsChanged([])
      } else {
        // this will get the exposed accounts, if any
        try {
          this._sendAsync(
            { method: 'eth_accounts', params: [] },
            () => {},
          )
        } catch (_) {}
      }
    }

    // Emit chainChanged event on chain change
    if ('chainId' in state && state.chainId !== this.chainId) {
      this.chainId = state.chainId
      this.emit('chainChanged', this.chainId)
      this.emit('chainIdChanged', this.chainId) // TODO:deprecate:2020-Q1
    }

    // Emit networkChanged event on network change
    if ('networkVersion' in state && state.networkVersion !== this.networkVersion) {
      this.networkVersion = state.networkVersion
      this.emit('networkChanged', this.networkVersion)
    }
  })

  pump(
    mux.createStream('publicConfig'),
    asStream(this._publicConfigStore),
    // RPC requests should still work if only this stream fails
    logStreamDisconnectWarning.bind(this, 'MetaMask PublicConfigStore'),
  )

  // ignore phishing warning message (handled elsewhere)
  mux.ignoreStream('phishing')

  // setup own event listeners

  // EIP-1193 connect
  this.on('connect', () => {
    this._state.isConnected = true
  })

  // connect to async provider

  const jsonRpcConnection = createJsonRpcStream()
  pump(
    jsonRpcConnection.stream,
    mux.createStream('provider'),
    jsonRpcConnection.stream,
    this._handleDisconnect.bind(this, 'MetaMask RpcProvider'),
  )

  // handle RPC requests via dapp-side rpc engine
  const rpcEngine = new RpcEngine()
  rpcEngine.push(createIdRemapMiddleware())
  rpcEngine.push(createErrorMiddleware())
  rpcEngine.push(jsonRpcConnection.middleware)
  this._rpcEngine = rpcEngine

  // json rpc notification listener
  jsonRpcConnection.events.on('notification', payload => {
    if (payload.method === 'wallet_accountsChanged') {
      this._handleAccountsChanged(payload.result)
    } else if (payload.method === 'eth_subscription') {
      // EIP 1193 subscriptions, per eth-json-rpc-filters/subscriptionManager
      this.emit('notification', payload.params.result)
    }
  })

  // send website metadata
  const domContentLoadedHandler = () => {
    sendSiteMetadata(this._rpcEngine)
    window.removeEventListener('DOMContentLoaded', domContentLoadedHandler)
  }
  window.addEventListener('DOMContentLoaded', domContentLoadedHandler)

  // indicate that we've connected, for EIP-1193 compliance
  setTimeout(() => this.emit('connect'))

  // TODO:deprecate:2020-Q1
  // wait a second to attempt to send this, so that the warning can be silenced
  // moved this here because there's another warning in .enable() discouraging
  // the use thereof per EIP 1102
  setTimeout(() => {
    if (this.autoRefreshOnNetworkChange && !this._state.sentWarnings.autoReload) {
      log.warn(messages.warnings.autoReloadDeprecation)
      this._state.sentWarnings.autoReload = true
    }
  }, 1000)
}

// TODO:deprecate:2020-Q1
MetamaskInpageProvider.prototype._web3Ref = undefined

// TODO:deprecate:2020-Q1
// give the dapps control of a refresh they can toggle this off on the window.ethereum
// this will be default true so it does not break any old apps.
MetamaskInpageProvider.prototype.autoRefreshOnNetworkChange = true

MetamaskInpageProvider.prototype.isMetaMask = true

/**
 * Deprecated.
 * Returns whether the inpage provider is connected to MetaMask.
 */
MetamaskInpageProvider.prototype.isConnected = function () {

  if (!this._state.sentWarnings.isConnected) {
    log.warn(messages.warnings.isConnectedDeprecation)
    this._state.sentWarnings.isConnected = true
  }
  return this._state.isConnected
}

/**
 * Sends an RPC request to MetaMask. Resolves to the result of the method call.
 * May reject with an error that must be caught by the caller.
 *
 * @param {(string|Object)} methodOrPayload - The method name, or the RPC request object.
 * @param {Array<any>} [params] - If given a method name, the method's parameters.
 * @returns {Promise<any>} - A promise resolving to the result of the method call.
 */
MetamaskInpageProvider.prototype.send = function (methodOrPayload, params) {

  // preserve original params for later error if necessary
  const _params = params

  // construct payload object
  let payload
  if (
    typeof methodOrPayload === 'object' &&
    !Array.isArray(methodOrPayload)
  ) {

    // TODO:deprecate:2020-Q1
    // handle send(object, callback), an alias for sendAsync(object, callback)
    if (typeof params === 'function') {
      return this._sendAsync(methodOrPayload, params)
    }

    payload = methodOrPayload

    // TODO:deprecate:2020-Q1
    // backwards compatibility: "synchronous" methods
    if (!params && [
      'eth_accounts',
      'eth_coinbase',
      'eth_uninstallFilter',
      'net_version',
    ].includes(payload.method)) {
      return this._sendSync(payload)
    }
  } else if (
    typeof methodOrPayload === 'string' &&
    typeof params !== 'function'
  ) {

    // wrap params in array out of kindness
    if (params === undefined) {
      params = []
    } else if (!Array.isArray(params)) {
      params = [params]
    }

    payload = {
      method: methodOrPayload,
      params,
    }
  }

  // typecheck payload and payload.method
  if (
    Array.isArray(payload) ||
    typeof params === 'function' ||
    typeof payload !== 'object' ||
    typeof payload.method !== 'string'
  ) {
    throw ethErrors.rpc.invalidRequest({
      message: messages.errors.invalidParams(),
      data: [methodOrPayload, _params],
    })
  }

  return new Promise((resolve, reject) => {
    try {
      this._sendAsync(
        payload,
        getRpcPromiseCallback(resolve, reject),
      )
    } catch (error) {
      reject(error)
    }
  })
}

/**
 * Deprecated.
 * Equivalent to: ethereum.send('eth_requestAccounts')
 *
 * @returns {Promise<Array<string>>} - A promise that resolves to an array of addresses.
 */
MetamaskInpageProvider.prototype.enable = function () {

  if (!this._state.sentWarnings.enable) {
    log.warn(messages.warnings.enableDeprecation)
    this._state.sentWarnings.enable = true
  }
  return new Promise((resolve, reject) => {
    try {
      this._sendAsync(
        { method: 'eth_requestAccounts', params: [] },
        getRpcPromiseCallback(resolve, reject),
      )
    } catch (error) {
      reject(error)
    }
  })
}

/**
 * Deprecated.
 * Backwards compatibility. ethereum.send() with callback.
 *
 * @param {Object} payload - The RPC request object.
 * @param {Function} callback - The callback function.
 */
MetamaskInpageProvider.prototype.sendAsync = function (payload, cb) {

  if (!this._state.sentWarnings.sendAsync) {
    log.warn(messages.warnings.sendAsyncDeprecation)
    this._state.sentWarnings.sendAsync = true
  }
  this._sendAsync(payload, cb)
}

/**
 * TODO:deprecate:2020-Q1
 * Internal backwards compatibility method.
 */
MetamaskInpageProvider.prototype._sendSync = function (payload) {

  if (!this._state.sentWarnings.sendSync) {
    log.warn(messages.warnings.sendSyncDeprecation)
    this._state.sentWarnings.sendSync = true
  }

  let result
  switch (payload.method) {

    case 'eth_accounts':
      result = this.selectedAddress ? [this.selectedAddress] : []
      break

    case 'eth_coinbase':
      result = this.selectedAddress || null
      break

    case 'eth_uninstallFilter':
      this._sendAsync(payload, () => {})
      result = true
      break

    case 'net_version':
      result = this.networkVersion || null
      break

    default:
      throw new Error(messages.errors.unsupportedSync(payload.method))
  }

  // looks like a plain object, but behaves like a Promise if someone calls .then on it :evil_laugh:
  return makeThenable({
    id: payload.id,
    jsonrpc: payload.jsonrpc,
    result,
  }, 'result')
}

/**
 * Internal RPC method. Forwards requests to background via the RPC engine.
 * Also remap ids inbound and outbound.
 */
MetamaskInpageProvider.prototype._sendAsync = function (payload, userCallback) {

  let cb = userCallback

  if (!Array.isArray(payload)) {

    if (!payload.jsonrpc) {
      payload.jsonrpc = '2.0'
    }

    if (
      payload.method === 'eth_accounts' ||
      payload.method === 'eth_requestAccounts'
    ) {

      // handle accounts changing
      cb = (err, res) => {
        this._handleAccountsChanged(
          res.result || [],
          payload.method === 'eth_accounts',
        )
        userCallback(err, res)
      }
    }
  }

  this._rpcEngine.handle(payload, cb)
}

/**
 * Called when connection is lost to critical streams.
 */
MetamaskInpageProvider.prototype._handleDisconnect = function (streamName, err) {

  logStreamDisconnectWarning.bind(this)(streamName, err)
  if (this._state.isConnected) {
    this.emit('close', {
      code: 1011,
      reason: 'MetaMask background communication error.',
    })
  }
  this._state.isConnected = false
}

/**
 * Called when accounts may have changed.
 */
MetamaskInpageProvider.prototype._handleAccountsChanged = function (accounts, isEthAccounts = false) {

  // defensive programming
  if (!Array.isArray(accounts)) {
    log.error(
      'MetaMask: Received non-array accounts parameter. Please report this bug.',
      accounts,
    )
    accounts = []
  }

  // emit accountsChanged if anything about the accounts array has changed
  if (!dequal(this._state.accounts, accounts)) {

    // we should always have the correct accounts even before eth_accounts
    // returns, except if the method is called before we're fully initialized
    if (isEthAccounts && this._state.accounts !== undefined) {
      log.warn(
        `MetaMask: 'eth_accounts' updated accounts. Please report this bug.`,
        accounts,
      )
    }

    this.emit('accountsChanged', accounts)
    this._state.accounts = accounts
  }

  // handle selectedAddress
  if (this.selectedAddress !== accounts[0]) {
    this.selectedAddress = accounts[0] || null
  }

  // TODO:deprecate:2020-Q1
  // handle web3
  if (this._web3Ref) {
    this._web3Ref.defaultAccount = this.selectedAddress
  } else if (window.web3 && typeof window.web3.eth === 'object') {
    window.web3.eth.defaultAccount = this.selectedAddress
  }
}

/**
 * Gets experimental _metamask API as Proxy.
 */
function getExperimentalApi (instance) {
  return new Proxy(
    {

      /**
       * Determines if MetaMask is unlocked by the user.
       *
       * @returns {Promise<boolean>} - Promise resolving to true if MetaMask is currently unlocked
       */
      isUnlocked: async () => {
        if (instance._state.isUnlocked === undefined) {
          await new Promise(
            (resolve) => instance._publicConfigStore.once('update', () => resolve()),
          )
        }
        return instance._state.isUnlocked
      },

      /**
       * Make a batch request.
       */
      sendBatch: async (requests) => {

        // basic input validation
        if (!Array.isArray(requests)) {
          throw ethErrors.rpc.invalidRequest({
            message: 'Batch requests must be made with an array of request objects.',
            data: requests,
          })
        }

        return new Promise((resolve, reject) => {
          try {
            instance._sendAsync(
              requests,
              getRpcPromiseCallback(resolve, reject),
            )
          } catch (error) {
            reject(error)
          }
        })
      },

      // TODO:deprecate:2020-Q1 isEnabled, isApproved
      /**
       * Deprecated. Will be removed in Q1 2020.
       * Synchronously determines if this domain is currently enabled, with a potential false negative if called to soon
       *
       * @returns {boolean} - returns true if this domain is currently enabled
       */
      isEnabled: () => {
        return Array.isArray(instance._state.accounts) && instance._state.accounts.length > 0
      },

      /**
       * Deprecated. Will be removed in Q1 2020.
       * Asynchronously determines if this domain is currently enabled
       *
       * @returns {Promise<boolean>} - Promise resolving to true if this domain is currently enabled
       */
      isApproved: async () => {
        if (instance._state.accounts === undefined) {
          await new Promise(
            (resolve) => instance.once('accountsChanged', () => resolve()),
          )
        }
        return Array.isArray(instance._state.accounts) && instance._state.accounts.length > 0
      },
    },
    {

      get: (obj, prop) => {

        if (!instance._state.sentWarnings.experimentalMethods) {
          log.warn(messages.warnings.experimentalMethods)
          instance._state.sentWarnings.experimentalMethods = true
        }
        return obj[prop]
      },
    },
  )
}
   ]]>
    </c:sourceContent>

    <c:comment>
      <c:comment1>
        <![CDATA[]]>
      </c:comment1>
    </c:comment>
  </c:entry>



  <c:entry style="margin-top:1em;">
    <c:title id="nonce-tracker"><![CDATA[<div style="color:blue;font-size:1.625em;">nonce-tracker</div>]]></c:title>
    <c:desc>
      <c:desc1> <![CDATA[
<div style="margin-bottom:.425em;font-size:1.225em;">
  How metamask calculates nonces
</div>
<div style="margin-bottom:.425em;font-size:1.425em;">
  https://github.com/MetaMask/nonce-tracker
</div>
]]></c:desc1>
    </c:desc>
    <c:sourceContent type="" title="使用" id="sourceContent1"
                     titleStyle="padding-left:0;padding-bottom: 0;color:green;font-size:1em;background-color:white;font-size:1.2em;"
                     bodyStyle="background-color:white;padding:0;font-size:1em;line-height:1.625em;font-family:monospace;">
      <![CDATA[
const NonceTracker = require('nonce-tracker')

const nonceTracker = new NonceTracker(config)

nonceLock = nonceTracker.getNonceLock('0xselectedEthereumAddress')

nonce = nonceLock.nextNonce
   ]]>
    </c:sourceContent>
    <c:sourceContent type="html" title="" id="sourceContent1"
                     titleStyle="padding-left:0;padding-bottom: 0;color:green;font-size:1em;background-color:white;font-size:1.2em;"
                     bodyStyle="background-color:white;padding:0;font-size:1em;line-height:1.625em;font-family:monospace;margin-top:1em;">
      <![CDATA[
<div style="margin-bottom:.425em;font-size:1.225em;">
  主要是得到 address 账户下一个交易的 nonce 值，核心就是下面三个值取最大的：
</div>
<ul style="margin-bottom:.425em;margin-top:.325em;list-style: disc;margin-left: 1.5em;font-size:1.225em;">
      <li>_getNetworkNextNonce(address)</li>
      <li>_getHighestLocallyConfirmed(address)</li>
      <li>localNonceResult.nonce</li>
    </ul>
<div style="margin-bottom:.425em;font-size:1.225em;">
  因为取值过程中涉及到 nonce++，所以使用了 await-semaphore 控制，防止多次执行。
</div>
   ]]>
    </c:sourceContent>
    <c:sourceContent type="html" title="await-semaphore" id="sourceContent1"
                     titleStyle="padding-left:0;padding-bottom: 0;color:green;font-size:1em;background-color:white;font-size:1.2em;"
                     bodyStyle="background-color:white;padding:0;font-size:1em;line-height:1.825em;font-family:monospace;margin-top:1em;">
      <![CDATA[
<div style="margin-bottom:.425em;font-size:1.225em;">
  信号量控制实现，主要是为了保护共享资源，使得资源在一个时刻只有一个进程（线程）所拥有。
</div>
<div style="margin-bottom:.425em;font-size:1.225em;">
使用 Seamphore，创建了多少线程，实际就会有多少线程进行执行，只是可同时执行的线程数量会受到限制。但使用线程池，不管你创建多少线程，实际可执行的线程数是一定的。
</div>
   ]]>
    </c:sourceContent>
    <c:sourceContent type="" title="" id="sourceContent1"
                     titleStyle="padding-left:0;padding-bottom: 0;color:green;font-size:1em;background-color:white;font-size:1.2em;"
                     bodyStyle="background-color:white;padding:0;font-size:1em;line-height:1.625em;font-family:monospace;">
      <![CDATA[
var semaphore = new Semaphore(10);

async function niceFetch(url) {
    var release = await semaphore.acquire();
    var result = await fetch(url);
    release();
    return result;
}
   ]]>
    </c:sourceContent>
    <c:sourceContent type="" title="核心代码" id="sourceContent1"
                     titleStyle="padding-left:0;padding-bottom: 0;color:green;font-size:1em;background-color:white;font-size:1.2em;margin-top:1em;"
                     bodyStyle="background-color:white;padding:0;font-size:1em;line-height:1.625em;font-family:monospace;">
      <![CDATA[
const EthQuery = require('ethjs-query')
const assert = require('assert')
const Mutex = require('await-semaphore').Mutex
/**
  @param opts {Object}
    @param {Object} opts.provider a ethereum provider
    @param {Function} opts.getPendingTransactions a function that returns an array of txMeta
    whosee status is `submitted`
    @param {Function} opts.getConfirmedTransactions a function that returns an array of txMeta
    whose status is `confirmed`
  @class
*/
class NonceTracker {

  constructor ({ provider, blockTracker, getPendingTransactions, getConfirmedTransactions }) {
    this.provider = provider
    this.blockTracker = blockTracker
    this.ethQuery = new EthQuery(provider)
    this.getPendingTransactions = getPendingTransactions
    this.getConfirmedTransactions = getConfirmedTransactions
    this.lockMap = {}
  }

  /**
    @returns {Promise<Object>} with the key releaseLock (the gloabl mutex)
  */
  async getGlobalLock () {
    const globalMutex = this._lookupMutex('global')
    // await global mutex free
    const releaseLock = await globalMutex.acquire()
    return { releaseLock }
  }

  /**
   * @typedef NonceDetails
   * @property {number} highestLocallyConfirmed - A hex string of the highest nonce on a confirmed transaction.
   * @property {number} nextNetworkNonce - The next nonce suggested by the eth_getTransactionCount method.
   * @property {number} highestSuggested - The maximum between the other two, the number returned.
   */

  /**
  this will return an object with the `nextNonce` `nonceDetails`, and the releaseLock
  Note: releaseLock must be called after adding a signed tx to pending transactions (or discarding).

  @param address {string} the hex string for the address whose nonce we are calculating
  @returns {Promise<NonceDetails>}
  */
  async getNonceLock (address) {
    // await global mutex free
    await this._globalMutexFree()
    // await lock free, then take lock
    const releaseLock = await this._takeMutex(address)
    try {
      // evaluate multiple nextNonce strategies
      const nonceDetails = {}
      const networkNonceResult = await this._getNetworkNextNonce(address)
      const highestLocallyConfirmed = this._getHighestLocallyConfirmed(address)
      const nextNetworkNonce = networkNonceResult.nonce
      const highestSuggested = Math.max(nextNetworkNonce, highestLocallyConfirmed)

      const pendingTxs = this.getPendingTransactions(address)
      const localNonceResult = this._getHighestContinuousFrom(pendingTxs, highestSuggested) || 0

      nonceDetails.params = {
        highestLocallyConfirmed,
        highestSuggested,
        nextNetworkNonce,
      }
      nonceDetails.local = localNonceResult
      nonceDetails.network = networkNonceResult

      const nextNonce = Math.max(networkNonceResult.nonce, localNonceResult.nonce)
      assert(Number.isInteger(nextNonce), `nonce-tracker - nextNonce is not an integer - got: (${typeof nextNonce}) "${nextNonce}"`)

      // return nonce and release cb
      return { nextNonce, nonceDetails, releaseLock }
    } catch (err) {
      // release lock if we encounter an error
      releaseLock()
      throw err
    }
  }

  async _globalMutexFree () {
    const globalMutex = this._lookupMutex('global')
    const releaseLock = await globalMutex.acquire()
    releaseLock()
  }

  async _takeMutex (lockId) {
    const mutex = this._lookupMutex(lockId)
    const releaseLock = await mutex.acquire()
    return releaseLock
  }

  _lookupMutex (lockId) {
    let mutex = this.lockMap[lockId]
    if (!mutex) {
      mutex = new Mutex()
      this.lockMap[lockId] = mutex
    }
    return mutex
  }

  async _getNetworkNextNonce (address) {
    // calculate next nonce
    // we need to make sure our base count
    // and pending count are from the same block
    const blockNumber = await this.blockTracker.getLatestBlock()
    const baseCountBN = await this.ethQuery.getTransactionCount(address, blockNumber)
    const baseCount = baseCountBN.toNumber()
    assert(Number.isInteger(baseCount), `nonce-tracker - baseCount is not an integer - got: (${typeof baseCount}) "${baseCount}"`)
    const nonceDetails = { blockNumber, baseCount }
    return { name: 'network', nonce: baseCount, details: nonceDetails }
  }

  _getHighestLocallyConfirmed (address) {
    const confirmedTransactions = this.getConfirmedTransactions(address)
    const highest = this._getHighestNonce(confirmedTransactions)
    return Number.isInteger(highest) ? highest + 1 : 0
  }

  _getHighestNonce (txList) {
    const nonces = txList.map((txMeta) => {
      const nonce = txMeta.txParams.nonce
      assert(typeof nonce, 'string', 'nonces should be hex strings')
      return parseInt(nonce, 16)
    })
    const highestNonce = Math.max.apply(null, nonces)
    return highestNonce
  }

  /**
    @typedef {object} highestContinuousFrom
    @property {string} - name the name for how the nonce was calculated based on the data used
    @property {number} - nonce the next suggested nonce
    @property {object} - details the provided starting nonce that was used (for debugging)
  */
  /**
    @param txList {array} - list of txMeta's
    @param startPoint {number} - the highest known locally confirmed nonce
    @returns {highestContinuousFrom}
  */
  _getHighestContinuousFrom (txList, startPoint) {
    const nonces = txList.map((txMeta) => {
      const nonce = txMeta.txParams.nonce
      assert(typeof nonce, 'string', 'nonces should be hex strings')
      return parseInt(nonce, 16)
    })

    let highest = startPoint
    while (nonces.includes(highest)) {
      highest++
    }

    return { name: 'local', nonce: highest, details: { startPoint, highest } }
  }

}

module.exports = NonceTracker
   ]]>
    </c:sourceContent>

    <c:comment>
      <c:comment1>
        <![CDATA[]]>
      </c:comment1>
    </c:comment>
  </c:entry>




  <c:entry style="margin-top:1em;">
    <c:title id="obs-store"><![CDATA[<div style="color:blue;font-size:1.625em;">obs-store</div>]]></c:title>
    <c:desc>
      <c:desc1> <![CDATA[
<div style="margin-bottom:.425em;font-size:1.225em;">
  ObservableStore is a synchronous in-memory store for a single value, that you can subscribe to updates on.
</div>
<div style="margin-bottom:.425em;font-size:1.425em;">
  https://github.com/MetaMask/obs-store
</div>
]]></c:desc1>
    </c:desc>
    <c:sourceContent type="" title="" id="sourceContent1"
                     titleStyle="padding-left:0;padding-bottom: 0;color:green;font-size:1em;background-color:white;font-size:1.2em;"
                     bodyStyle="background-color:white;padding:0;font-size:1em;line-height:1.625em;font-family:monospace;">
      <![CDATA[
const store = new ObservableStore(initState)
store.subscribe(function showValue(value) {
  console.log('saw value:', value)
})

store.putState(5) // "saw value: 5"
store.putState(true) // "saw value: true"
store.putState({ hello: 'world' }) // "saw value: { hello: 'world' }"

console.log(store.getState().hello) // "world"
   ]]>
    </c:sourceContent>
    <c:sourceContent type="html" title="streams" id="sourceContent1"
                     titleStyle="padding-left:0;padding-bottom: 0;color:green;font-size:1em;background-color:white;font-size:1.2em;margin-top:1em;"
                     bodyStyle="background-color:white;padding:0;font-size:1em;line-height:1.625em;font-family:monospace;">
      <![CDATA[
<div style="margin-bottom:.425em;font-size:1.225em;">
  Each ObservableStore can be turned into an ObservableStoreStream. An ObservableStoreStream is a duplex stream that you can pipe new values into it or pipe its updated values out of it
</div>
   ]]>
    </c:sourceContent>
    <c:sourceContent type="" title="" id="sourceContent1"
                     titleStyle="padding-left:0;padding-bottom: 0;color:green;font-size:1em;background-color:white;font-size:1.2em;"
                     bodyStyle="background-color:white;padding:0;font-size:1em;line-height:1.825em;font-family:monospace;margin-top:1em;">
      <![CDATA[
// Special behavior: Doesnt buffer outgoing updates, writes latest state to dest on pipe.
const pipe = require('pump')
const asStream = require('obs-store/lib/asStream')

const storeOne = new ObservableStore(initState)
const storeTwo = new ObservableStore()

pipe(
  asStream(storeOne),
  transformStream,
  asStream(storeTwo)
)
   ]]>
    </c:sourceContent>
    <c:comment>
      <c:comment1>
        <![CDATA[]]>
      </c:comment1>
    </c:comment>
  </c:entry>



  <c:entry style="margin-top:1em;">
    <c:title id="post-message-stream"><![CDATA[<div style="color:blue;font-size:1.625em;">post-message-stream</div>]]></c:title>
    <c:desc>
      <c:desc1> <![CDATA[
<div style="margin-bottom:.425em;font-size:1.225em;">
  Sets up a duplex object stream over window.postMessage
</div>
<div style="margin-bottom:.425em;font-size:1.425em;">
  https://github.com/kumavis/post-message-stream
</div>
]]></c:desc1>
    </c:desc>
    <c:sourceContent type="" title="" id="sourceContent1"
                     titleStyle="padding-left:0;padding-bottom: 0;color:green;font-size:1em;background-color:white;font-size:1.2em;"
                     bodyStyle="background-color:white;padding:0;font-size:1em;line-height:1.625em;font-family:monospace;">
      <![CDATA[
var streamA = new PostMessageStream({
  name: 'thing one',
  target: 'thing two',
})

var streamB = new PostMessageStream({
  name: 'thing two',
  target: 'thing one',
})

streamB.on('data', (data) => console.log(data))
streamA.write(chunk)
   ]]>
    </c:sourceContent>
    <c:sourceContent type="" title="constructor arguments" id="sourceContent1"
                     titleStyle="padding-left:0;padding-bottom: 0;color:green;font-size:1em;background-color:white;font-size:1.2em;margin-top:1em;"
                     bodyStyle="background-color:white;padding:0;font-size:1em;line-height:1.625em;font-family:monospace;">
      <![CDATA[
var messageStream = new PostMessageStream({

  // required

  // name of stream, used to differentiate
  // when multiple streams are on the same window 
  name: 'source',

  // name of target stream 
  target: 'sink',

  // optional

  // window to send the message to
  // default is `window`
  window: iframe.contentWindow,
  
})
   ]]>
    </c:sourceContent>
    <c:sourceContent type="" title="window.postMessage" id="sourceContent1"
                     titleStyle="padding-left:0;padding-bottom: 0;color:green;font-size:1em;background-color:white;font-size:1.2em;margin-top:1em;"
                     bodyStyle="background-color:white;padding:0;font-size:1em;line-height:1.825em;font-family:monospace;">
      <![CDATA[
// https://developer.mozilla.org/zh-CN/docs/Web/API/Window/postMessage
// window.postMessage() 方法可以安全地实现跨源通信。

// otherWindow 其他窗口的一个引用
// message 将要发送到其他 window的数据
// targetOrigin 通过窗口的origin属性来指定哪些窗口能接收到消息事件
                其值可以是字符串"*"（表示无限制）或者一个URI。
// transfer 是一串和message 同时传递的 Transferable 对象
otherWindow.postMessage(message, targetOrigin, [transfer]);

// 执行如下代码, 其他window可以监听分发的message:
window.addEventListener("message", receiveMessage, false);

// event
// data 从其他 window 中传递过来的对象
// origin 调用 postMessage  时消息发送方窗口的 origin
// source 对发送消息的窗口对象的引用
function receiveMessage(event) {
  var origin = event.origin || event.originalEvent.origin; 
  if (origin !== "http://example.org:8080")
    return;

  // ...
}
   ]]>
    </c:sourceContent>
    <c:sourceContent type="html" title="" id="sourceContent1"
                     titleStyle="padding-left:0;padding-bottom: 0;color:green;font-size:1em;background-color:white;font-size:1.2em;"
                     bodyStyle="background-color:white;padding:0;font-size:1em;line-height:1.825em;font-family:monospace;margin-top:1em;">
      <![CDATA[
<ul style="margin-top:.325em;list-style: disc;margin-left: 1.5em;">
  <li>如果您不希望从其他网站接收 message，请不要为 message 事件添加任何事件侦听器。 </li>
  <li>如果您确实希望从其他网站接收 message，请始终使用 origin 和 source 属性验证发件人的身份。</li>
  <li>当您使用 postMessage 将数据发送到其他窗口时，始终指定精确的目标 origin，而不是*。</li>
</ul>
   ]]>
    </c:sourceContent>
    <c:sourceContent type="" title="核心源码" id="sourceContent1"
                     titleStyle="padding-left:0;padding-bottom: 0;color:green;font-size:1em;background-color:white;font-size:1.2em;margin-top:1em;"
                     bodyStyle="background-color:white;padding:0;font-size:1em;line-height:1.825em;font-family:monospace;">
      <![CDATA[
// https://github.com/kumavis/post-message-stream/blob/master/index.js
const DuplexStream = require('readable-stream').Duplex
const inherits = require('util').inherits

module.exports = PostMessageStream

inherits(PostMessageStream, DuplexStream)

function PostMessageStream (opts) {
  DuplexStream.call(this, {
    objectMode: true,
  })

  this._name = opts.name
  this._target = opts.target
  this._targetWindow = opts.targetWindow || window
  this._origin = (opts.targetWindow ? '*' : location.origin)

  // initialization flags
  this._init = false
  this._haveSyn = false

  window.addEventListener('message', this._onMessage.bind(this), false)
  // send syncorization message
  this._write('SYN', null, noop)
  // 调用 writable.cork() 方法将强制所有写入数据都内存中的缓冲区里。
  // 直到调用 stream.uncork() 或 stream.end() 方法时，缓冲区里的数据才会被输出。
  this.cork()
}

// private
PostMessageStream.prototype._onMessage = function (event) {
  var msg = event.data

  // validate message
  if (this._origin !== '*' && event.origin !== this._origin) return
  if (event.source !== this._targetWindow) return
  if (typeof msg !== 'object') return
  if (msg.target !== this._name) return
  if (!msg.data) return

  if (!this._init) {
    // listen for handshake 模拟三次握手，再消费消息
    if (msg.data === 'SYN') {
      this._haveSyn = true
      this._write('ACK', null, noop)
    } else if (msg.data === 'ACK') {
      this._init = true
      if (!this._haveSyn) {
        this._write('ACK', null, noop)
      }
      // writable.uncork() 将输出在 stream.cork() 方法被调用之后缓冲在内存中的所有数据。
      // 如果一个流多次调用了 writable.cork() 方法，
      //   那么也必须调用同样次数的 writable.uncork() 方法以输出缓冲区数据。
      this.uncork()
    }
  } else {
    // forward message
    try {
      this.push(msg.data)
    } catch (err) {
      this.emit('error', err)
    }
  }
}

// stream plumbing
PostMessageStream.prototype._read = noop

PostMessageStream.prototype._write = function (data, encoding, cb) {
  var message = {
    target: this._target,
    data: data,
  }
  this._targetWindow.postMessage(message, this._origin)
  cb()
}

// util

function noop () {}
   ]]>
    </c:sourceContent>
    <c:comment>
      <c:comment1>
        <![CDATA[]]>
      </c:comment1>
    </c:comment>
  </c:entry>





  <c:entry style="margin-top:1em;">
    <c:title id="metamask-dictionary"><![CDATA[<div style="color:blue;font-size:1.625em;">metamask 目录</div>]]></c:title>
    <c:desc>
      <c:desc1> <![CDATA[
<div style="margin-bottom:.425em;font-size:1.225em;line-height:1.625em;">
  可以好好看看 <a href="https://metamask.github.io/metamask-extension/index.html">https://metamask.github.io/metamask-extension/index.html</a> 看看有哪些类，模块和全局方法
</div>
<div style="margin-bottom:.425em;font-size:1.225em;line-height:1.625em;">
  简单文件用一句话描述，稍微复杂的文件都有链接，点进去有全部代码、详细解析和说明，参考 <a href="https://github.com/jnoodle/metamask-extension">https://github.com/jnoodle/metamask-extension</a>
</div>
]]></c:desc1>
    </c:desc>
    <c:sourceContent type="html" title="" id="sourceContent1"
                     titleStyle="padding-left:0;padding-bottom: 0;color:green;font-size:1em;background-color:white;font-size:1.2em;"
                     bodyStyle="background-color:white;padding:0;font-size:1em;line-height:1.625em;font-family:monospace;">
      <![CDATA[
<ul style="margin-top:.325em;list-style: disc;margin-left: 1.5em;">
  <li>
    <p>.circleci/  持续集成配置</p>
    <ul style="margin-top:.325em;list-style: disc;margin-left: 1.5em;">
      <li>scripts/</li>
      <li>config.yml</li>
    </ul>
  </li>
  <li>
    <p>.github/    Issue and PR templates</p>
    <ul style="margin-top:.325em;list-style: disc;margin-left: 1.5em;">
      <li>ISSUE_TEMPLATE/</li>
    </ul>
  </li> 
  <li>
    <p>.storybook/  storybook配置</p>
  </li> 
  <li>
    <p>app/  主应用</p>
    <ul style="margin-top:.325em;list-style: disc;margin-left: 1.5em;">
      <li>
        <p>_locales/  多语言/</p>
      <ul style="margin-top:.325em;list-style: disc;margin-left: 1.5em;">
        <li>
          &lt;lang&gt;/message.json  多语言文件
          </li>
      </ul>
        </li>
      <li>
        <p>fonts/  字体文件</p>
        </li>
      <li>
        <p>images/   图片资源</p>
        </li>
      <li>
        <p>scripts/  Metamask 脚本文件</p>
      <ul style="margin-top:.325em;list-style: disc;margin-left: 1.5em;">
        <li>
          <p>account-import-strategies/  钱包导入处理</p>
        <ul style="margin-top:.325em;list-style: disc;margin-left: 1.5em;">
          <li>
            <p>index.js 支持 Private Key 和 JSON File 导入</p>
            </li>
        </ul>
          </li>
        <li>
          <p>controllers/ 不同的 controllers，严格来说是 ViewController</p>
        <ul style="margin-top:.325em;list-style: disc;margin-left: 1.5em;">
          <li>
            <p>network/ NetworkController</p>
            </li>
          <li>
            <p>transactions/ Transaction Controller</p>
            <ul style="margin-top:.325em;list-style: disc;margin-left: 1.5em;">
            <li>
              <p>lib/</p>  
              <ul style="margin-top:.325em;list-style: disc;margin-left: 1.5em;">
              <li>recipient-blacklist.js  收件人地址黑名单，一般都是钓鱼地址</li>
              <li>recipient-blacklist-checker.js  收件人是否在黑名单检查器</li>
              <li>tx-state-history-helper.js  对 txMeta history 处理的一些工具方法</li>
              <li>util.js  </li>
            </ul>
            </li>
            <li>enums.js  交易目前的状态枚举</li>
            <li>index.js  整合 transactions 里所有 tracker 和 controller</li>
            <li>pending-tx-tracker.js  </li>
            <li>README.md</li>
            <li>tx-gas-utils.js  gas计算和安全缓存</li>
            <li>tx-state-manager.js  负责交易的状态和存储交易</li>
          </ul>
            </li>
              <li>
            <p>ab-test.js  进行 a/b 测试，比如全屏显示是否会增加成功确认率</p>
            </li>
          <li>
            <p>app-state.js  设置 app 激活，非激活，超时之类的</p>
            </li>
          <li>
            <p>balance.js  存储和更新账户余额</p>
            </li>
          <li>
            <p>cached-balances.js  维护本地存储中帐户余额的缓存</p>
            </li>
          <li>
            <p>detect-tokens.js  根据用户当前的 token 列表轮询 token 汇率</p>
            </li>
          <li>
            <p>incoming-transactions.js  处理收入交易</p>
            </li>
          <li>
            <p>infura.js  每10分钟检测下 infura 联通情况（https://api.infura.io/v1/status/metamask）</p>
            </li>
          <li>
            <p>onboarding.js  设置用户是否已完成种子短语备份挑战 seedPhraseBackedUp: t/f</p>
            </li>
          <li>
            <p>preferences.js   用户首选项设置</p>
            </li>
          <li>
            <p>provider-approval.js  为用户认可的 ETH provider API 请求提供服务</p>
            </li>
          <li>
            <p>README.md </p>
            </li> 
          <li>
            <p>recent-blocks.js  负责存储，更新和管理最近的 block</p>
            </li>
          <li>
            <p>threebox.js  3box Controller</p>
            </li>
          <li>
            <p>token-rates.js  轮询获取用户 token 的汇率</p>
            </li>
        </ul>
          </li>
          <li>
            <p>lib/</p>
        <li>
          <p>ens-ipfs/  EIP1577 标准，ENS 解析到 IPFS</p>
          <ul style="margin-top:.325em;list-style: disc;margin-left: 1.5em;">
            <li>
              <p>contracts/  ABIs</p>
              <ul style="margin-top:.325em;list-style: disc;margin-left: 1.5em;">
              <li>registry.js  registryAbi</li>
              <li>resolver.js  resolverAbi</li>
            </ul>
            </li>
            <li>resolver.js  ENS to IPFS contentId</li>
            <li>setup.js  设置 ens ipfs 解析器</li>
          </ul>
        </li>
        <li>
          <p>migrator/  </p>
          <ul style="margin-top:.325em;list-style: disc;margin-left: 1.5em;">
            <li>index.js  处理 MetaMask 迁移</li>
          </ul>
        </li>
        <li>account-tracker.js  负责跟踪任意数量的帐户并缓存其当前余额和交易数</li>
        <li>auto-reload.js  处理页面何时重新加载</li>
        <li>backend-metametrics.js  连接 metamask 分析服务（metametrics），统计、错误分析等</li>
        <li>buy-eth-url.js  获取可以买 ETH 的地址，比如 faucet</li>
        <li>cleanErrorStack.js  去掉错误中的堆栈信息，以更好地显示在UI</li>
        <li>ComposableObservableStore.js  可组合的 obs-store</li>
        <li>createDnodeRemoteGetter.js  获取 dnode Server 端的 remote</li>
        <li>createLoggerMiddleware.js  记录RPC活动日志的中间件</li>
        <li>createOriginMiddleware.js  把 DApp 的 origin 添加到请求报文里</li>
        <li>createStreamSink.js  创建异步 writable stream</li>
        <li>diagnostics-reporter.js  诊断报告</li>
        <li>enums.js  常用枚举：环境类型，平台，网络 chainId</li>
        <li>extractEthjsErrorMessage.js  提取 ethjs-rpc 里可读的错误信息</li>
        <li>fetch-with-timeout.js  带超时中断的 fetch</li>
        <li>freezeGlobals.js  阻止 Promise 重新定义</li>
        <li>get-first-preferred-lang-code.js  根据用户浏览器中的设置返回首选语言码（小写）</li>
        <li>getObjStructure.js  获取 obj 结构，即将 key 值替换成 key 类型</li>
        <li>hex-to-bn.js  十六进制转换成 BN ethereumjs-util.BN</li>
        <li>local-store.js  extension 本地存储的包装</li>
        <li>message-manager.js  eth_sign 接口数据制备</li>
        <li>nodeify.js  把 Promise 转换成 node callback 风格，主要为了更好处理错误</li>
        <li>notification-manager.js  一组用于控制通知弹出窗口的显示和隐藏的方法</li>
        <li>pending-balance-calculator.js  计算用户的待处理余额（当前余额 - 处理中的花费）</li>
        <li>personal-message-manager.js  personal_sign 接口数据制备</li>
        <li>random-id.js  生成随机id（初始id++）</li>
        <li>reportFailedTxToSentry.js  格式化失败的 tx message，发给 sentry</li>
        <li>seed-phrase-verifier.js  验证助记词是否可以还原帐户</li>
        <li>select-chain-id.js  获取 chainId（1，3，4，42，5）</li>
        <li>setupFetchDebugging.js  对 fetch 进行封装，抛错时附带上下文和堆栈，参考issue</li>
        <li>setupMetamaskMeshMetrics.js  将 iframe 注入当前文档以进行测试</li>
        <li>setupSentry.js  设置 sentry 远程错误报告</li>
        <li>stream-utils.js  stream 处理工具方法</li>
        <li>typed-message-manager.js  eth_signTypedData 接口数据制备</li>
        <li>util.js  一些常用工具方法</li>
          </li>
          <li>
            <p>migrations/  版本迁移：数据（用户数据，配置文件等）从一个版本迁移到另一个版本</p>
        <ul style="margin-top:.325em;list-style: disc;margin-left: 1.5em;">
          <li>0xx.js  版本迁移文件 002.js - 038.js，每个迁移文件必须有 version 属性和 migrate 方法</li>
          <li>fail-tx.js  迁移时作废掉 tx，在版本 029.js 时使用到了</li>
          <li>index.js  导出版本</li>
          <li>README.md  </li>
          <li>template.js  迁移及其作用说明</li>
        </ul>
            </li>
          <li>
            <p>platforms/  统一标准化 extension 方法，屏蔽各浏览器差异</p>
        <ul style="margin-top:.325em;list-style: disc;margin-left: 1.5em;">
          <li>extension.js  标准化 extension 方法，比如：刷新、打开窗口、显示消息等</li>
          <li>sw.js  暂时没用到</li>
          <li>window.js  暂时没用到</li>
        </ul>
            </li>
          <li>background.js   页面和区块链进行交互的中间部分</li>
        <li>chromereload.js  重新加载Chrome应用和扩展程序的客户端 http://livereload.com/</li>
        <li>contentscript.js   把 inpage.js 注入到页面中，并通过流把页面和后台脚本连接</li>
        <li>createStandardProvider.js  将传统 provider 转换为符合 EIP-1193 的 provider</li>
        <li>edge-encryptor.js  微软 Edge 浏览器特定的加解密 API</li>
        <li>first-time-state.js  首次进入初始 state，主要用于测试</li>
        <li>inpage.js  注入全局 Web3</li>
        <li>metamask-controller.js   MetaMask Controller 聚合其他控制器并导出api</li>
        <li>phishing-detect.js  通过 https://etherscamdb.info 检测钓鱼网站 </li>
        <li>README.md</li>
        <li>ui.js  UI 相关方法</li>
      </ul>
        </li>
        <li>
          <p>vendor/  第三方</p>
      <ul style="margin-top:.325em;list-style: disc;margin-left: 1.5em;">
        <li>
          <p>trezor/  trezor 硬件钱包</p>
        <ul style="margin-top:.325em;list-style: disc;margin-left: 1.5em;">
          <li>content-script.js  popop 和 background 建立连接（name:trezor-connect)</li>
          <li>usb-permissions.js  处理来自USB权限iframe的消息</li>
        </ul>
          </li>
      </ul>
        </li>
        <li>home.html  MetaMask 首页，载入 ui-libs.js 和 ui.js</li>
      <li>loading.html  请求 ENS 中页面</li>
      <li>manifest.json   插件配置文件</li>
      <li>notification.html  提示信息页面</li>
      <li>phishing.html  检测出钓鱼网站后显示的页面</li>
      <li>popup.html  popup 弹框，和 home.html 一样，不过加了尺寸限制 width:357px; height:600px;</li>
      <li>trezor-usb-permissions.html  trezor usb 权限申请页面</li>
      <li>unsupport.html  ENS 不支持（只支持主网）</li>
    </ul>
  </li> 
  <li>builds/  生成的插件压缩包</li>
  <li>development/  用于开发的一些文件</li>
  <li>dist/  生成的插件代码</li>
  <li>docs/  官方文档</li>
  <li>fonts/  --> app/fonts</li>
  <li>images/  --> app/images</li>
  <li>test/  测试用例</li>
  <li>
    <p>ui/  UI 代码，参考 MetaMask UI 编写通用规则</p>
    <ul style="margin-top:.325em;list-style: disc;margin-left: 1.5em;">
      <li>
        <p>app/  代码</p>
      <ul style="margin-top:.325em;list-style: disc;margin-left: 1.5em;">
        <li>
          <p>components/  所有组件</p>
        <ul style="margin-top:.325em;list-style: disc;margin-left: 1.5em;">
          <li>
            <p>app/  容器组件</p>
          <ul style="margin-top:.325em;list-style: disc;margin-left: 1.5em;">
            <li>account-details/  账户详细信息</li>
           <li>account-menu/  切换账户</li>
           <li>add-token-button/  新增 Token</li>
           <li>app-header/  App 头部信息</li>
           <li>confirm-page-container/  确认页</li>
           <li>contact-list/  联系人列表</li>
           <li>customize-gas-modal/  自定义 gas Modal 框</li>
           <li>dropdowns/  各种下拉菜单，比如选择网络，选择账户，选择token等</li>
           <li>gas-customization/  自定义 gas 时的一些相关组件：输入框、按钮组、slider等</li>
           <li>home-notification/  首页消息提示</li>
           <li>info-box/  信息提示框</li>
           <li>loading-network-screen/  网络载入中提示</li>
           <li>menu-bar/  菜单</li>
           <li>modal/  Modal 弹框</li>
           <li>modals/  各种 modal 集合：账户详情、添加联系人、取消交易、扫描二维码、各种确认等</li>
           <li>multiple-notifications/  多条消息提示</li>
           <li>network-display/  网络显示</li>
           <li>provider-page-container/  provider 设置</li>
           <li>selected-account/  选择账户</li>
           <li>sidebars/  侧边菜单，打开带动画效果</li>
           <li>transaction-action/  交易动作</li>
           <li>transaction-activity-log/  交易活动日志</li>
           <li>transaction-breakdown/  交易明细</li>
           <li>transaction-list/  交易列表</li>
           <li>transaction-list-item/  交易列表条目</li>
           <li>transaction-list-item-details/  交易列表条目详细信息</li>
           <li>transaction-status/  交易状态</li>
           <li>transaction-view/  交易视图：包含交易列表和交易余额</li>
           <li>transaction-view-balance/  交易余额</li>
           <li>user-preferenced-currency-display/  用户首选货币显示</li>
           <li>user-preferenced-currency-input/  用户首选货币输入</li>
           <li>user-preferenced-token-input/  用户首选 token 输入</li>
           <li>account-panel.js  账户面板</li>
           <li>bn-as-decimal-input.js  大数输入</li>
           <li>copyable.js  可以拷贝</li>
           <li>index.scss  所有组件样式整合</li>
           <li>input-number.js  数字输入框</li>
           <li>menu-droppo.js  下拉菜单</li>
           <li>network.js  网络下拉选择</li>
           <li>shift-list-item.js  https://shapeshift.io/</li>
           <li>signature-request.js  签名请求</li>
           <li>tab-bar.js  标签条</li>
           <li>token-cell.js  token展示</li>
           <li>token-list.js  token列表</li>
           <li>wallet-view.js  钱包视图</li>
          </ul>
          </li>
          <li>
            <p>ui/  UI组件</p>
          <ul style="margin-top:.325em;list-style: disc;margin-left: 1.5em;">
            <li>alert/  警告框</li>
            <li>balance/  余额展示</li>
            <li>breadcrumbs/  面包屑导航</li>
            <li>button/  按钮</li>
            <li>button-group/  按钮组</li>
            <li>card/  卡片</li>
            <li>currency-display/  货币显示</li>
            <li>currency-input/  货币输入</li>
            <li>dialog/  对话框</li>
            <li>error-message/  错误信息</li>
            <li>export-text-container/  导出框</li>
            <li>hex-to-decimal/  16进制转为10进制</li>
            <li>identicon/  用户头像</li>
            <li>jazzicon/  https://github.com/danfinlay/jazzicon</li>
            <li>loading-screen/  载入框</li>
            <li>lock-icon/  锁定图标</li>
            <li>metafox-logo/  MetaMask Logo</li>
            <li>page-container/  页面容器</li>
            <li>sender-to-recipient/  发送到收件人</li>
            <li>spinner/  loading 旋转指示</li>
            <li>tabs/  tab页</li>
            <li>text-field/  多行文本框</li>
            <li>toggle-button/  切换按钮</li>
            <li>token-balance/  token 余额</li>
            <li>token-currency-display/  token 货币显示</li>
            <li>token-input/  token输入</li>
            <li>unit-input/  单位输入</li>
            <li>copyButton.js  拷贝按钮</li>
            <li>editable-label.js  可编辑标签</li>
            <li>eth-balance.js  ETH余额</li>
            <li>fiat-value.js  法定价值</li>
            <li>mascot.js  MetaMask 吉祥物</li>
            <li>qr-code.js  二维码</li>
            <li>readonly-input.js  只读输入框</li>
            <li>tooltip.js  toolTip</li>
            <li>tooltip-v2.js  toolTip v2 使用 https://github.com/tvkhoa/react-tippy</li>
          </ul>
          </li>
        </ul>
        </li>
        <li>css/  样式文件</li>
        <li>
          <p>ducks/  主要为了应用扩展，没有把 actions，reducer 之类的分开写，参考</p>
          <ul>
            <li>app/  app相关</li>
            <li>confirm-transaction/  交易确认相关</li>
            <li>gas/  gas相关</li>
            <li>locale/  语言相关</li>
            <li>metamask/  metamask相关</li>
            <li>send/  发送相关</li>
            <li>index.js  导出所有 ducks</li>
        </ul>
        </li>
        <li>
          <p>helpers/  辅助方法</p>
          <ul>
            <li>
              <p>constants/  常量</p>
            <ul>
                <li>common.js  网络类型、单位等</li>
              <li>error-keys.js  错误key</li>
              <li>infura-conversion.json  infura token</li>
              <li>routes.js  路由</li>
              <li>transactions.js  交易相关</li>
            </ul>
          </li>
            <li>
              <p>higher-order-components/  高阶组件</p>
            <ul>
                <li>authenticated/  认证</li>
            <li>initialized/  初始化</li>
            <li>metametrics/  MetaMetrics</li>
            <li>with-method-data/  添加 methodData（transactions.util）</li>
            <li>with-modal-props/  添加 modalProps</li>
            <li>with-token-tracker/  添加 token tracker</li>
            <li>i18n-provider.js/  添加多语言</li>
            </ul>
          </li>
            <li>
            <p>utils/</p>
            <ul>
                <li>common.util.js  camelCase转大写</li>
            <li>confirm-tx.util.js  一些常用的转换和格式化</li>
            <li>conversion-util.js  货币换算工具</li>
            <li>conversions.util.js  货币换算常用方法</li>
            <li>fetch-with-cache.js  从缓存取值</li>
            <li>formatters.js  格式化ethFee，加上 ETH 单位</li>
            <li>i18n-helper.js  多语言 helper，根据 key 获取消息文本</li>
            <li>metametrics.util.js  metametrics 工具</li>
            <li>switch-direction.js  在“ rtl”和“ ltr”之间切换CSS样式表</li>
            <li>token-util.js  token相关工具方法</li>
            <li>transactions.util.js  交易相关工具方法</li>
            <li>util.js 常用工具方法</li>
            </ul>
              
          </li>
        </ul>
        </li>
        <li>
          <p>pages/  所有页面组件</p>
        <ul>
            <li>add-token/  添加 token</li>
          <li>confirm-add-suggested-token/  确认增加推荐的token</li>
          <li>confirm-add-token/  确认增加token</li>
          <li>confirm-approve/  确认 token 交易，使用 confirm-token-transaction-base</li>
          <li>confirm-deploy-contract/  确认部署合约</li>
          <li>confirm-send-ether/  确认发送 eth</li>
          <li>confirm-send-token/  确认发送 token</li>
          <li>confirm-token-transaction-base/  确认 token 交易（base 组件）</li>
          <li>confirm-transaction/  确认交易</li>
          <li>confirm-transaction-base/  确认交易（base 组件）</li>
          <li>confirm-transaction-switch/  确认交易切换</li>
          <li>create-account/  创建账户</li>
          <li>first-time-flow/  第一次进入流程，欢迎，创建密码，记录助记词等</li>
          <li>home/  首页</li>
          <li>keychains/  恢复账户，显示seed</li>
          <li>lock/  锁定 MetaMask</li>
          <li>mobile-sync/  移动端同步</li>
          <li>provider-approval/  自定义 provider 核准</li>
          <li>routes/  路由</li>
          <li>send/  发送交易</li>
          <li>settings/  各种设置页面</li>
          <li>unlock-page/  解锁 MetaMask</li>
          <li>index.js  入口页</li>
          <li>index.scss  page 样式集合</li>
        </ul>
        </li>
        <li>
        <p>selectors/  所有的 selector，参考 reselect</p>
          <ul>
            <li>tests/  测试</li>
          <li>confirm-transaction.js  确认交易</li>
          <li>custom-gas.js  自定义gas</li>
          <li>selectors.js  其他 selector</li>
          <li>tokens.js  token</li>
          <li>transactions.js  交易</li>
        </ul>
        </li>
        <li>
        <p>store/  redux store & actions</p>
          <ul>
            <li>actions.js  redux actions</li>
          <li>store.js  redux createStore</li>
        </ul>
        </li>
      </ul>
        </li>
        <li>
          <p>lib/  </p>
      <ul style="margin-top:.325em;list-style: disc;margin-left: 1.5em;">
        <li>account-link.js  查看账户链接，etherscan链接</li>
        <li>blockies.js  计算颜色值</li>
        <li>etherscan-prefix-for-network.js  etherscan网络前缀，如 ropsten.</li>
        <li>feature-toggle-utils.js  检查功能切换</li>
        <li>icon-factory.js  生成icon</li>
        <li>is-mobile-view.js  判断是否是移动设备浏览</li>
        <li>local-storage-helpers.js  localStorage 封装</li>
        <li>persistent-form.js  持久化表单输入</li>
        <li>shallow-with-context.js  https://github.com/airbnb/enzyme 用于单元测试</li>
        <li>test-timeout.js  测试超时</li>
        <li>tx-helper.js  连接所有未确认的操作</li>
        <li>webcam-utils.js  检查摄像头状态</li>
      </ul>
        </li>
        <li>index.js  运行 MetaMask UI</li>
    </ul>
  </li>
  <li>.dockerignore  排除不需要上传到 docker 服务端的文件或目录</li>
  <li>.editorconfig  统一代码格式</li>
  <li>.eslintignore  ESLint 忽略特定的文件和目录</li>
  <li>.eslintrc  ESLint 配置文件</li>
  <li>.gitattributes  定义git文件的一些属性，比如不折叠差异 linguist-generated=false</li>
  <li>.gitignore  git忽略</li>
  <li>.nvmrc  约定 nvm run 启动的 node 版本</li>
  <li>.stylelintignore  Stylelint忽略</li>
  <li>.stylelintrc  Stylelint 规则</li>
  <li>babel.config.js  Babel 配置</li>
  <li>CHANGELOG.md  更新日志</li>
  <li>CONTRIBUTING.md  贡献说明</li>
  <li>gulpfile.js  gulp 配置文件</li>
  <li>ISSUE_TEMPLATE Issue 模板</li>
  <li>LICENSE  </li>
  <li>MISSION.md  使命</li>
  <li>package.json  详见 MetaMask 依赖分析</li>
  <li>README.md  </li>
  <li>USER_AGREEMENT.md  </li>
  <li>yarn.lock   </li>
</ul>
   ]]>
    </c:sourceContent>
    <c:comment>
      <c:comment1>
        <![CDATA[]]>
      </c:comment1>
    </c:comment>
  </c:entry>

</c:component>
